--Date :2021-01-18
--Author : generated by FairyGUI
--Desc :

local CooperationActivitieCheatingView, Super = class("CooperationActivitieCheatingView", Window)

function CooperationActivitieCheatingView:ctor()
    --LuaLog("CooperationActivitieCheatingView ctor")
    self._packName = "CooperationActivities"
    self._compName = "CooperationActivitieCheatingView"
    self._rootDepth = LayerDepth.PopWindow
    self.activeTag = GameDef.ActivityType.WorkTogetherAct
    self.calltimer = false
end

function CooperationActivitieCheatingView:_initEvent()
end

function CooperationActivitieCheatingView:_initVM()
    local viewNode = self.view
    ---Do not modify following code--------
    --{autoFields}:CooperationActivities.CooperationActivitieCheatingView
	self.blackBg = viewNode:getChildAutoType('blackBg')--GButton
	self.btn_help = viewNode:getChildAutoType('btn_help')--GButton
	self.btn_xieli = viewNode:getChildAutoType('btn_xieli')--GButton
	self.closeButton = viewNode:getChildAutoType('closeButton')--GButton
	self.com_1 = viewNode:getChildAutoType('com_1')--Component36
		self.com_1.txt_num = viewNode:getChildAutoType('com_1/txt_num')--GRichTextField
	self.com_2 = viewNode:getChildAutoType('com_2')--Component36
		self.com_2.txt_num = viewNode:getChildAutoType('com_2/txt_num')--GRichTextField
	self.com_3 = viewNode:getChildAutoType('com_3')--Component36
		self.com_3.txt_num = viewNode:getChildAutoType('com_3/txt_num')--GRichTextField
	self.com_4 = viewNode:getChildAutoType('com_4')--Component36
		self.com_4.txt_num = viewNode:getChildAutoType('com_4/txt_num')--GRichTextField
	self.com_5 = viewNode:getChildAutoType('com_5')--Component36
		self.com_5.txt_num = viewNode:getChildAutoType('com_5/txt_num')--GRichTextField
	self.com_6 = viewNode:getChildAutoType('com_6')--Component36
		self.com_6.txt_num = viewNode:getChildAutoType('com_6/txt_num')--GRichTextField
	self.com_7 = viewNode:getChildAutoType('com_7')--Component36
		self.com_7.txt_num = viewNode:getChildAutoType('com_7/txt_num')--GRichTextField
	self.com_bar1 = viewNode:getChildAutoType('com_bar1')--GProgressBar
	self.com_bar2 = viewNode:getChildAutoType('com_bar2')--GProgressBar
	self.com_bar3 = viewNode:getChildAutoType('com_bar3')--GProgressBar
	self.com_bar4 = viewNode:getChildAutoType('com_bar4')--GProgressBar
	self.com_bar5 = viewNode:getChildAutoType('com_bar5')--GProgressBar
	self.com_bar6 = viewNode:getChildAutoType('com_bar6')--GProgressBar
	self.com_bar7 = viewNode:getChildAutoType('com_bar7')--GProgressBar
	self.img_bg = viewNode:getChildAutoType('img_bg')--GLoader
	self.img_bigBg = viewNode:getChildAutoType('img_bigBg')--GLabel
	self.list_reward = viewNode:getChildAutoType('list_reward')--GList
	self.txt_countdowm = viewNode:getChildAutoType('txt_countdowm')--GTextField
	self.txt_desc = viewNode:getChildAutoType('txt_desc')--GRichTextField
 --{autoFieldsEnd}:CooperationActivities.CooperationActivitieCheatingView
    --Do not modify above code-------------
end


function CooperationActivitieCheatingView:_initListener()
    self.btn_xieli:addClickListener(
        function()
            local info = CooperationActivitiesModel:getCooperationSupportInfo(self.activeTag) --得到支援助力数据
            if info and info.isHelped == false then
                CooperationActivitiesModel:WorkTogetherHelp(self.activeTag)
            else
                RollTips.show("今日已助力")
            end
        end
    )

    self.btn_help:addClickListener(
        function()
            local info = {}
            info["title"] = Desc.help_StrTitle280
            info["desc"] = Desc.help_StrDesc280
            ViewManager.open("GetPublicHelpView", info)
        end
    )
end

function CooperationActivitieCheatingView:_initUI()
    self:_initVM()
    self:_initListener()
    local img_bigBgURL=PathConfiger.getBg("CooperationActivitieMain.jpg")
    self.img_bigBg:getChildAutoType("icon"):setURL(img_bigBgURL)
    local img_bgURL=PathConfiger.getBg("CooperationActivitieCheatingBg.png") 
    self.img_bg:setURL(img_bgURL)
    self:showCountTime()
    self:showRewardList()
    self:showBar()
    self:showDesc()
end

function CooperationActivitieCheatingView:showDesc()
    local info = CooperationActivitiesModel:getCooperationSupportInfo(self.activeTag) --得到支援助力数据
    local groupId =CooperationActivitiesModel:getActModuleId(GameDef.ActivityType.WorkTogetherAct) 
    local configInfo = DynamicConfigData.t_CooperationHope[groupId]
    local desc = ""
    local num = 0
    for i = 1, #configInfo, 1 do
        local helpNum = info.helpNum
        local rewardItem = configInfo[i]
        local next = configInfo[i + 1]
        if not next then
            next = configInfo[i]
        end
        local curNum=rewardItem.num
        local nextNum=next.num
        if helpNum <= configInfo[1].num then
            desc = configInfo[1].buffDec
            num = configInfo[1].num
        elseif helpNum > curNum and helpNum <= nextNum then
            desc = next.buffDec
            num = nextNum
        elseif helpNum >= configInfo[#configInfo].num then
            desc = configInfo[#configInfo].buffDec
            num = configInfo[#configInfo].num
        end
    end
    local str = desc .. string.format("(%s/%s)", info.helpNum, num)
    self.txt_desc:setText(str)
end

function CooperationActivitieCheatingView:showBar()
    local info = CooperationActivitiesModel:getCooperationSupportInfo(self.activeTag) --得到支援助力数据
    local groupId =CooperationActivitiesModel:getActModuleId(GameDef.ActivityType.WorkTogetherAct)
    local configInfo = DynamicConfigData.t_CooperationHope[groupId]
    for i = 1, #configInfo, 1 do
        local rewardItem = configInfo[i]
        local limitNum = rewardItem.num
        local helpNum = info.helpNum
        local lingquBit = info.helpRewardMark or 0
        local item = self.view:getChildAutoType("com_" .. i)
        local txt_num = item:getChildAutoType("txt_num")
        txt_num:setText(limitNum)
        local index = OperatingActivitiesModel:GetBitByIndex(lingquBit, rewardItem.id)
        local c1 = item:getController("c1")
        if helpNum < limitNum then --未达成
            c1:setSelectedIndex(0)
        elseif helpNum >= limitNum and index == 0 then --可领取
            c1:setSelectedIndex(1)
        elseif helpNum >= limitNum and index ~= 0 then --领取完
            c1:setSelectedIndex(2)
        end
        local bar = self.view:getChildAutoType("com_bar" .. i)
        if helpNum >= limitNum then
            bar:setMax(100)
            bar:setValue(100)
        else
            local old=0
            if configInfo[i-1] then
                old=configInfo[i-1].num
            end
            bar:setValue(helpNum-old)
            bar:setMax(limitNum-old)
        end
    end
end

function CooperationActivitieCheatingView:showRewardList()
    local info = CooperationActivitiesModel:getCooperationSupportInfo(self.activeTag) --得到支援助力数据
    local groupId =CooperationActivitiesModel:getActModuleId(GameDef.ActivityType.WorkTogetherAct)
    local configInfo = DynamicConfigData.t_CooperationHope[groupId]
    self.list_reward:setItemRenderer(
        function(index, obj)
            local rewardItem = configInfo[index + 1]
            local limitNum = rewardItem.num
            local helpNum = info.helpNum
            local lingquBit = info.helpRewardMark or 0
            local index = OperatingActivitiesModel:GetBitByIndex(lingquBit, rewardItem.id)
            local c1 = obj:getController("c1")
            if helpNum < limitNum then --未达成
                c1:setSelectedIndex(0)
            elseif helpNum >= limitNum and  index == 0 then --可领取
                c1:setSelectedIndex(1)
            elseif helpNum >= limitNum and index ~= 0 then --领取完
                c1:setSelectedIndex(2)
            end
            local listgoods = obj:getChildAutoType("list_goods")
            listgoods:setItemRenderer(
                function(rewardId, rewardobj)
                    local reward = rewardItem.reward[rewardId + 1]
                    local itemcell = BindManager.bindItemCell(rewardobj)
                    itemcell:setData(reward.code, reward.amount, reward.type)
                end
            )
            listgoods:setNumItems(#rewardItem.reward)
            local btn_lingqu=obj:getChildAutoType("btn_lingqu")
            btn_lingqu:removeClickListener(100)
            btn_lingqu:addClickListener(
                function()
                    CooperationActivitiesModel:WorkTogetherGetHelpReward(self.activeTag, rewardItem.id)
                end,
                100
            )
            

        end
    )
    self.list_reward:setNumItems(#configInfo)
end

function CooperationActivitieCheatingView:showCountTime()
    local actData = ModelManager.ActivityModel:getActityByType(self.activeTag)
    if not actData then
        return
    end
    local actId = actData.id
    local status, addtime = ModelManager.ActivityModel:getActStatusAndLastTime(actId)
    if not addtime then
        return
    end
    if status == 2 and addtime == -1 then
        self.txt_countdowm:setText(Desc.activity_txt5)
    else
        local lastTime = addtime / 1000
        if lastTime == -1 then
            self.txt_countdowm:setText(Desc.activity_txt5)
        else
            if lastTime > 0 then
                self.txt_countdowm:setText(TimeLib.GetTimeFormatDay(lastTime, 2))
                local function onCountDown(time)
                    self.txt_countdowm:setText(TimeLib.GetTimeFormatDay(time, 2))
                end
                local function onEnd(...)
                    self.txt_countdowm:setText(Desc.activity_txt13)
                end
                if self.calltimer then
                    TimeLib.clearCountDown(self.calltimer)
                end
                self.calltimer = TimeLib.newCountDown(lastTime, onCountDown, onEnd, false, false, false)
            else
                self.txt_countdowm:setText(Desc.activity_txt13)
            end
        end
    end
end

function CooperationActivitieCheatingView:CooperationActivitie_Helprefresh()
    self:showRewardList()
    self:showBar()
    self:showDesc()
end

function CooperationActivitieCheatingView:CooperationActivitie_TogetherGetHelpReward()
    self:showRewardList()
    self:showBar()
    self:showDesc()
end

function CooperationActivitieCheatingView:_exit()
    if self.calltimer then
        TimeLib.clearCountDown(self.calltimer)
    end
end

return CooperationActivitieCheatingView
