--Name : ExpeditionTearsView.lua
--Author : generated by FairyGUI
--Date : 2020-4-11
--Desc : 女神之泪  xhd

local ExpeditionTearsView,Super = class("ExpeditionTearsView", Window)
local ItemConfiger = require "Game.ConfigReaders.ItemConfiger" --道具配置读取器
function ExpeditionTearsView:ctor()
	--LuaLog("ExpeditionTearsView ctor")
	self._packName = "Expedition"
	self._compName = "ExpeditionTearsView"
	self._rootDepth = LayerDepth.PopWindow
	self.data = {}
	
end

function ExpeditionTearsView:_initEvent( )
	local params = {}
	params.onSuccess = function (res )
		printTable(31,"111111111111111",res)
		self.data={}
		local hinfo = DynamicConfigData.t_hero
		for k,v in pairs(res.heroList) do
			v.hpBaifenbi=v.hp/v.maxHp
			if v.hpBaifenbi > 1 then
				v.hpBaifenbi = 1
			end
			v.category = hinfo[v.code].category
			v.heroId = CardLibModel:getHeroByUid(v.uuid).heroId
			local heroInfo = CardLibModel:getHeroByUid(v.uuid)
			v.fashion = heroInfo and heroInfo.fashion and heroInfo.fashion.code
			table.insert(self.data,v)
		end
		-- TableUtil.sortByMap(self.data, {{key = "hpBaifenbi",asc=false},{key="combat",asc=true},{key="level",asc=true}})
		TableUtil.sortByMap(self.data, {{key="hpBaifenbi",asc=false},{key="level",asc=true},{key="star",asc=true},{key="combat",asc=true},{key="heroId",asc=true}})
		--BattleModel:starSort(self.data)
		if tolua.isnull(self.view) then return end
	    self.list:setData(self.data)
	end
	local info = {
		arrayType = GameDef.BattleArrayType.EndlessRoad,
		index = 0
	}
	RPCReq.Battle_GetHeroArrayList(info, params.onSuccess)
end

function ExpeditionTearsView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:Maze.ExpeditionTearsView
		vmRoot.list = viewNode:getChildAutoType("$list")--list
		vmRoot.title = viewNode:getChildAutoType("$title")--text
		vmRoot.itemIcon = viewNode:getChildAutoType("$itemIcon")--loader
		vmRoot.cancelBtn = viewNode:getChildAutoType("$cancelBtn")--Button
		vmRoot.okBtn = viewNode:getChildAutoType("$okBtn")--Button
		-- vmRoot.helpBtn = viewNode:getChildAutoType("$helpBtn")--Button
		vmRoot.ItemNum = viewNode:getChildAutoType("$ItemNum")--text
	--{vmFieldsEnd}:Maze.ExpeditionTearsView
	--Do not modify above code-------------
end

function ExpeditionTearsView:_initUI( )
	self:_initVM()
    self.cancelBtn:addClickListener(function ( ... )
    	ViewManager.close("ExpeditionTearsView")
    end)
    self.okBtn:addClickListener(function ( ... )
    	if ModelManager.PlayerModel:isCostEnough({{type = GameDef.GameResType.Item, code = 10000021, amount=1}}, true) then
    		local params = {}
			params.onSuccess = function (res )
			        -- local params = {}
					-- params.onSuccess = function (res )
					-- 	printTable(31,"11111111111111")
					-- 	self.data={}
					-- 	local hinfo = DynamicConfigData.t_hero
					-- 	for k,v in pairs(res.heroList) do
					-- 		v.category = hinfo[v.code].category
					-- 		table.insert(self.data,v)
					-- 	end
					-- 	BattleModel:starSort(self.data)
					-- 	if tolua.isnull(self.view) then return end
					--     self.list:setData(self.data)
					--     local num= ModelManager.PackModel:getItemsFromAllPackByCode( "10000021",false )
	                --     self.ItemNum:setText(num)
					-- end
					-- local info = {
					-- 	arrayType = GameDef.BattleArrayType.EndlessRoad,
					-- 	index = 0
					-- }
					-- RPCReq.Battle_GetHeroArrayList(info, params.onSuccess)
				RollTips.show(DescAuto[106]) -- [106]="已恢复所有受伤探员"
				ViewManager.close("ExpeditionTearsView")
			end
			RPCReq.EndlessRoad_Reborn(params, params.onSuccess)
    	end
    end)
    -- self.helpBtn:addClickListener(function ( ... )
    	
    -- end)

    self.list:setItemRenderer(function( index,obj )
    	local tempData =self.data[index+1]
    	tempData.category = DynamicConfigData.t_hero[tempData.code].category
    	-- printTable(1,tempData)
    	local heroCell = BindManager.bindHeroCell(obj)
        heroCell:setData(tempData)
	end)
	self.list:setVirtual();
    local num= ModelManager.PackModel:getItemsFromAllPackByCode( "10000021",false )
    self.ItemNum:setText(num)
     local url = ItemConfiger.getItemIconByCode("10000021")
    self.itemIcon:setURL(url)
end

return ExpeditionTearsView
