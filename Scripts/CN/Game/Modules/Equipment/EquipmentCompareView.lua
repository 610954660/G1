--Name : EquipmentCompareView.lua
--Author : generated by FairyGUI
--Date : 2020-4-2
--Desc : 

local EquipmentCompareView,Super = class("EquipmentCompareView", Window)
local  HeroConfiger = require "Game.ConfigReaders.HeroConfiger"

function EquipmentCompareView:ctor()
	--LuaLog("EquipmentCompareView ctor")
	self._packName = "Equipment"
	self._compName = "EquipmentCompareView"
	self._rootDepth = LayerDepth.PopWindow
	
end

function EquipmentCompareView:_initEvent( )
	
end

function EquipmentCompareView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:Equipment.EquipmentCompareView
		local eqinfoBox1 = viewNode:getChildAutoType("$eqinfoBox1")--
		vmRoot.eqinfoBox1 = eqinfoBox1
			eqinfoBox1.jineng = viewNode:getChildAutoType("$eqinfoBox1/$jineng")--list
			eqinfoBox1.title = viewNode:getChildAutoType("$eqinfoBox1/$title")--text
			eqinfoBox1.shuxing = viewNode:getChildAutoType("$eqinfoBox1/$shuxing")--list
			eqinfoBox1.taozhuang = viewNode:getChildAutoType("$eqinfoBox1/$taozhuang")--list
			eqinfoBox1.itemCell = viewNode:getChildAutoType("$eqinfoBox1/$itemCell")--Button
			eqinfoBox1.star = viewNode:getChildAutoType("$eqinfoBox1/$star")--list
		vmRoot.btn2 = viewNode:getChildAutoType("$btn2")--Button
		vmRoot.btn3 = viewNode:getChildAutoType("$btn3")--Button
		vmRoot.btn1 = viewNode:getChildAutoType("$btn1")--Button
	--{vmFieldsEnd}:Equipment.EquipmentCompareView
	--Do not modify above code-------------
end

function EquipmentCompareView:_initUI( )
	self:_initVM()
	self.topBg = self.eqinfoBox1:getChildAutoType("topBg") -- 顶部背景
	self.btn_rebuild = self.view:getChildAutoType("btn_rebuild") -- 重铸
	self.btn_upStage = self.view:getChildAutoType("btn_upStage") -- 升阶
	
	self.baseCtl = self.view:getController("base");
	if self._args.eqtype then
		self.baseCtl:setSelectedIndex(self._args.eqtype)
	end
	self.view:getChildAutoType("tcloseButton"):addClickListener(function()
			self:closeView()
			end)

	self:initViewData()
	
	self:initViewPos()
	
	
	local btn_recast = self.eqinfoBox1.jineng:getChildAutoType("btn_recast")
	btn_recast:addClickListener(function(context)
			if self._args.eqtype == 1 then
				EquipmentModel.curPos = self._args.pos
			end
			local uuid = self._args.eqdata.uuid or self._args.eqdata.v.__data.uuid 
			-- ViewManager.open("EquipmentforgeView", {page = 2})
			ModuleUtil.openModule(ModuleId.Forge.id, true)
			Scheduler.scheduleNextFrame(function ()
				Dispatcher.dispatchEvent("Equipment_rebuildSelect", uuid)
			end)
			self:closeView()
		end,33)
		
	local btn_upStar = self.eqinfoBox1.jineng:getChildAutoType("btn_upStar")
	btn_upStar:addClickListener(function(context)
			if self._args.eqtype == 1 then
				EquipmentModel.curPos = self._args.pos
			end
			EquipmentModel.curEqUUID =  self._args.eqdata.uuid or self._args.eqdata.v.__data.uuid 
			ViewManager.open("EquipmentUpstarView",{uuid = EquipmentModel.curEqUUID})
			self:closeView()
		end,33)

	local btn_upStage = self.view:getChildAutoType("btn_upStage")
	btn_upStage:addClickListener(function()
		ViewManager.open("EquipmentUpStageView",{uuid = EquipmentModel.curEqUUID})
	end)
end

function EquipmentCompareView:initViewPos( )
	if self._args.node then
		local pos = self._args.node:localToGlobal(Vector2.zero)
		local tsize = self.view:getChildAutoType("size")
		local taget = self.view:getChildAutoType("taget")
		if pos.y +tsize:getHeight() > self.view:getHeight() then
			pos.y = self.view:getHeight() - tsize:getHeight()
		end
		if pos.x +tsize:getWidth() > self.view:getWidth() then
			pos.x = self.view:getWidth() - tsize:getWidth()
		end
		taget:setPosition(display.width/2-200 ,40)
	end
	--local taget = self.view:getChildAutoType("taget")
	--taget:setPosition(300,150)
end

function EquipmentCompareView:initViewData( )
	--if not self._args.eqdata then LuaLogE("eqdata = nil") return end
	--self.btn1:setOpaque(true)
	--self.view:addClickListener(function ()
			--print(33,"EquipmentCompareView changed = 1");
			----ViewManager.open("self.view EquipmentCompareView",{node = self.OneKeyOffBtn})
		--end,88)
	
	self.btn1:removeClickListener(88)
	self.btn1:addClickListener(function()
			--Dispatcher.dispatchEvent(EventType.equipment_openForge)
			if self._args.eqtype == 1 then
				EquipmentModel.curPos = self._args.pos
				--Dispatcher.dispatchEvent(EventType.equipment_changeCtl,1)
				ViewManager.open("EquiMentListView",self._args)
			else
				local info = self._args.eqdata.v
				local eqinfo = EquipmentModel:getConfingByPackItem(info)
				local oldAttr = ModelManager.CardLibModel:getHeroByUid(EquipmentModel.hid).attrs
				local oldCombat = ModelManager.CardLibModel:getHeroByUid(EquipmentModel.hid).combat
				RPCReq.Equipment_Wear({type = 0,pos = eqinfo.position,heroUuid = EquipmentModel.hid,itemUuid =info.__data.uuid},
					function(args)
						printTable(33,"Equipment_Wear call back",args)
						
						local downEquip = (args.oldList and #args.oldList > 0) and args.oldList[1] or nil;
						if (downEquip) then
							EquipmentModel:setSkillData(downEquip.uuid, downEquip)
							EquipmentModel:upBagEquip(downEquip)
						end
						EquipmentModel:updateWearEqList(args.pos,args.list[1])
						
						GlobalUtil.delayCallOnce("EquipmentCompareView:updateWearEqList",function()
							local heroData = ModelManager.CardLibModel:getHeroByUid(EquipmentModel.hid)
							local newAttr = heroData.attrs
							RollTips.showAttrTips(oldAttr, newAttr)
							local newCombat = heroData.combat
							local addNum = newCombat - oldCombat
							if addNum > 0 then
								RollTips.showAddFightPoint(addNum)
							end
						end, 0.2)
					end)
			end
			
			self:closeView()
			print(33,"control EquipmentCompareView = btn1");
		end,88)
	
	self.btn2:removeClickListener(88)
	self.btn2:addClickListener(function()
			if self._args.eqtype == 1 then
				EquipmentModel.curPos = self._args.pos
			end
			EquipmentModel.curEqUUID =  self._args.eqdata.uuid or self._args.eqdata.v.__data.uuid 
			--Dispatcher.dispatchEvent(EventType.equipment_openForge,{eqdata = EquipmentModel.curEqUUID})
			ViewManager.open("EquipmentUpstarView",{uuid = EquipmentModel.curEqUUID})
			self:closeView()
			print(33,"control EquipmentCompareView = btn1");
		end,88)
	self.btn3:removeClickListener(88)
	self.btn3:addClickListener(function (context)

			RPCReq.Equipment_TakeOff({type = 0,pos = self._args.pos,heroUuid = EquipmentModel.hid},function(args)
					printTable(33,"Equipment_TakeOff call back",args)
					if args.isSuccess then
						local downEquip = args.list[1]
						EquipmentModel:upBagEquip(downEquip)
						EquipmentModel:setSkillData(downEquip.uuid, downEquip)
						EquipmentModel:updateWearEqList(args.pos)
					end
				end)
			self:closeView()
		end,88)

	self.btn_rebuild:removeClickListener()
	self.btn_rebuild:addClickListener(function ()
		if self._args.eqtype == 1 then
			EquipmentModel.curPos = self._args.pos
		end
		local uuid = self._args.eqdata.uuid or self._args.eqdata.v.__data.uuid 
		-- ViewManager.open("EquipmentforgeView", {page = 2})
		ModuleUtil.openModule(ModuleId.Forge.id, true)
		Scheduler.scheduleNextFrame(function ()
			Dispatcher.dispatchEvent("Equipment_rebuildSelect", uuid)
		end)
		self:closeView()
	end)
	
	--if self._args.weardata then
		--self.baseCtl:setSelectedIndex(2)
		--self:initBoxData(self.eqinfoBox1,self._args.weardata)
		--self:initBoxData(self.eqinfoBox2,self._args.eqdata,self._args.weardata)
	--elseif self._args.eqdata then
		self:initBoxData(self.eqinfoBox1,self._args.eqdata)
	--end
	
	
	self.btn1:getChild("img_red"):setVisible(self:hasBetterEquip())
end

function EquipmentCompareView:hasBetterEquip()
	local hasBatter = false
	local wearScore = 0
	local data = EquipmentModel:getWearEqListByHero()
	for k,v in pairs(data) do
		local eqInfo = EquipmentModel:getConfingByCode(v.code)
		if eqInfo.position == self._args.pos  then
			wearScore = EquipmentModel:calcCombat(v)
			break
		end
	end
	
	local data = EquipmentModel:getEquipBag().__packItems
	for k,v in pairs(data) do
		local eqInfo = EquipmentModel:getConfingByPackItem(v)
		if eqInfo.position == self._args.pos and (eqInfo.attType == 0 or eqInfo.attType == EquipmentModel.attType ) then

			local totalPower = EquipmentModel:calcCombat(v.__data)--HeroConfiger.CaleAttrPower(eqInfo)
			if totalPower > wearScore then
				hasBatter = true
				break;
			end
		end
	end
	return hasBatter
end

function EquipmentCompareView:initBoxData( box,data ,wdata)
	local info = {}
	local uuid = 0
	if data.code then
		info = EquipmentModel:getConfingByCode(data.code)
		uuid = data.uuid
	else
		info = EquipmentModel:getConfingByPackItem(data.v)
		uuid = data.v.__data.uuid
	end
	local info2 = false
	self.topBg:setIcon(PathConfiger.getItemTipsHeadBg(info.color))
	if wdata then
		if wdata.code then
			info2 = EquipmentModel:getConfingByCode(wdata.code)
		else
			info2 = EquipmentModel:getConfingByPackItem(wdata.v)
		end
	end
	if not box.sitemcell then
		box.sitemcell = BindManager.bindItemCell(box:getChildAutoType("$itemCell"))
		box.sitemcell.view:removeClickListener()
	end
	box.sitemcell:setData(data.code,0,CodeType.ITEM)
	box.sitemcell:setStars()
	--box.frame:setURL(PathConfiger.getItemFrame(info.color, false))
	--box.icon:setURL(EquipmentModel:getEqIconByeCode(info.id))
	box.title:setText(info.name)
	local s_color = {
		{r=0xff,g=0xff,b=0xff},
		{r=0x97,g=0xe6,b=0xad},
		{r=0x8a,g=0xd4,b=0xff},
		{r=0xed,g=0x93,b=0xf0},
		{r=0xff,g=0xbd,b=0x7a},
		{r=0xfe,g=0x94,b=0x94}}
	
	box.title:setColor(s_color[info.color])
	--box.title:displayObject():enableShadow({r=0xff,g=0xff,b=0xff,a=0x40})
	--box.star:setNumItems(info.staramount)
	
	local sx = {}
	if info.hp>0 then
		sx[#sx+1] = {name = Desc.equipment_sx1, key="hp", value = info.hp}
	end
	if info.attack>0 then
		sx[#sx+1] = {name = Desc.equipment_sx2, key="attack", value = info.attack}
	end
	if info.defense>0 then
		sx[#sx+1] = {name = Desc.equipment_sx3, key="defense", value = info.defense}
	end
	if info.magic>0 then
		sx[#sx+1] = {name = Desc.equipment_sx4, key="magic", value = info.magic}
	end
	if info.magicDefense>0 then
		sx[#sx+1] = {name = Desc.equipment_sx5, key="magicDefense", value = info.magicDefense}
	end
	if info.speed>0 then
		sx[#sx+1] = {name = Desc.equipment_sx6, key="speed", value = info.speed}
	end	
	
	
	box.shuxing:setItemRenderer(function(index,obj)
			obj:getController("c1"):setSelectedIndex(1)
			local sxInfo = sx[index+1]
			local name = obj:getChildAutoType("name")
			name:setText(sxInfo.name)
			local value = obj:getChildAutoType("value")
			--value:setText(sxInfo.value)
			
			local up = obj:getChildAutoType("up")
			local down = obj:getChildAutoType("down")
			local suitName = obj:getChildAutoType("suitName")
			up:setVisible(false)
			down:setVisible(false)
			value:setVisible(false)
			suitName:setVisible(true)
			suitName:setText(sxInfo.value)
			suitName:setColor({r=0x97,g=0xe6,b=0xad})
			if info2 then
				if sxInfo.value > info2[sxInfo.key] then
					up:setVisible(true)
				elseif sxInfo.value < info2[sxInfo.key] then
					down:setVisible(true)
				end
			end
		end)
	box.shuxing:setNumItems(#sx)
	
	local skilldata = EquipmentModel:getSkillData(uuid)
	if skilldata  then
		local skillList = box.jineng:getChildAutoType("skillList")
		if skilldata.skill and #skilldata.skill>0 then
			printTable(33,"skilldata = ",skilldata.skill)
			box.jineng:getController("c1"):setSelectedIndex(0)
			skillList:setItemRenderer(function(index,obj)
					
					local skillInfo = EquipmentModel:getSkillConfigByCode(skilldata.skill[index+1])
					local configSkill = DynamicConfigData.t_skill
					local skillId = tonumber(skilldata.skill[index+1])
					local sdata = configSkill[skillId]
					local skillCell = BindManager.bindSkillCell(obj)
					skillCell:setEquipmentData(skillId,info.position)
					skillCell:showSkillName(0,skillInfo.skillName)
					obj:getChildAutoType("itemName"):setColor({r=0xff,g=0xff,b=0xff})
					obj:getChildAutoType("n29"):setVisible(false)
				end)
			skillList:setNumItems(#skilldata.skill)
		else
			skillList:setNumItems(0)
			if info.color >= 5 then
				box.jineng:getController("c1"):setSelectedIndex(1)
			else
				box.jineng:getController("c1"):setSelectedIndex(2)
			end
		end
	end
	
	local totalPower = 0
	totalPower = HeroConfiger.CaleAttrPower(info)
	local skilldata = EquipmentModel:getSkillData(self._args.eqdata.uuid)
	if skilldata  then
		totalPower = totalPower + HeroConfiger.CaleSkillPower(skilldata.skill)
	end

	box:getChildAutoType("power"):setText(totalPower)
	
	
	print(33,"t_equipsuit",info.color,info.staramount) 
	
	local taozhuang = DynamicConfigData.t_equipsuit[info.color]
	if taozhuang then
		taozhuang = taozhuang[info.staramount]
		if not taozhuang then
			taozhuang = {}
		end
	else
		taozhuang = {}
	end
	
	local suitData = EquipmentModel.newSuitData[EquipmentModel.hid]
	--local suitInfo = EquipmentModel.suitData[EquipmentModel.hid]
	--if suitInfo then suitInfo = suitInfo[info.position] end
	if #taozhuang > 0 then
		box:getController("c1"):setSelectedIndex(1)
		box:setHeight(638)
		box:getChildAutoType("taozhuang"):setTitle(taozhuang[1].name)
		box.taozhuang:setItemRenderer(function(index,obj)
				obj:getController("c1"):setSelectedIndex(1)
				local tzInfo = taozhuang[index+1]
				local name = obj:getChildAutoType("name")
				local suitName = obj:getChildAutoType("suitName")
				suitName:setVisible(true)
				local value = obj:getChildAutoType("suitValue")
				value:setVisible(true)
				if suitData[tzInfo.count] then
					local colorStr = Desc["common_toolColor"..suitData[tzInfo.count].color]
					suitName:setText(Desc.equipment_taozhuang:format(colorStr,suitData[tzInfo.count].star,tzInfo.count))
					local info1 = DynamicConfigData.t_equipsuit[suitData[tzInfo.count].color][suitData[tzInfo.count].star]
					for _,v in ipairs(info1) do
						if v.count == tzInfo.count then
							name:setText(v.attrName)
							value:setText(v.show)
						end
					end
					
				else
					local colorStr = Desc["common_toolColor"..info.color]
					suitName:setText(Desc.equipment_taozhuang:format(colorStr,info.staramount,tzInfo.count))
					name:setText(tzInfo.attrName)
					value:setText(tzInfo.show)
				end
				
				
				
				obj:getChildAutoType("value"):setVisible(false)
				obj:getChildAutoType("up"):setVisible(false)
				obj:getChildAutoType("down"):setVisible(false)
				local isActive = suitData[tzInfo.count] 
				if isActive then
					suitName:setColor({r=0x97,g=0xe6,b=0xad})
					value:setColor({r=0x97,g=0xe6,b=0xad})
					name:setColor({r=0x97,g=0xe6,b=0xad})
				end
				
	
			end)
		box.taozhuang:setNumItems(#taozhuang)
	else
		box:getController("c1"):setSelectedIndex(0)
		box:setHeight(513)
	end
	
end



return EquipmentCompareView