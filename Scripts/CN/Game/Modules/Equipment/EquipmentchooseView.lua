--Name : EquipmentchooseView.lua
--Author : generated by FairyGUI
--Date : 2020-4-1
--Desc : 

local EquipmentchooseView,Super = class("EquipmentchooseView", View)


function EquipmentchooseView:ctor()
	LuaLog("EquipmentchooseView ctor")
	self._packName = "Equipment"
	self._compName = "EquipmentchooseView"
	--self._rootDepth = LayerDepth.Window
	self.curPos = 1
end

function EquipmentchooseView:_initEvent( )
	--self:addEventListener(EventType.equipment_refresheq,self)
end

function EquipmentchooseView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:Equipment.EquipmentchooseView
		local list = viewNode:getChildAutoType("$list")--
		vmRoot.list = list
			list.btn_score = viewNode:getChildAutoType("$list/$btn_score")--Button
			list.secondTab = viewNode:getChildAutoType("$list/$secondTab")--list
			list.eqlist = viewNode:getChildAutoType("$list/$eqlist")--list
	--{vmFieldsEnd}:Equipment.EquipmentchooseView
	--Do not modify above code-------------
end

function EquipmentchooseView:_initUI( )
	self:_initVM()
	
	self.curPos = EquipmentModel.curPos
	
	self.list.eqlist:setItemRenderer(function(index,obj)
			self:itemShow(obj,index)
		end)
	
	self.list.secondTab:setSelectedIndex(self.curPos-1)
	self.list.secondTab:addEventListener(FUIEventType.ClickItem,function( context )
			local cindex= self.list.secondTab:getChildIndex(context:getData())
			local index = self.list.secondTab:childIndexToItemIndex(cindex)+1;
			self.curPos = index
			EquipmentModel.curPos = index
			self:showEqByPos( )
		end);
	
	self.view:getChildAutoType("n4"):addClickListener(function(context)
			context:stopPropagation()
			Dispatcher.dispatchEvent(EventType.equipment_changeCtl,0)
	end)
	self:showEqByPos( )
end


function EquipmentchooseView:showEqByPos( )
	local data = EquipmentModel:getEquipBag().__packItems
	self.data = {}
	for k,v in pairs(data) do
		local eqInfo = EquipmentModel:getConfingByPackItem(v)
		if eqInfo.position == self.curPos then
			local info = {}
			info.k = k
			info.v = v
			table.insert(self.data,info)
		end
	end
	print(33,"showEqByPos data = ",#self.data)
	self.list.eqlist:setNumItems(#self.data)
end


function EquipmentchooseView:itemShow( obj,index )
	
	local eqdata = self.data[index+1];
	local eqInfo = EquipmentModel:getConfingByPackItem(eqdata.v)
	 

	obj:getChildAutoType("mask"):setVisible(false)
	obj:getChildAutoType("checkMark"):setVisible(false)
	obj:getChildAutoType("frame"):setURL(PathConfiger.getItemFrame(eqInfo.color, "normal"))
	obj:setIcon(EquipmentModel:getEqIconByeCode(eqInfo.id))
	--obj:setTitle(eqInfo.id.."\n"..eqdata.v.__data.uuid)
	obj:getChildAutoType("starList/$list"):setNumItems(eqInfo.staramount)
	
	--print(33,"itemShow","Icon/rarity/k_"..eqInfo.position..".png")

	obj:addClickListener(function()
			
			
			local wearData = EquipmentModel:getEqByPos(eqInfo.position)
			printTable(33,"item Click",wearData)
			local getinfo = {}
			table.insert(getinfo,eqdata.v.__data.uuid)
			if wearData then
				table.insert(getinfo,wearData.uuid)
			end
			local sendInfo = {heroUuid = "0",itemUuidAttry = getinfo}
			--printTable(33,"Equipment_GetEquipInfo send ",sendInfo)
			EquipmentModel:reqSkillData(EquipmentModel.hid,getinfo,function(eqlist)

					local eqtype_t = 0
					if wearData then
						--eqtype_t = 2
					end
					local info = {
						eqtype = eqtype_t,
						node = obj,
						eqdata = eqdata,
						weardata = wearData
					}

					ViewManager.open("EquipmentCompareView",info)
				end)
			
		end,88)
	
	
end
function EquipmentchooseView:equipment_refresheq( )
	self:_refresh()
end

function EquipmentchooseView:_refresh( )

	--if tolua.isnull(self.list) then
		--if self.curPos ~= EquipmentModel.curPos then
			self.curPos = EquipmentModel.curPos
			self.list.secondTab:setSelectedIndex(self.curPos-1)
		--end
		self:showEqByPos( )
	--end
	
end

return EquipmentchooseView