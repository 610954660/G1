--Date :2021-01-22
--Author : generated by FairyGUI
--Desc : 

local NewYearActivityRedPackView,Super = class("NewYearActivityRedPackView", Window)

function NewYearActivityRedPackView:ctor()
	--LuaLog("NewYearActivityRedPackView ctor")
	self._packName = "NewYearActivity"
	self._compName = "NewYearActivityRedPackView"
	--self._rootDepth = LayerDepth.Window
	self.timerKey1 = false
	self.timerKey2 = false
	self.timerKey3 = false
	self.timerKey4 = false
	self.timerKey5 = false
	self.timerKey6 = false
	self.timerKey7 = false
	self.timerKey8 = false
	self.recordData = {}
end

function NewYearActivityRedPackView:_initEvent( )
	for i = 1, 8 do
		local redPack = self["redPack"..i]
		local timerKey = self["timerKey"..i]
		redPack:addClickListener(function ()
			if NewYearActivityModel.drawTimes > 0 then 
				local openCtr = redPack:getController("openCtr")
				local state = openCtr:getSelectedIndex()
				if state == 0 then 
					openCtr:setSelectedIndex(1)
					local params = {}
					params.activityId = GameDef.ActivityType.NewYear
					params.onSuccess = function (data)
						printTable(6,"开红包",data)
						NewYearActivityModel.drawTimes = data.times
						ModelManager.NewYearActivityModel:checkRedPackRed()
						self.txt_openNum:setText(string.format(Desc.NewYearActivity_str14,NewYearActivityModel.drawTimes))
						local itemCell = BindManager.bindItemCell(redPack.itemCell)
						local giftInfo = DynamicConfigData.t_NewYearGift[data.id]
						local rewards = giftInfo.rewards[1]
						itemCell:setData(rewards.code,rewards.amount,rewards.type)
						--重刷记录
						local params = {}
						params.activityId = GameDef.ActivityType.NewYear
						params.onSuccess = function (data)
							printTable(6,"红包记录数据",data)
							self.recordData = data.data
							self:setRecordList()
						end
						printTable(6,"重刷记录params",params)
						RPCReq.Activity_NewYear_GetDrawRecords(params,params.onSuccess)
						if data.times > 0 then 
							local callBack = function ()
								openCtr:setSelectedIndex(0)
							end
							timerKey = Scheduler.scheduleOnce(5, callBack)
						end
					end
					RPCReq.Activity_NewYear_Draw(params,params.onSuccess)
				end
			else
				RollTips.show(Desc.NewYearActivity_str13)
			end
		end)
	end
	
end


function NewYearActivityRedPackView:_initVM( )
	local viewNode = self.view
	---Do not modify following code--------
	--{autoFields}:NewYearActivity.NewYearActivityRedPackView
	self.blackbg = viewNode:getChildAutoType('blackbg')--GLabel
	self.frame = viewNode:getChildAutoType('frame')--GLabel
	self.recordList = viewNode:getChildAutoType('recordList')--GList
	self.redPack1 = viewNode:getChildAutoType('redPack1')--redPack
		self.redPack1.itemCell = viewNode:getChildAutoType('redPack1/itemCell')--GButton
		self.redPack1.itemName = viewNode:getChildAutoType('redPack1/itemName')--GTextField
		self.redPack1.notOpen = viewNode:getChildAutoType('redPack1/notOpen')--GImage
		self.redPack1.open = viewNode:getChildAutoType('redPack1/open')--GImage
	self.redPack2 = viewNode:getChildAutoType('redPack2')--redPack
		self.redPack2.itemCell = viewNode:getChildAutoType('redPack2/itemCell')--GButton
		self.redPack2.itemName = viewNode:getChildAutoType('redPack2/itemName')--GTextField
		self.redPack2.notOpen = viewNode:getChildAutoType('redPack2/notOpen')--GImage
		self.redPack2.open = viewNode:getChildAutoType('redPack2/open')--GImage
	self.redPack3 = viewNode:getChildAutoType('redPack3')--redPack
		self.redPack3.itemCell = viewNode:getChildAutoType('redPack3/itemCell')--GButton
		self.redPack3.itemName = viewNode:getChildAutoType('redPack3/itemName')--GTextField
		self.redPack3.notOpen = viewNode:getChildAutoType('redPack3/notOpen')--GImage
		self.redPack3.open = viewNode:getChildAutoType('redPack3/open')--GImage
	self.redPack4 = viewNode:getChildAutoType('redPack4')--redPack
		self.redPack4.itemCell = viewNode:getChildAutoType('redPack4/itemCell')--GButton
		self.redPack4.itemName = viewNode:getChildAutoType('redPack4/itemName')--GTextField
		self.redPack4.notOpen = viewNode:getChildAutoType('redPack4/notOpen')--GImage
		self.redPack4.open = viewNode:getChildAutoType('redPack4/open')--GImage
	self.redPack5 = viewNode:getChildAutoType('redPack5')--redPack
		self.redPack5.itemCell = viewNode:getChildAutoType('redPack5/itemCell')--GButton
		self.redPack5.itemName = viewNode:getChildAutoType('redPack5/itemName')--GTextField
		self.redPack5.notOpen = viewNode:getChildAutoType('redPack5/notOpen')--GImage
		self.redPack5.open = viewNode:getChildAutoType('redPack5/open')--GImage
	self.redPack6 = viewNode:getChildAutoType('redPack6')--redPack
		self.redPack6.itemCell = viewNode:getChildAutoType('redPack6/itemCell')--GButton
		self.redPack6.itemName = viewNode:getChildAutoType('redPack6/itemName')--GTextField
		self.redPack6.notOpen = viewNode:getChildAutoType('redPack6/notOpen')--GImage
		self.redPack6.open = viewNode:getChildAutoType('redPack6/open')--GImage
	self.redPack7 = viewNode:getChildAutoType('redPack7')--redPack
		self.redPack7.itemCell = viewNode:getChildAutoType('redPack7/itemCell')--GButton
		self.redPack7.itemName = viewNode:getChildAutoType('redPack7/itemName')--GTextField
		self.redPack7.notOpen = viewNode:getChildAutoType('redPack7/notOpen')--GImage
		self.redPack7.open = viewNode:getChildAutoType('redPack7/open')--GImage
	self.redPack8 = viewNode:getChildAutoType('redPack8')--redPack
		self.redPack8.itemCell = viewNode:getChildAutoType('redPack8/itemCell')--GButton
		self.redPack8.itemName = viewNode:getChildAutoType('redPack8/itemName')--GTextField
		self.redPack8.notOpen = viewNode:getChildAutoType('redPack8/notOpen')--GImage
		self.redPack8.open = viewNode:getChildAutoType('redPack8/open')--GImage
	self.txt_num = viewNode:getChildAutoType('txt_num')--GTextField
	self.txt_openNum = viewNode:getChildAutoType('txt_openNum')--GRichTextField
	--{autoFieldsEnd}:NewYearActivity.NewYearActivityRedPackView
	--Do not modify above code-------------
end

function NewYearActivityRedPackView:_initUI( )
	self:_initVM()
	self.txt_openNum:setText(string.format(Desc.NewYearActivity_str14,NewYearActivityModel.drawTimes))
	self.txt_num:setText(NewYearActivityModel:getRedPackNum())
	local params = {}
	params.activityId = GameDef.ActivityType.NewYear
	params.onSuccess = function (data)
		printTable(6,"红包记录数据",data)
		self.recordData = data.data
		self:setRecordList()
	end
	printTable(6,"红包记录params",params)
	RPCReq.Activity_NewYear_GetDrawRecords(params,params.onSuccess)
end

function NewYearActivityRedPackView:setRecordList()
	self.recordList:setItemRenderer(function(idx,obj)
		local index = idx + 1
		local data = self.recordData[index]
		local recordCell = obj:getChildAutoType("recordCell")
		recordCell:setText(string.format(Desc.NewYearActivity_str15,data.name,data.diamond))
	end)
	self.recordList:setData(self.recordData)
end
return NewYearActivityRedPackView