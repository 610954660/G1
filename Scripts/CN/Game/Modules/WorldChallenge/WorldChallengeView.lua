--Name : WorldChallengeView.lua
--Author : generated by FairyGUI
--Date : 2020-5-22
--Desc : 竞技场按钮打开界面
local HorizonPvpType = require"Configs.GameDef.HorizonPvpType"
local WorldChallengeView, Super = class("WorldChallengeView", Window)

function WorldChallengeView:ctor()
    --LuaLog("WorldChallengeView ctor")
    self._packName = "WorldChallenge"
    self._compName = "WorldChallengeView"
    --self._rootDepth = LayerDepth.Window
    self.configInfo = {}
    self.calltimer = {}
    self.aniFlag = false
end

function WorldChallengeView:_initEvent()
end

function WorldChallengeView:_initVM()
    local vmRoot = self
    local viewNode = self.view
    ---Do not modify following code--------
    --{vmFields}:WorldChallenge.WorldChallengeView
    vmRoot.list_function = viewNode:getChildAutoType("$list_function")
    --list
    --{vmFieldsEnd}:WorldChallenge.WorldChallengeView
    --Do not modify above code-------------
end

function WorldChallengeView:_initUI()
    self:_initVM()
    self.configInfo = DynamicConfigData.t_WorldPvpEnter
    -- 屏蔽组队竞技入口
    -- for k,v in pairs(self.configInfo) do
    --     if v.moduleId == ModuleId.CrossTeamPVP.id then
    --         table.remove(self.configInfo,k)
    --         break
    --     end
    -- end

    HigherPvPModel:getRoleInfo()
    --self:setBg("worldchallengeArena.jpg")
    ModelManager.ArenaModel:requestArenInfo(
        function()
            self:showList()
        end
    )
    WorldChallengeModel:getWorldChallengeInfo()
    WorldHighPvpModel:getWorldChallengeInfo()
end

function WorldChallengeView:Arena_battleEnd()
    print(086, "结束战斗刷新竞技场信息")
    self:showList()
end

function WorldChallengeView:_refresh()
    self.aniFlag = false
	self:updateListShow()
end

function WorldChallengeView:showList()
    if tolua.isnull(self.list_function) then
        return
    end
    self.list_function:setVirtual()

    self.list_function:setItemProvider(
        function(index)
            local moduleId = self.configInfo[index + 1].moduleId
            if (moduleId == ModuleId.Arena.id) then
                return "ui://WorldChallenge/WorldChallengeViewItem"
            elseif moduleId == ModuleId.WorldChallengeMainView.id then
                return "ui://WorldChallenge/WorldChallengeViewItem1"
            elseif moduleId == ModuleId.HigherPvP.id then
                return "ui://WorldChallenge/WorldChallengeViewItem2"
			elseif moduleId == ModuleId.CrossPVP.id then
                return "ui://WorldChallenge/WorldChallengeViewItem3"
            elseif moduleId == ModuleId.CrossTeamPVP.id then
                return "ui://WorldChallenge/WorldChallengeViewItem4"
            end
        end
    )

    self.list_function:setItemRenderer(
        function(index, obj)
            obj:removeClickListener(100)
            --池子里面原来的事件注销掉
            obj:addClickListener(
                function(context)
                    local moduleId = self.configInfo[index + 1].moduleId
                    self:touchItem(moduleId)
                end,
                100
            )
            local config = self.configInfo[index + 1]
            local icon_bg = obj:getChildAutoType("$icon_bg")
            icon_bg:setURL("UI/WorldChallenge/" .. config.bg)
            local moduleId = self.configInfo[index + 1].moduleId
            local icon_name = obj:getChildAutoType("$icon_name")
            icon_name:setURL("UI/WorldChallenge/worldchallengeTitleName" .. moduleId .. ".png")
            local img_red = obj:getChild("img_red")
            if moduleId == ModuleId.WorldChallengeMainView.id then
                RedManager.register(GameDef.BattleArrayType.WorldArena, obj:getChild("image_battle"))
                RedManager.register("V_WORLDCHALLENG", img_red, ModuleId.WorldChallengeMainView.id)
                --SpineUtil.createBattleFlag(obj:getChildAutoType("image_battle"))
            elseif moduleId == ModuleId.Arena.id then
                RedManager.register("M_BTN_ARENA", img_red, ModuleId.Arena.id)
				RedManager.register(GameDef.BattleArrayType.ArenaAck, obj:getChild("image_battle"))
				SpineUtil.createBattleFlag(obj:getChildAutoType("image_battle"))
            elseif moduleId == ModuleId.HigherPvP.id then
                RedManager.register("V_HIGHERPVP", img_red, ModuleId.HigherPvP.id)
				RedManager.register(GameDef.BattleArrayType.HigherPvpAckOne, obj:getChild("image_battle"))
				SpineUtil.createBattleFlag(obj:getChildAutoType("image_battle"))
			elseif moduleId == ModuleId.CrossPVP.id then
                RedManager.register("V_CROSSPVP", img_red, ModuleId.CrossPVP.id)
				RedManager.register(GameDef.BattleArrayType.HorizonPvpAckOne, obj:getChild("image_battle"))
                SpineUtil.createBattleFlag(obj:getChildAutoType("image_battle"))
            elseif moduleId == ModuleId.CrossTeamPVP.id then  -- 组队竞技
                RedManager.register("V_CROSSTEAMPVP", img_red, ModuleId.CrossTeamPVP.id)
				RedManager.register(GameDef.BattleArrayType.WorldTeamArena, obj:getChild("image_battle"))
                SpineUtil.createBattleFlag(obj:getChildAutoType("image_battle"))
            end
            self:showItem(obj, moduleId)
            if not self.aniFlag then
                if (index+1)%2==0 then
                    obj:getTransition("t1"):play(function( ... )
                    end);
                else
                    obj:getTransition("t0"):play(function( ... )
                    end);
                end
            end
        end
    )
    -- self.list_function:setNumItems(#self.configInfo)
    self:updateListShow()
    -- self.aniFlag = true
end

function WorldChallengeView:showItem(obj, moduleId)
    local txt_countdown = obj:getChildAutoType("$txt_countdown")
    local addtime = 0
    local str = Desc.WorldChallenge_countTitle
    if moduleId == ModuleId.Arena.id then
        local ArenaInfo = ModelManager.ArenaModel:getRankInfo()
        local myInfo = ArenaInfo.myInfo
        local seasonEndDt = ArenaInfo.seasonEndDt
        addtime = (seasonEndDt - ServerTimeModel:getServerTimeMS()) / 1000
        addtime = math.max(addtime, 0)
        self:showArenaItem(obj, moduleId)
    elseif moduleId == ModuleId.WorldChallengeMainView.id then
        addtime, str = self:showWorldChallengeItem(obj, moduleId)
    elseif moduleId == ModuleId.HigherPvP.id then
        self:showHigherPvPItem(obj, moduleId)
        local endTime = TimeLib.nextWeekBeginTime()
        addtime = TimeLib.getOffsetTime(endTime)
        if (addtime > 7200) then
            str = Desc.WorldChallenge_countTitle
            addtime = addtime - 7200
        else
            str = Desc.WorldChallenge_countTitle2
        end
    elseif moduleId == ModuleId.CrossTeamPVP.id then -- 组队竞技
        addtime, str = self:showCrossTeamItem(obj, moduleId)
	elseif moduleId == ModuleId.CrossPVP.id then
		local gCtr2 = obj:getController("c2")
		gCtr2:setSelectedIndex(2)
		local txt_ranknum = obj:getChildAutoType("$txt_ranknum")
		local txt_remintime = obj:getChildAutoType("$txt_remintime")
		if CrossPVPModel:getResidueNum() <= 0 then
			txt_remintime:setText(string.format(Desc.CrossPVPDesc7,CrossPVPModel:getBuyNum()))
		else
			txt_remintime:setText(string.format(Desc.CrossPVPDesc4,CrossPVPModel:getResidueNum()))
		end
		txt_ranknum:setText(CrossPVPModel:getNowRank() == 0 and Desc.CrossPVPDesc9 or CrossPVPModel:getNowRank())
		local crossData = CrossPVPModel:getSeverData()
		if crossData then
			addtime = (CrossPVPModel:getSeverData().endTtime + 1800 ) - ServerTimeModel:getServerTime() - 10
			str = Desc.WorldChallenge_countTitle
			if addtime <= 1800 then 
				if addtime < 0 then
					addtime = 0 
				end
				str = Desc.CrossPVPDesc21
			end
		else
			gCtr2:setSelectedIndex(2)
			return 
		end
		if addtime <= 0 then 
			addtime = 0 
		end
		self:showCrossPVPItem(obj, moduleId)
    end

    if not tolua.isnull(txt_countdown) then
        txt_countdown:setText(str .. ColorUtil.formatColorString1(TimeLib.GetTimeFormatDay1(addtime), "#68fa4f"))
        --TimeLib.formatTime(addtime,true,false)
    end
    local function onCountDown(time)
        if not tolua.isnull(txt_countdown) then
            txt_countdown:setText(str .. ColorUtil.formatColorString1(TimeLib.GetTimeFormatDay1(time), "#68fa4f"))
        --TimeLib.formatTime(time,true,false)
        end
		if moduleId == ModuleId.CrossPVP.id then
			self:showCrossPVPItem(obj, moduleId)
		end
    end
    local function onEnd(...)
        if moduleId == ModuleId.CrossTeamPVP.id then
            -- CrossTeamPVPModel:reqGetCurMatchStatus()
		end
    end
    if self.calltimer[moduleId] then
        TimeLib.clearCountDown(self.calltimer[moduleId])
    end
    self.calltimer[moduleId] = TimeLib.newCountDown(addtime, onCountDown, onEnd, false, false, false)
end
function WorldChallengeView:showCrossPVPItem(obj, moduleId)
	local gCtr2 = obj:getController("c2") -- 0 未解锁 1 已解锁
	local txt_openTime = obj:getChildAutoType("txt_openTime")
	local txt_open = obj:getChildAutoType("$txt_open")
	local tips = ModuleUtil.getModuleOpenTips(moduleId)
    if tips then -- 未开启
		gCtr2:setSelectedIndex(0)
        local conf = DynamicConfigData.t_module[moduleId]
        local limit = conf.condition
        for _, v in ipairs(limit) do
            if (v.type == 4) then
                local openDay = ServerTimeModel:getOpenDay() + 1
                if (openDay < v.val) then
--					local time = math.floor((v.val - openDay) * 24 * 3600 + TimeLib.getDayResidueSecond())
--					local typ = "d"
--					local descTyp = Desc.common_TimeDesc
--					if time < 60 * 60 * 24 then
--						typ = "h"
--						descTyp =  Desc.common_TimeDesc2
--					end
                    txt_openTime:setText(string.format(Desc.CrossPVPDesc18,v.val - openDay))
                else
                    txt_openTime:setText("")
                end
            elseif (v.type == 1) then
                txt_open:setText(Desc.moduleOpen_tips1:format(v.val) .. Desc.moduleOpen_tips0)
            end
        end
    else
       gCtr2:setSelectedIndex(1)
    end
end
function WorldChallengeView:touchItem(moduleId)
    if moduleId == ModuleId.WorldChallengeMainView.id then
        local model = WorldChallengeModel:getModelByType()
        model:getWorldChallengeInfo()
	elseif moduleId == ModuleId.CrossPVP.id then
		local crossData = CrossPVPModel:getSeverData()
		if not crossData then
			RollTips.show(Desc.activity_txt1)
			return
        end
    elseif moduleId == ModuleId.CrossTeamPVP.id then
        CrossTeamPVPModel:getDefTemp()
        return
    end
    local tips = ModuleUtil.getModuleOpenTips(moduleId)
    if tips ~= nil then
        RollTips.show(Desc.WorldChallenge_str5)
        return
    end
    -- if moduleId==ModuleId.Arena.id then

    -- elseif moduleId==ModuleId.WorldChallengeMainView.id then

    -- end
    ModuleUtil.openModule(moduleId, true)
    --self:closeView()
end

-- 竞技场入口
function WorldChallengeView:showArenaItem(obj, moduleId)
    local gCtr = obj:getController("c1")
    local gCtr1 = obj:getController("c2")
    local txt_remintime = obj:getChildAutoType("$txt_remintime")
    local txt_ranknum = obj:getChildAutoType("$txt_ranknum")
    local txt_open = obj:getChildAutoType("$txt_open")

    local ArenaInfo = ModelManager.ArenaModel:getRankInfo()
    local myInfo = ArenaInfo.myInfo

    txt_ranknum:setText(myInfo and myInfo.rank or 0)
    local reminNum = ArenaModel:getFreeTime()
    -- print(086, reminNum, "剩余次数")
    txt_remintime:setText(Desc.WorldChallenge_countTitle3 .. reminNum)
    local tips = ModuleUtil.getModuleOpenTips(moduleId)
    if tips == nil then
        gCtr:setSelectedIndex(0)
        gCtr1:setSelectedIndex(1)
    else
        gCtr:setSelectedIndex(1)
        gCtr1:setSelectedIndex(0)
        txt_open:setText(tips .. Desc.moduleOpen_tips0)
    end
end

-- 组队竞技入口
function WorldChallengeView:showCrossTeamItem(obj, moduleId)
    local addtime       = 0
    local str           = Desc.CrossTeamPVP_mainCountTitle
    local gCtr2         = obj:getController("c2") -- 0 未解锁 1 已解锁
	local txt_openTime  = obj:getChildAutoType("txt_openTime")
    local txt_open      = obj:getChildAutoType("$txt_open")
    local txt_ranknum   = obj:getChildAutoType("$txt_ranknum")  -- 当前段位
    local txt_remintime = obj:getChildAutoType("$txt_remintime")
    
    local data = CrossTeamPVPModel.crossTeamInfoByReason[GameDef.WorldTeamArenaReasonType.Open] or {} 
    local danInfo = CrossTeamPVPModel:getCurDanInfoByIntegral(data.score or 0) 
    txt_ranknum:setText(string.format(Desc["HigherPvP_rankColor"..danInfo.icon], danInfo.name));

	local tips = ModuleUtil.getModuleOpenTips(moduleId)
    if tips then -- 未开启
        txt_remintime:setText("")
		gCtr2:setSelectedIndex(0)
        local conf = DynamicConfigData.t_module[moduleId]
        local limit = conf.condition
        for _, v in ipairs(limit) do
            if (v.type == 4) then
                local openDay = ServerTimeModel:getOpenDay() + 1
                if (openDay < v.val) then
                    txt_openTime:setText(string.format(Desc.CrossPVPDesc18,v.val - openDay))
                else
                    txt_openTime:setText("")
                end
            elseif (v.type == 1) then
                txt_open:setText(Desc.moduleOpen_tips1:format(v.val) .. Desc.moduleOpen_tips0)
            end
        end
    else
        txt_remintime:setText(string.format(Desc.CrossTeamPVP_str1,CrossTeamPVPModel.restTimes))
        gCtr2:setSelectedIndex(1)
    end
    local activeEndTime = CrossTeamPVPModel.activityEndMs  -- 服务器下推时间
    local ServerTime    = ServerTimeModel:getServerTime()
    if activeEndTime == 0 then
        activeEndTime = ServerTime*1000
    end
    addtime = math.floor(activeEndTime/1000) - ServerTime
    if CrossTeamPVPModel.status == GameDef.WorldTeamArenaStatusType.END then
        str = Desc.CrossTeamPVP_mainCountTitle3
    elseif CrossTeamPVPModel.status == GameDef.WorldTeamArenaStatusType.PREPARE then
        str = Desc.CrossTeamPVP_mainCountTitle2
    elseif CrossTeamPVPModel.status == GameDef.WorldTeamArenaStatusType.OPEN then
        str = Desc.CrossTeamPVP_mainCountTitle
    end
    return addtime,str
end


-- 世界擂台赛入口
function WorldChallengeView:showWorldChallengeItem(obj, moduleId)
    local addtime = 0;
    local str = Desc.WorldChallenge_countTitle6
    local championCtrl = obj:getController("champion") -- 是否显示冠军信息 1 显示 0 隐藏
    local gCtr1 = obj:getController("c1") -- 0 未结算 2 已结算
    local gCtr2 = obj:getController("c2") -- 0 未解锁 1 已解锁
    local txt_open = obj:getChildAutoType("$txt_open") -- 开启条件
    local txt_mode = obj:getChildAutoType("txt_mode")  -- 玩法模式
    local txt_match = obj:getChildAutoType("txt_match") -- 赛程
    if (not obj.cell) then
        obj.cell = BindManager.bindPlayerCell(obj:getChildAutoType("heroCell"))
    end
    local txt_playerName = obj:getChildAutoType("txt_playerName")
    
    championCtrl:setSelectedIndex(0);
    local curMode = WorldChallengeModel.matchMode
    local model = WorldChallengeModel:getModelByType(curMode)
    local otherModel = WorldChallengeModel:getModelByType(1 - curMode)
    local state = model.WorldChallengeActiveTime.state --#活动参与状态, 0未参赛, 1已参赛, 2本服轮空
    local stage = model.WorldChallengeActiveTime.stage --#stage赛程 0-已结算 1-决赛  2-半决赛  3-8进4  4-16进8  5-32进16  6-64进32
    local tips = ModuleUtil.getModuleOpenTips(moduleId)
    txt_mode:setText(Desc["WorldChallenge_mode"..curMode])
    if tips or state == 2 or not stage then
        gCtr1:setSelectedIndex(0)
        gCtr2:setSelectedIndex(0)
        if tips then -- 未开启
            txt_open:setText(tips .. Desc.moduleOpen_tips0)
        else  -- 参赛人数不足，本轮取消
            txt_open:setText(Desc.WorldChallenge_str6)
        end
        txt_match:setText("")
    else
        gCtr2:setSelectedIndex(1)
        local str = Desc["WorldChallenge_stage"..stage]
        local m = 1 - curMode
        if stage == 0 then
            gCtr1:setSelectedIndex(1)
            str = string.format(str, Desc["WorldChallenge_modeShort"..m])
            local championData = model.WorldChallenInfo["0_0_1"];
            if (championData) then
                championCtrl:setSelectedIndex(1);
                local playerInfo = model.playerMap[championData.playerId]
                obj.cell:setHead(playerInfo.head, playerInfo.level, nil, nil, playerInfo.headBorder)
                txt_playerName:setText(playerInfo.name)
            end
        else
            gCtr1:setSelectedIndex(0)
        end
        txt_match:setText(str)
    end
    
    -- local activeTime = model.WorldChallengeActiveTime.startStamp or 0
    local curServerTime = ServerTimeModel:getServerTime()
    -- addtime = otherModel.WorldChallengeActiveTime.nextStartStamp - curServerTime
    -- printTable(13, "活动基础信息", activeTime, curServerTime, addtime)
    local nextTime = otherModel.WorldChallengeActiveTime.nextStartStamp or model.WorldChallengeActiveTime.endStamp
    addtime = nextTime and nextTime - curServerTime or 0
    return addtime, str;
end

-- 高级竞技场入口
function WorldChallengeView:showHigherPvPItem(obj, moduleId)
    local playerInfo = HigherPvPModel.selfInfo
    if (not playerInfo) then
        return
    end

    local ctrl1 = obj:getController("c1")
    local ctrl2 = obj:getController("c2")
    local txt_remintime = obj:getChildAutoType("$txt_remintime")
    local txt_rankName = obj:getChildAutoType("$txt_rankName")
    local txt_open = obj:getChildAutoType("$txt_open")
    local txt_openTime = obj:getChildAutoType("txt_openTime")
    if (not txt_openTime) then return end
    local tips = ModuleUtil.getModuleOpenTips(moduleId)
    if (tips) then -- 未开启
        txt_remintime:setText("")
        ctrl2:setSelectedIndex(0)
        if (ctrl1) then
            ctrl1:setSelectedIndex(1)
        end
        local conf = DynamicConfigData.t_module[moduleId]
        local limit = conf.condition
        for _, v in ipairs(limit) do
            if (v.type == 4) then
                local openDay = ServerTimeModel:getOpenDay() + 1
                if (openDay < v.val) then
                    txt_openTime:setText(string.format(Desc.WorldChallenge_openlimit1, (v.val - openDay)))
                else
                    txt_openTime:setText("")
                end
            elseif (v.type == 1) then
                txt_open:setText(Desc.moduleOpen_tips1:format(v.val) .. Desc.moduleOpen_tips0)
            end
        end
        obj:getController("c3"):setSelectedIndex(txt_openTime:getText() == "" and 1 or 0)
    else
        txt_remintime:setText(string.format(Desc.WorldChallenge_str7, playerInfo.leftTimes))
        ctrl2:setSelectedIndex(1)
        if (ctrl1) then
            ctrl1:setSelectedIndex(0)
        end
        local rankName = HigherPvPModel:getRankName(playerInfo.rankIndex) or Desc.HigherPvP_NoRankName
        if (txt_rankName) then
            txt_rankName:setText(rankName)
        end
    end
end

function WorldChallengeView:HigherPvp_upSelfInfo()
    local conf = DynamicConfigData.t_WorldPvpEnter
    local index = false
    for idx, c in ipairs(conf) do
        if (c.moduleId == ModuleId.HigherPvP.id) then
            index = idx
            break
        end
    end
    if (index) then
        local obj = self.list_function:getChildren()[index]
        if (obj) then
            self:showHigherPvPItem(obj, ModuleId.HigherPvP.id)
        end
    end
end

function WorldChallengeView:serverTime_crossDay(...) --跨天
    printTable(32, "打印的掉阿斯顿发的说法是》》》》》》》》》》》》3")
    WorldChallengeModel:getWorldChallengeInfo()
    WorldHighPvpModel:getWorldChallengeInfo()
    HigherPvPModel:getRoleInfo()
    ModelManager.ArenaModel:requestArenInfo(
        function()
        end
    )
    -- self.configInfo = DynamicConfigData.t_WorldPvpEnter
    -- self.list_function:setNumItems(#self.configInfo)
    self:updateListShow()
end

--刷新方法统一处理
function WorldChallengeView:updateListShow( ... )
    GlobalUtil.delayCallOnce("WorldChallengeView.updateListShow",function() 
        self.configInfo = DynamicConfigData.t_WorldPvpEnter
        if not tolua.isnull(self.list_function) then
            self.list_function:setNumItems(#self.configInfo)
        end
        self.aniFlag = true
    end,self, 0.1)
end

function WorldChallengeView:worldChallenge_xiasaijidaojishi(...) --下赛季倒计时刷新
    printTable(32, "打印的掉阿斯顿发的说法是》》》》》》》》》》》》》》》》4")
    WorldChallengeModel:getWorldChallengeInfo()
    WorldHighPvpModel:getWorldChallengeInfo()
    -- self.configInfo = DynamicConfigData.t_WorldPvpEnter
    -- self.list_function:setNumItems(#self.configInfo)
    self:updateListShow()
end

function WorldChallengeView:worldChallenge_daojishishuaxing()
    -- self.configInfo = DynamicConfigData.t_WorldPvpEnter
    -- self.list_function:setNumItems(#self.configInfo)
    self:updateListShow()
end

function WorldChallengeView:_exit()
    for key, value in pairs(self.calltimer) do
        if value then
            TimeLib.clearCountDown(value)
        end
    end
    self.calltimer = {}
end

return WorldChallengeView
