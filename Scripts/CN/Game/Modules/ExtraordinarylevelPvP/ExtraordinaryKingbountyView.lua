--Name : ExtraordinaryKingbountyView.lua
--Author : generated by FairyGUI
--Date : 2020-5-29
--Desc : 

local ExtraordinaryKingbountyView,Super = class("ExtraordinaryKingbountyView", Window)
local ItemCell = require "Game.UI.Global.ItemCell"
function ExtraordinaryKingbountyView:ctor()
	--LuaLog("ExtraordinaryKingbountyView ctor")
	self._packName = "ExtraordinarylevelPvP"
	self._compName = "ExtraordinaryKingbountyView"
	self._rootDepth = LayerDepth.FaceWindow
	self.chargeId=1
end

function ExtraordinaryKingbountyView:_initEvent( )
	
end

function ExtraordinaryKingbountyView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:OperatingActivities.ExtraordinaryKingbountyView
		vmRoot.btn_play = viewNode:getChildAutoType("$btn_play")--Button
		vmRoot.list_allReward = viewNode:getChildAutoType("$list_allReward")--list
		vmRoot.list_reward = viewNode:getChildAutoType("$list_reward")--list
	--{vmFieldsEnd}:OperatingActivities.ExtraordinaryKingbountyView
	--Do not modify above code-------------
end

function ExtraordinaryKingbountyView:_initUI( )
	self:_initVM()
	local mainInfo = ExtraordinarylevelPvPModel:getMainInfo()
    if next(mainInfo) == nil then
        return
    end
	local price=DynamicConfigData.t_Kingpay[self.chargeId].price or 98
	self.btn_play:setTitle(string.format(Desc.activity_txt15,price))
	local tableAll={}
	local tableCur={}
	local allrewardInfo={}
	local currewardInfo={}
	local Kingpay=DynamicConfigData.t_Kingpay[self.chargeId]
	local configInfo=DynamicConfigData.t_Kingcard
	local starTotal=0
	local playerWinNum=ExtraordinarylevelPvPModel.wangzhezhizhengInfo.winNum or 0
	if playerWinNum<configInfo[Kingpay.id].victoryTimes then
		starTotal=configInfo[Kingpay.id].victoryTimes
	elseif playerWinNum>=configInfo[Kingpay.id].victoryTimes then
		starTotal=Kingpay.winNumber
	else
		starTotal=playerWinNum
	end
	local lingquMap = ExtraordinarylevelPvPModel.wangzhezhizhengInfo.danKingReward or {}
	for key, value in pairs(configInfo) do
		local info = lingquMap[value.id] or {}
		local speciaIndex = true
		if info.bugState == nil then
			speciaIndex = true
		else
			speciaIndex = info.bugState
		end
		if speciaIndex==true and starTotal>=value.victoryTimes then
			table.insert(tableCur,value.payitem)	
			table.insert(tableCur,value.freeitem)		
		end
		table.insert(tableAll,value.payitem)	
	end
	local tableCeihua=DynamicConfigData.t_Kingpay[self.chargeId].item or {}
	if tableCeihua and tableCeihua[1] and tableCeihua[1].amount>0 then
		table.insert(tableCur,tableCeihua)	
	end
	allrewardInfo=TableUtil:getReward(tableAll,1)
	currewardInfo=TableUtil:getReward(tableCur,1)

	self.list_allReward:setItemRenderer(function(index,rewardObj)
		rewardObj:removeClickListener(100)
		--池子里面原来的事件注销掉
	   local itemcell = BindManager.bindItemCell(rewardObj)
	   local award =currewardInfo[index + 1]
	   itemcell:setData(award.code, award.amount, award.type)
	  -- itemcell:setFrameVisible(false)
	  rewardObj:addClickListener(function( ... )
		   itemcell:onClickCell()
	   end,100)
	end)
	self.list_allReward:setNumItems(#currewardInfo);


	self.list_reward:setItemRenderer(function(index,rewardObj)
		rewardObj:removeClickListener(100)
		--池子里面原来的事件注销掉
	   local itemcell = BindManager.bindItemCell(rewardObj)
	   local award =allrewardInfo[index + 1]
	   itemcell:setData(award.code, award.amount, award.type)
	  -- itemcell:setFrameVisible(false)
	  rewardObj:addClickListener(function( ... )
		   itemcell:onClickCell()
	   end,100)
	end)
	self.list_reward:setNumItems(#allrewardInfo);
end


--事件初始化
function ExtraordinaryKingbountyView:_initEvent(...)
    self.btn_play:addClickListener(
		function(...)
			local config = DynamicConfigData.t_Kingpay[self.chargeId]
			if config then 
				local price=config.price or 98
				ModelManager.RechargeModel:directBuy(price, GameDef.StatFuncType.SFT_CorssKingJourney, 1, "王者之证",nil,"王者之证98")
			end
			ViewManager.close("ExtraordinaryKingbountyView")
            -- RollTips.show("暂未开启充值")
        end
    )
end

return ExtraordinaryKingbountyView