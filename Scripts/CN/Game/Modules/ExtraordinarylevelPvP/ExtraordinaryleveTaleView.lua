--Date :2020-12-25
--Author : generated by FairyGUI
--Desc : 赛季传奇

local ExtraordinaryleveTaleView, Super = class("ExtraordinaryleveTaleView", Window)

function ExtraordinaryleveTaleView:ctor()
    --LuaLog("ExtraordinaryleveTaleView ctor")
    self._packName = "ExtraordinarylevelPvP"
    self._compName = "ExtraordinaryleveTaleView"
    self._rootDepth = LayerDepth.PopWindow
    self.assignId = 1 --1:integer #赛区ID
    self.seasonId = 1 --2:integer #赛季id
    self.skeletonNode = {}
end

function ExtraordinaryleveTaleView:_initEvent()
end

function ExtraordinaryleveTaleView:_initVM()
    local viewNode = self.view
    ---Do not modify following code--------
    --{autoFields}:ExtraordinarylevelPvP.ExtraordinaryleveTaleView
	self.btn_left = viewNode:getChildAutoType('btn_left')--GButton
	self.btn_right = viewNode:getChildAutoType('btn_right')--GButton
	self.com_model1 = viewNode:getChildAutoType('com_model1')--Component6
		self.com_model1.CrownTitleCell = viewNode:getChildAutoType('com_model1/CrownTitleCell')--GComponent
		self.com_model1.com_model = viewNode:getChildAutoType('com_model1/com_model')--GLoader
		self.com_model1.txt_playerfight1 = viewNode:getChildAutoType('com_model1/txt_playerfight1')--GRichTextField
		self.com_model1.txt_servername = viewNode:getChildAutoType('com_model1/txt_servername')--GRichTextField
	self.com_model2 = viewNode:getChildAutoType('com_model2')--Component6
		self.com_model2.CrownTitleCell = viewNode:getChildAutoType('com_model2/CrownTitleCell')--GComponent
		self.com_model2.com_model = viewNode:getChildAutoType('com_model2/com_model')--GLoader
		self.com_model2.txt_playerfight1 = viewNode:getChildAutoType('com_model2/txt_playerfight1')--GRichTextField
		self.com_model2.txt_servername = viewNode:getChildAutoType('com_model2/txt_servername')--GRichTextField
	self.com_model3 = viewNode:getChildAutoType('com_model3')--Component6
		self.com_model3.CrownTitleCell = viewNode:getChildAutoType('com_model3/CrownTitleCell')--GComponent
		self.com_model3.com_model = viewNode:getChildAutoType('com_model3/com_model')--GLoader
		self.com_model3.txt_playerfight1 = viewNode:getChildAutoType('com_model3/txt_playerfight1')--GRichTextField
		self.com_model3.txt_servername = viewNode:getChildAutoType('com_model3/txt_servername')--GRichTextField
	self.com_model4 = viewNode:getChildAutoType('com_model4')--Component6
		self.com_model4.CrownTitleCell = viewNode:getChildAutoType('com_model4/CrownTitleCell')--GComponent
		self.com_model4.com_model = viewNode:getChildAutoType('com_model4/com_model')--GLoader
		self.com_model4.txt_playerfight1 = viewNode:getChildAutoType('com_model4/txt_playerfight1')--GRichTextField
		self.com_model4.txt_servername = viewNode:getChildAutoType('com_model4/txt_servername')--GRichTextField
	self.com_model5 = viewNode:getChildAutoType('com_model5')--Component6
		self.com_model5.CrownTitleCell = viewNode:getChildAutoType('com_model5/CrownTitleCell')--GComponent
		self.com_model5.com_model = viewNode:getChildAutoType('com_model5/com_model')--GLoader
		self.com_model5.txt_playerfight1 = viewNode:getChildAutoType('com_model5/txt_playerfight1')--GRichTextField
		self.com_model5.txt_servername = viewNode:getChildAutoType('com_model5/txt_servername')--GRichTextField
	self.com_model6 = viewNode:getChildAutoType('com_model6')--Component6
		self.com_model6.CrownTitleCell = viewNode:getChildAutoType('com_model6/CrownTitleCell')--GComponent
		self.com_model6.com_model = viewNode:getChildAutoType('com_model6/com_model')--GLoader
		self.com_model6.txt_playerfight1 = viewNode:getChildAutoType('com_model6/txt_playerfight1')--GRichTextField
		self.com_model6.txt_servername = viewNode:getChildAutoType('com_model6/txt_servername')--GRichTextField
	self.com_xialaList = viewNode:getChildAutoType('com_xialaList')--GComboBox
	self.frame = viewNode:getChildAutoType('frame')--GLabel
	self.txt_desc = viewNode:getChildAutoType('txt_desc')--GRichTextField
 --{autoFieldsEnd}:ExtraordinarylevelPvP.ExtraordinaryleveTaleView
    --Do not modify above code-------------
end

function ExtraordinaryleveTaleView:_initListener()
    self.btn_left:addClickListener(
        function()
            self.seasonId = self.seasonId - 1
            if self.seasonId <= 0 then
                self.seasonId = 1
            end
            local mundName = ExtraordinarylevelPvPModel:getSuperMundName(self.assignId)
            self.txt_desc:setText(string.format("S%s赛季-%s赛区", self.seasonId, mundName))
            ExtraordinarylevelPvPModel:getSeasonPlayerRankData(self.assignId, self.seasonId)
        end
    )
    self.btn_right:addClickListener(
        function()
            local max = ExtraordinarylevelPvPModel.listValue[self.assignId]
            self.seasonId = self.seasonId + 1
            if self.seasonId >= #max then
                self.seasonId = #max
            end
            local mundName = ExtraordinarylevelPvPModel:getSuperMundName(self.assignId)
            self.txt_desc:setText(string.format("S%s赛季-%s赛区", self.seasonId, mundName))
            ExtraordinarylevelPvPModel:getSeasonPlayerRankData(self.assignId, self.seasonId)
        end
    )
end

function ExtraordinaryleveTaleView:_initUI()
    self:_initVM()
    self:_initListener()
    local url = "Bg/dreammaster_bg.png"
    GMethodUtil:setFrameViewBg(self.view, url)
    ExtraordinarylevelPvPModel:getAllSeasonInfo()
end

function ExtraordinaryleveTaleView:extraordinarylevelPvP_saijichuangqi()
    local com_xialaList = self.com_xialaList
    local listDesc, listData, listValue = ExtraordinarylevelPvPModel:getXialaListArr()
    com_xialaList:setVisible(true)
    com_xialaList:setItems(listDesc)
    com_xialaList:setValues(listData)
    com_xialaList:setSelectedIndex(0)
    com_xialaList:removeEventListener(FUIEventType.Changed)
    com_xialaList:addEventListener(
        FUIEventType.Changed,
        function(context)
            local value = tonumber(com_xialaList:getValue())
            ExtraordinarylevelPvPModel:getSeasonPlayerRankData(value, 1)
            self.assignId = value --1:integer #赛区ID
            self.seasonId = 1 --2:integer #赛季id
        end
    )
    local mainInfo = ExtraordinarylevelPvPModel:getMainInfo()
    if next(mainInfo) == nil then
        return
    end
    self.assignId = mainInfo.assignId
    self.seasonId = mainInfo.seasonId
    ExtraordinarylevelPvPModel:getSeasonPlayerRankData(self.assignId, self.seasonId)
    local mundName = ExtraordinarylevelPvPModel:getSuperMundName(self.assignId)
    self.txt_desc:setText(string.format("S%s赛季-%s赛区", self.seasonId, mundName))
end

function ExtraordinaryleveTaleView:extraordinarylevelPvP_saijiqchuangqi(_, info)
    local map = ExtraordinarylevelPvPModel.saijichuangqiPlayerInfo[self.assignId]
    local rankList = map[self.seasonId]
    for i = 1, 6, 1 do
        local rankItme = rankList[i]
        local comgItem = self.view:getChildAutoType("com_model" .. i)
        if rankItme then
            comgItem:setVisible(true)
            local txt_servername = comgItem:getChildAutoType("txt_servername")
            txt_servername:setText(string.format("[%s%s]%s", "S.", rankItme.serverId, rankItme.name))
            local txt_playerfight1 = comgItem:getChildAutoType("txt_playerfight1")
            txt_playerfight1:setText(StringUtil.transValue(rankItme.combat))
            local com_mode = comgItem:getChildAutoType("com_model")
            local configItem = DynamicConfigData.t_hero[rankItme.head]
            if not configItem then
                return
            end
            local modeId = configItem.model
            local skeletonNode = SpineMnange.createSprineById(modeId)
            if not skeletonNode then
                return
            end
            com_mode:displayObject():addChild(skeletonNode)
            skeletonNode:setAnimation(0, "stand", true)
            if self.skeletonNode[i] then
                self.skeletonNode[i]:removeFromParent()
            end
            local CrownTitleCell = comgItem:getChildAutoType("CrownTitleCell")
            if CrownTitleCell then
                CrownTitleCell:setScale(1.1,1.1)
            end
            self.skeletonNode[i] = skeletonNode
            local legendAward = DynamicConfigData.t_LegendAward[i]
            if legendAward then
                local legendAwardId = legendAward.item[1].code
                local crownInfo = DynamicConfigData.t_CrownTitle[legendAwardId] -- 称号信息
                local bindCrownTitleCell = BindManager.bindCrownTitleCell(CrownTitleCell)
                bindCrownTitleCell:setData(crownInfo.code)
            end
        else
            comgItem:setVisible(false)
        end
    end
end

return ExtraordinaryleveTaleView
