--Date :2020-12-26
--Author : generated by FairyGUI
--Desc : 

local ExtraordinarEndLayerView,Super = class("ExtraordinarEndLayerView", View)

function ExtraordinarEndLayerView:ctor()
	--LuaLog("ExtraordinarEndLayerView ctor")
	self._packName = "ExtraordinarylevelPvP"
	self._compName = "ExtraordinarEndLayerView"
	--self._rootDepth = LayerDepth.Window
	
end

function ExtraordinarEndLayerView:_initEvent( )
	
end

function ExtraordinarEndLayerView:_initVM( )
	local viewNode = self.view
	---Do not modify following code--------
	--{autoFields}:ExtraordinarylevelPvP.ExtraordinarEndLayerView
	self.bar_huanchongjifen = viewNode:getChildAutoType('bar_huanchongjifen')--GProgressBar
	self.duanweidesc = viewNode:getChildAutoType('duanweidesc')--GRichTextField
	self.img_duanwei = viewNode:getChildAutoType('img_duanwei')--GLoader
	self.list_reward = viewNode:getChildAutoType('list_reward')--GComponent
	self.list_star = viewNode:getChildAutoType('list_star')--GList
	self.progressBar = viewNode:getChildAutoType('progressBar')--GProgressBar
	self.txt_jifen = viewNode:getChildAutoType('txt_jifen')--GRichTextField
	--{autoFieldsEnd}:ExtraordinarylevelPvP.ExtraordinarEndLayerView
	--Do not modify above code-------------
end

function ExtraordinarEndLayerView:_initListener( )
	
end

function ExtraordinarEndLayerView:_initUI( )
	self:_initVM()
	self:_initListener()
	local mainInfo = ExtraordinarylevelPvPModel:getMainInfo()
    if next(mainInfo) == nil then
        return
    end
	local serverInfo= ExtraordinarylevelPvPModel.battleResultInfo
	local map=serverInfo.promotionRecord or {}
    local max = ExtraordinarylevelPvPModel:getCurduanExp(serverInfo.dan)

	self.progressBar:setValue(serverInfo.danScore or 0)
	self.progressBar:setMax(max)
	self.progressBar:getChildAutoType("val"):setText(serverInfo.danScore)
	self.progressBar:getChildAutoType("count"):setText(max)

	local huanchong= ExtraordinarylevelPvPModel:getCurHuanchongExp(serverInfo.dan) 
	self.bar_huanchongjifen:setValue(serverInfo.danCacheScore or 0)
	self.bar_huanchongjifen:setMax(huanchong)
	local addStr="+"
	if serverInfo.scoreChange<0 then
		addStr=""
	end
	self.txt_jifen:setText(string.format("%s（%s%s）",ColorUtil.formatColorString1(serverInfo.danScore,"#FFFFFF") ,addStr,serverInfo.scoreChange))
	local isJingjisai= ExtraordinarylevelPvPModel:getIsJingjisai() 
	if isJingjisai==true then
		self.list_star:setVisible(true)
		local star = ExtraordinarylevelPvPModel:getCurduanStar(serverInfo.dan)
        self.list_star:setItemRenderer(
            function(index, obj)
                local c1 = obj:getController("c1")
                local promotion = map[index + 1]
                if promotion == true then
                    c1:setSelectedIndex(2)
                elseif promotion == false then
                    c1:setSelectedIndex(1)
                else
                    c1:setSelectedIndex(0)
                end
            end
        )
        self.list_star:setNumItems(star)
	else
		self.list_star:setVisible(false)
	end
	self.img_duanwei:setURL(ExtraordinarylevelPvPModel:getDanIcon(serverInfo.dan))--段位图标
	local desc = ExtraordinarylevelPvPModel:getDanChinese(serverInfo.dan)--段位文字
	self.duanweidesc:setText(desc)

	self.list_reward:getChild("img_mask"):setTouchable(false)
	local list_reward= self.list_reward:getChildAutoType("list_reward")
	 local rewardPre =self._args.data.reward
	list_reward:setItemRenderer(function(index,obj)
		local cellObj = obj:getChild("itemCell")
		cellObj:setVisible(false)
		local itemcell = BindManager.bindItemCell(cellObj)
		local award =rewardPre[index + 1]
		itemcell:setData(award.code, award.amount, award.type)
		itemcell:setFrameVisible(false)
		cellObj:addClickListener(function( ... )
			itemcell:onClickCell()
		end)

		Scheduler.schedule(function()
			if tolua.isnull(self.view) then
				return
			end
			cellObj:setVisible(true)
			local rotate = cc.RotateBy:create(0.15,{x = 0,y = 180,z = 0})
			local rotate2 = cc.RotateBy:create(0.15,{x = 0,y = -180,z = 0})
			local callBack = cc.CallFunc:create(function()
				SpineUtil.createSpineObj(cellObj, vertex2(cellObj:getWidth()/2,cellObj:getHeight()/2), "wuti_chuxian", "Spine/ui/jiesuan", "efx_jiesuan", "efx_jiesuan",false)
			end)
			cellObj:displayObject():runAction(cc.Sequence:create(rotate,callBack,rotate2))
		end,index * 0.125,1)
	end)

	Scheduler.schedule(function()
		if tolua.isnull(self.view) then
			return
		end
		list_reward:setNumItems(#rewardPre)
	end,0.6,1)

end




return ExtraordinarEndLayerView