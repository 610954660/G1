--Name : ExtraordinarBuyView.lua
--Author : generated by FairyGUI
--Date : 2020-3-27
--Desc : 

local ExtraordinarBuyView,Super = class("ExtraordinarBuyView", Window)
function ExtraordinarBuyView:ctor() 
	
	--LuaLog("ExtraordinarBuyView ctor")
	self._packName = "ExtraordinarylevelPvP"
	self._compName = "ExtraordinarBuyView"
	self._rootDepth = LayerDepth.PopWindow
	
	self.cancel=false
	self.buy=false
	self.itemCell=false
	self.tickeLeftTime=false
	self.addNum=1
	--self._rootDepth = LayerDepth.Window
end

function ExtraordinarBuyView:_initEvent()
	self.btn_sub:addClickListener(
        function()
			self.addNum=self.addNum-1
			if self.addNum<=1 then
				self.addNum=1
			end
			self.txt_addNum:setText(self.addNum)
			local configInfo= DynamicConfigData.t_limit[GameDef.GamePlayType.CrossSuperMundane] 
			self.buy:setData({type =configInfo.topupConsume[1].type, code = configInfo.topupConsume[1].code, amount = configInfo.topupConsume[1].amount*self.addNum})
        end
	)
	
	self.btn_add:addClickListener(
		function()
			local configInfo= DynamicConfigData.t_limit[GameDef.GamePlayType.CrossSuperMundane] 
			local max=configInfo.topupMax+VipModel:getVipPrivilige(GameDef.VipPriviligeType.CrossSuperMundaneBuy)
			local copyInfo= ModelManager.MaterialCopyModel:getCopyInfo(GameDef.GamePlayType.CrossSuperMundane)
			local ticketLimit=0
			if copyInfo and copyInfo.dailyInfo and copyInfo.dailyInfo.topup then
				ticketLimit=copyInfo.dailyInfo.topup
			end
			self.addNum=self.addNum+1
			if self.addNum>=max-ticketLimit then
				self.addNum=max-ticketLimit
			end
			self.txt_addNum:setText(self.addNum)
			local configInfo= DynamicConfigData.t_limit[GameDef.GamePlayType.CrossSuperMundane] 
			self.buy:setData({type =configInfo.topupConsume[1].type, code = configInfo.topupConsume[1].code, amount = configInfo.topupConsume[1].amount*self.addNum})
        end
    )

end

function ExtraordinarBuyView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:Arena.ExtraordinarBuyView
		vmRoot.closeButton = viewNode:getChildAutoType("$closeButton")--Label
	--{vmFieldsEnd}:Arena.ExtraordinarBuyView
	--Do not modify above code-------------
end

function ExtraordinarBuyView:_initUI( )
	self:_initVM()
	self.btn_sub=self.view:getChildAutoType("btn_sub")	
	self.btn_add=self.view:getChildAutoType("btn_add")	
	self.txt_addNum=self.view:getChildAutoType("txt_addNum")	
	self.itemCell=self.view:getChildAutoType("itemCell")
	self.cancel=self.view:getChildAutoType("cancel")
	self.buy=self.view:getChildAutoType("buy")
	self.tickeLeftTime=self.view:getChildAutoType("tickeLeftTime")
	self.buy = BindManager.bindCostButton(self.buy)
    self:initData()
end

--初始化数据
function  ExtraordinarBuyView:initData()
	local configInfo= DynamicConfigData.t_limit[GameDef.GamePlayType.CrossSuperMundane] 
	local copyInfo= ModelManager.MaterialCopyModel:getCopyInfo(GameDef.GamePlayType.CrossSuperMundane)
	local ticketLimit=0
	if copyInfo and copyInfo.dailyInfo and copyInfo.dailyInfo.topup then
		ticketLimit=copyInfo.dailyInfo.topup
	end
	self.txt_addNum:setText(self.addNum)
	local itemCellObj 	= BindManager.bindItemCell(self.itemCell)
	itemCellObj:setData(10000118, 1, 3)
	self.tickeLeftTime:setText(string.format( "每日限购%s/%s",ticketLimit,configInfo.topupMax+VipModel:getVipPrivilige(GameDef.VipPriviligeType.CrossSuperMundaneBuy)))
	self.buy:setData({type =configInfo.topupConsume[1].type, code = configInfo.topupConsume[1].code, amount = configInfo.topupConsume[1].amount})
	self.buy:addClickListener(function ()
		local isEnough= PlayerModel:checkCostEnough({type = configInfo.topupConsume[1].type, code = configInfo.topupConsume[1].code, amount = configInfo.topupConsume[1].amount*self.addNum}, true)
		if isEnough then
			ModelManager.MaterialCopyModel:spendForTopup(GameDef.GamePlayType.CrossSuperMundane,self.addNum)
			ViewManager.close("ExtraordinarBuyView")	
		end
	end)
	self.cancel:addClickListener(function ()
			ViewManager.close("ExtraordinarBuyView")
	end)
	self.closeButton:addClickListener(function ()
			ViewManager.close("ExtraordinarBuyView")
	end)
end



return ExtraordinarBuyView