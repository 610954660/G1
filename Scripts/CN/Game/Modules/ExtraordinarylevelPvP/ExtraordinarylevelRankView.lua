--Date :2020-12-26
--Author : generated by FairyGUI
--Desc : 

local ExtraordinarylevelRankView,Super = class("ExtraordinarylevelRankView", Window)

function ExtraordinarylevelRankView:ctor()
	--LuaLog("ExtraordinarylevelRankView ctor")
	self._packName = "ExtraordinarylevelPvP"
	self._compName = "ExtraordinarylevelRankView"
	self._rootDepth = LayerDepth.PopWindow
	
end

function ExtraordinarylevelRankView:_initEvent( )
	
end

function ExtraordinarylevelRankView:_initVM( )
	local viewNode = self.view
	---Do not modify following code--------
	--{autoFields}:ExtraordinarylevelPvP.ExtraordinarylevelRankView
	self.blackBg = viewNode:getChildAutoType('blackBg')--GButton
	self.c1 = viewNode:getController('c1')--Controller
	self.com_myRank = viewNode:getChildAutoType('com_myRank')--Component8
		self.com_myRank.txt_order = viewNode:getChildAutoType('com_myRank/$txt_order')--GRichTextField
		self.com_myRank.duanweidesc = viewNode:getChildAutoType('com_myRank/duanweidesc')--GRichTextField
		self.com_myRank.headItem = viewNode:getChildAutoType('com_myRank/headItem')--GButton
		self.com_myRank.img_duanwei = viewNode:getChildAutoType('com_myRank/img_duanwei')--GLoader
		self.com_myRank.img_myduanwei = viewNode:getChildAutoType('com_myRank/img_myduanwei')--GLoader
		self.com_myRank.myduanweidesc = viewNode:getChildAutoType('com_myRank/myduanweidesc')--GRichTextField
		self.com_myRank.txt_combat = viewNode:getChildAutoType('com_myRank/txt_combat')--GTextField
		self.com_myRank.txt_myRank = viewNode:getChildAutoType('com_myRank/txt_myRank')--GRichTextField
		self.com_myRank.txt_myRankTitle = viewNode:getChildAutoType('com_myRank/txt_myRankTitle')--GTextField
		self.com_myRank.txt_name = viewNode:getChildAutoType('com_myRank/txt_name')--GTextField
	self.frame = viewNode:getChildAutoType('frame')--GLabel
	self.list_rank = viewNode:getChildAutoType('list_rank')--GList
	self.list_type = viewNode:getChildAutoType('list_type')--GList
	--{autoFieldsEnd}:ExtraordinarylevelPvP.ExtraordinarylevelRankView
	--Do not modify above code-------------
end

function ExtraordinarylevelRankView:_initListener( )

end

function ExtraordinarylevelRankView:_initUI( )
	self:_initVM()
	self:_initListener()
	self.list_type:setItemRenderer(
        function(index, obj)
            local title = obj:getChildAutoType("title")
            if index == 0 then
				obj:setSelected(true)
				ExtraordinarylevelPvPModel:getRank(1)
                title:setText("赛区排行")
			else
                title:setText("好友排行")
            end
            obj:removeClickListener(100)
            --池子里面原来的事件注销掉
            obj:addClickListener(
                function(context)
                    if index == 0 then
						ExtraordinarylevelPvPModel:getRank(1)
                    else
						ExtraordinarylevelPvPModel:getRank(2)
                    end
                end,
                100
            )
        end
    )
    self.list_type:setNumItems(2)
end

function ExtraordinarylevelRankView:extraordinarylevelPvP_rankInfoup(_,rank)
	if #rank>0 then
		local myRankInfo={}
		local rankIndex=0
		--TableUtil.sortByMap( rank , { {key="dan",asc=true},{key="score",asc=true}} )
		for i=1 ,#rank,1  do
			local rankItem=rank[i]
			 if rankItem.playerId==PlayerModel.userid then
				myRankInfo=rankItem
				rankIndex=i
			 end
		end
		local myRankc1 = self.com_myRank:getController("c1")
		local myRankc3 = self.com_myRank:getController("c3")
		local playerHead=self.com_myRank:getChildAutoType("headItem");
		local img_myduanwei=self.com_myRank:getChildAutoType("img_myduanwei");
		local myduanweidesc=self.com_myRank:getChildAutoType("myduanweidesc");	
		local txt_myRank=self.com_myRank:getChildAutoType("txt_myRank");	
		local txt_mycombat=self.com_myRank:getChildAutoType("txt_combat");
		local txt_myname=self.com_myRank:getChildAutoType("txt_name");
		if next(myRankInfo) then
			self.com_myRank:setVisible(true)
			myRankc3:setSelectedIndex(0)
			if rankIndex<=3 then
				myRankc1:setSelectedIndex(rankIndex-1)
			else
				myRankc1:setSelectedIndex(3)
			end
			txt_myRank:setText(rankIndex) 
				local dan=myRankInfo.dan or 1
				img_myduanwei:setURL(ExtraordinarylevelPvPModel:getDanIcon(dan))--段位图标
				local desc = ExtraordinarylevelPvPModel:getDanChinese(dan)--段位文字
				myduanweidesc:setText(desc)
				if myRankInfo.name==nil then 
					txt_myname:setText("")
				else
					txt_myname:setText(myRankInfo.name.."")
				end
				local  combat=myRankInfo.combat or 0
				txt_mycombat:setText(Desc.materialCopy_str5.." "..StringUtil.transValue(combat))
				local heroItem = BindManager.bindPlayerCell(playerHead)
				heroItem:setHead(myRankInfo.head, myRankInfo.level,nil,nil,myRankInfo.headBorder)
				playerHead:removeClickListener(100)
				playerHead:addClickListener(
				function(...)
					ViewManager.open("ViewPlayerView",{playerId = myRankInfo.playerId,serverId = myRankInfo.serverId})
				end,100)
		else
			self.com_myRank:setVisible(false)
			myRankc1:setSelectedIndex(3)
			myRankc3:setSelectedIndex(1)
		end
		local myRankc2 = self.com_myRank:getController("c2")
		myRankc2:setSelectedIndex(1)

		self.c1:setSelectedIndex(0)
		self.list_rank:setVirtual()
		self.list_rank:setItemRenderer(
			function(index, obj) 
			local serverInfo=rank[index+1]
			local c1 = obj:getController("c1")
			local c2 = obj:getController("c2")
			c2:setSelectedIndex(0)
			if index<=2 then
				c1:setSelectedIndex(index)
			else
				c1:setSelectedIndex(3)
			end
			local txt_order=obj:getChildAutoType("$txt_order");	
			txt_order:setText(index+1) 
			local txt_name=obj:getChildAutoType("txt_name");
			if serverInfo.name==nil then 
				txt_name:setText("")
			else
				txt_name:setText(serverInfo.name.."")
			end
			local txt_combat=obj:getChildAutoType("txt_combat");
			local  combat=serverInfo.combat or 0
			txt_combat:setText(Desc.materialCopy_str5.." "..StringUtil.transValue(combat))
			local playerHead=obj:getChildAutoType("headItem");
			local heroItem = BindManager.bindPlayerCell(playerHead)
			heroItem:setHead(serverInfo.head, serverInfo.level,nil,nil,serverInfo.headBorder)
			playerHead:removeClickListener(100)
			playerHead:addClickListener(
			function(...)
				ViewManager.open("ViewPlayerView",{playerId = serverInfo.playerId,serverId = serverInfo.serverId})
			end,100
		)
			local dan=serverInfo.dan or 1--ExtraordinarylevelPvPModel:getDanByscore(serverInfo.score)
			local img_duanwei=obj:getChildAutoType("img_duanwei");
			local duanweidesc=obj:getChildAutoType("duanweidesc");	
			img_duanwei:setURL(ExtraordinarylevelPvPModel:getDanIcon(dan))--段位图标
			local desc = ExtraordinarylevelPvPModel:getDanChinese(dan)--段位文字
			duanweidesc:setText(desc)
			end
		)
		self.list_rank:setNumItems(#rank)
	else
		self.c1:setSelectedIndex(1)
	end
end


return ExtraordinarylevelRankView