--Date :2020-12-30
--Author : generated by FairyGUI
--Desc : 个人战绩界面

local ExtraordinaryPersonalrecordView, Super = class("ExtraordinaryPersonalrecordView", Window)

function ExtraordinaryPersonalrecordView:ctor()
    --LuaLog("ExtraordinaryPersonalrecordView ctor")
    self._packName = "ExtraordinarylevelPvP"
    self._compName = "ExtraordinaryPersonalrecordView"
    self._rootDepth = LayerDepth.PopWindow
end

function ExtraordinaryPersonalrecordView:_initEvent()
end

function ExtraordinaryPersonalrecordView:_initVM()
    local viewNode = self.view
    ---Do not modify following code--------
    --{autoFields}:ExtraordinarylevelPvP.ExtraordinaryPersonalrecordView
	self.blackBg = viewNode:getChildAutoType('blackBg')--GButton
	self.c1 = viewNode:getController('c1')--Controller
	self.c2 = viewNode:getController('c2')--Controller
	self.c3 = viewNode:getController('c3')--Controller
	self.cardItem = viewNode:getChildAutoType('cardItem')--GButton
	self.fight = viewNode:getChildAutoType('fight')--GRichTextField
	self.frame = viewNode:getChildAutoType('frame')--GLabel
	self.list_sortType = viewNode:getChildAutoType('list_sortType')--GList
	self.list_type = viewNode:getChildAutoType('list_type')--GList
	self.lszgjifeng = viewNode:getChildAutoType('lszgjifeng')--GRichTextField
	self.playerhero = viewNode:getChildAutoType('playerhero')--GButton
	self.txt_cgshenglv = viewNode:getChildAutoType('txt_cgshenglv')--GRichTextField
	self.txt_changguisaishengchang = viewNode:getChildAutoType('txt_changguisaishengchang')--GRichTextField
	self.txt_duanwei = viewNode:getChildAutoType('txt_duanwei')--GRichTextField
	self.txt_heroname = viewNode:getChildAutoType('txt_heroname')--GRichTextField
	self.txt_jifen = viewNode:getChildAutoType('txt_jifen')--GRichTextField
	self.txt_lishizuigao = viewNode:getChildAutoType('txt_lishizuigao')--GRichTextField
	self.txt_maxhurt = viewNode:getChildAutoType('txt_maxhurt')--GRichTextField
	self.txt_playname = viewNode:getChildAutoType('txt_playname')--GRichTextField
	self.txt_playscore = viewNode:getChildAutoType('txt_playscore')--GRichTextField
	self.txt_saiqu = viewNode:getChildAutoType('txt_saiqu')--GRichTextField
	self.txt_sjpm = viewNode:getChildAutoType('txt_sjpm')--GRichTextField
	self.txt_wzssc = viewNode:getChildAutoType('txt_wzssc')--GRichTextField
	self.txt_wzssl = viewNode:getChildAutoType('txt_wzssl')--GRichTextField
	self.txt_zdlss = viewNode:getChildAutoType('txt_zdlss')--GRichTextField
 --{autoFieldsEnd}:ExtraordinarylevelPvP.ExtraordinaryPersonalrecordView
    --Do not modify above code-------------
end

function ExtraordinaryPersonalrecordView:_initListener()
    self.list_type:setItemRenderer(
        function(index, obj)
            local title = obj:getChildAutoType("title")
            if index == 0 then
                ExtraordinarylevelPvPModel:getSelfResults(1, 0, 0)
                obj:setSelected(true)
                self.c1:setSelectedIndex(0)
                title:setText("总战绩")
            else
                title:setText("赛季战绩")
            end
            obj:removeClickListener(100)
            --池子里面原来的事件注销掉
            obj:addClickListener(
                function(context)
					if index == 0 then
						ExtraordinarylevelPvPModel:getSelfResults(1, 0, 0)
                        self.c1:setSelectedIndex(0)
                    else
                        self:showList(1)
                        self.c1:setSelectedIndex(1)
                    end
                end,
                100
            )
        end
    )
    self.list_type:setNumItems(2)
end

function ExtraordinaryPersonalrecordView:showList(type)
    local seasonId = ExtraordinarylevelPvPModel:getCurseasonId()
    if type == 1 then
        self.list_sortType:setItemRenderer(
            function(index, obj)
                local title = obj:getChildAutoType("title")
                printTable(159, "qqqqqqqqqqq", index)
                title:setText("S" .. string.format("%s赛季", index + 1))
                obj:removeClickListener(100) --池子里面原来的事件注销掉
                obj:addClickListener(
                    function(context)
                        ExtraordinarylevelPvPModel:getSelfResults(2, index + 1, 0)
                    end,
                    100
                )
                if index + 1 == seasonId then
                    ExtraordinarylevelPvPModel:getSelfResults(2, seasonId, 0)
                    obj:setSelected(true)
                    self.list_sortType:scrollToView(seasonId - 1, false, false)
                end
            end
        )
        self.list_sortType:setNumItems(seasonId)
    end
end

function ExtraordinaryPersonalrecordView:extraordinarylevelPvP_gerenzongzhanji(_, record) --总战绩刷新
    if next(record) == nil then
        return
    end
    local duanweiMing = ExtraordinarylevelPvPModel:getDanChinese(record.dan)
    self.txt_duanwei:setText(duanweiMing)
    self.txt_jifen:setText(record.score)
    local mundName = ExtraordinarylevelPvPModel:getSuperMundName(record.assignId)
    self.txt_saiqu:setText(mundName)

    self.txt_changguisaishengchang:setText(record.maxWinNum)
    if record.maxTotal == 0 then
        self.txt_cgshenglv:setText("0%")
    else
        self.txt_cgshenglv:setText(math.ceil((record.maxWinNum / record.maxTotal * 100)) .. "%")
    end
    self.txt_maxhurt:setText(record.maxHeroDamage)
    local maxDan = ExtraordinarylevelPvPModel:getDanChinese(record.maxDan)
    self.txt_lishizuigao:setText(maxDan)
    self.lszgjifeng:setText(record.maxScore)
    self.txt_sjpm:setText(record.maxRank)
    self.txt_wzssc:setText(record.maxKingNum)
    if record.maxKingTotal == 0 then
        self.txt_wzssl:setText("0%")
    else
        self.txt_wzssl:setText(math.ceil((record.maxKingNum / record.maxKingTotal * 100)) .. "%")
    end
    self.txt_zdlss:setText(record.maxThenWin)

    if record.maxMvpHero and record.maxMvpHero~=0 then
        self.c2:setSelectedIndex(0)
        local bindCard = BindManager.bindCardCell(self.cardItem)
        bindCard:setData(record.maxMvpHero, true)
        bindCard:setLevel(-1)
        local heroConfig = DynamicConfigData.t_hero[record.maxMvpHero]
        self.cardItem:removeClickListener()
        self.cardItem:addClickListener(
            function()
                local conf = DynamicConfigData.t_HeroTotems
                local arr = conf[heroConfig.category]
                local h = false
                for _, d in pairs(arr) do
                    if (d.hero == record.maxMvpHero) then
                        h = d
                        break
                    end
                end
                local info = {index = 1, heroId = record.maxMvpHero, heroList = {h}}
                ViewManager.open("HeroInfoView", info)
            end
        )
        self.txt_heroname:setText(heroConfig.heroName)
    else
        self.c2:setSelectedIndex(1)
    end
    if record.maxPkPlayer and next(record.maxPkPlayer) then
        self.c3:setSelectedIndex(0)
        local heroItem = BindManager.bindPlayerCell(self.playerhero)
        heroItem:setHead(record.maxPkPlayer.head, record.maxPkPlayer.level, nil, nil, record.maxPkPlayer.headBorder)
        self.txt_playname:setText(record.maxPkPlayer.name)
        self.fight:setText(record.maxPkPlayer.combat)
        self.txt_playscore:setText(record.maxPkPlayer.score)
    else
        self.c3:setSelectedIndex(1)
    end
end

function ExtraordinaryPersonalrecordView:extraordinarylevelPvP_gerenzhanji(_, record)
    if next(record) == nil then
        self.txt_duanwei:setText("无")
        self.txt_lishizuigao:setText("无") 
        self.txt_jifen:setText("0") 
        self.lszgjifeng:setText("0") 
        self.txt_saiqu:setText("无") 
        self.txt_sjpm:setText("无") 
        self.txt_changguisaishengchang:setText("0")   
        self.txt_wzssc:setText("0") 
        self.txt_cgshenglv:setText("0%")       
        self.txt_wzssl:setText("0%")     
        self.txt_maxhurt:setText("0")         
        self.txt_zdlss:setText("0")    
        self.c2:setSelectedIndex(1)  
        self.c3:setSelectedIndex(1)          
        return
    end

    local seasonId = ExtraordinarylevelPvPModel:getCurseasonId()
    if seasonId~=record.season then
        local duanweiMing = ExtraordinarylevelPvPModel:getDanChinese(record.dan)
        self.txt_duanwei:setText(duanweiMing)
        self.txt_jifen:setText(record.score)
        local mundName = ExtraordinarylevelPvPModel:getSuperMundName(record.assignId)
        self.txt_saiqu:setText(mundName)
    
        self.txt_changguisaishengchang:setText(record.maxWinNum or 0)
        if record.maxTotal == 0 then
            self.txt_cgshenglv:setText("0%")
        else
            local shenglv=record.maxWinNum/record.maxTotal
            self.txt_cgshenglv:setText(math.ceil((shenglv * 100)) .. "%")
        end
        self.txt_maxhurt:setText(record.maxHeroDamage)
        local maxDan = ExtraordinarylevelPvPModel:getDanChinese(record.maxDan)
        self.txt_lishizuigao:setText(maxDan)
        self.lszgjifeng:setText(record.maxScore)
        self.txt_sjpm:setText(record.maxRank)
        self.txt_wzssc:setText(record.maxKingNum or 0)
        if record.maxKingTotal == 0 then
            self.txt_wzssl:setText("0%")
        else
            self.txt_wzssl:setText(math.ceil((record.maxKingNum or 0 / record.maxKingTotal * 100)) .. "%")
        end
        self.txt_zdlss:setText(record.maxThenWin)
        if record.maxMvpHero and record.maxMvpHero~=0  then
            self.c2:setSelectedIndex(0)
            local bindCard = BindManager.bindCardCell(self.cardItem)
            bindCard:setData(record.maxMvpHero, true)
            bindCard:setLevel(-1)
            local heroConfig = DynamicConfigData.t_hero[record.maxMvpHero]
            self.cardItem:removeClickListener()
            self.cardItem:addClickListener(
                function()
                    local conf = DynamicConfigData.t_HeroTotems
                    local arr = conf[heroConfig.category]
                    local h = false
                    for _, d in pairs(arr) do
                        if (d.hero == record.maxMvpHero) then
                            h = d
                            break
                        end
                    end
                    local info = {index = 1, heroId = record.maxMvpHero, heroList = {h}}
                    ViewManager.open("HeroInfoView", info)
                end
            )
            self.txt_heroname:setText(heroConfig.heroName)
        else
            self.c2:setSelectedIndex(1)
        end
        if record.maxPkPlayer and next(record.maxPkPlayer) then
            self.c3:setSelectedIndex(0)
            local heroItem = BindManager.bindPlayerCell(self.playerhero)
            heroItem:setHead(record.maxPkPlayer.head, record.maxPkPlayer.level, nil, nil, record.maxPkPlayer.headBorder)
            self.txt_playname:setText(record.maxPkPlayer.name)
            self.fight:setText(record.maxPkPlayer.combat)
            self.txt_playscore:setText(record.maxPkPlayer.score)
        else
            self.c3:setSelectedIndex(1)
        end
    else
        local duanweiMing = ExtraordinarylevelPvPModel:getDanChinese(record.dan)
        self.txt_duanwei:setText(duanweiMing)
        self.txt_jifen:setText(record.score)
        local mundName = ExtraordinarylevelPvPModel:getSuperMundName(record.assignId)
        self.txt_saiqu:setText(mundName)
    
        self.txt_changguisaishengchang:setText(record.winNum or 0)
        if record.total == 0 then
            self.txt_cgshenglv:setText("0%")
        else
            self.txt_cgshenglv:setText(math.ceil((record.winNum or 0 / record.total * 100)) .. "%")
        end
        self.txt_maxhurt:setText(record.heroDamage)
        local maxDan = ExtraordinarylevelPvPModel:getDanChinese(record.maxDan)
        self.txt_lishizuigao:setText(maxDan)
        self.lszgjifeng:setText(record.maxScore)
        self.txt_sjpm:setText(record.rank)
        self.txt_wzssc:setText(record.kingNum)
        if record.kingTotal == 0 then
            self.txt_wzssl:setText("0%")
        else
            self.txt_wzssl:setText(math.ceil((record.kingNum or 0 / record.kingTotal * 100)) .. "%")
        end
        self.txt_zdlss:setText(record.maxThenWin)
        if record.maxMvpHero and record.maxMvpHero~=0  then
            self.c2:setSelectedIndex(0)
            local bindCard = BindManager.bindCardCell(self.cardItem)
            bindCard:setData(record.maxMvpHero, true)
            bindCard:setLevel(-1)
            local heroConfig = DynamicConfigData.t_hero[record.maxMvpHero]
            self.cardItem:removeClickListener()
            self.cardItem:addClickListener(
                function()
                    local conf = DynamicConfigData.t_HeroTotems
                    local arr = conf[heroConfig.category]
                    local h = false
                    for _, d in pairs(arr) do
                        if (d.hero == record.maxMvpHero) then
                            h = d
                            break
                        end
                    end
                    local info = {index = 1, heroId = record.maxMvpHero, heroList = {h}}
                    ViewManager.open("HeroInfoView", info)
                end
            )
            self.txt_heroname:setText(heroConfig.heroName)
        else
            self.c2:setSelectedIndex(1)
        end
        if record.maxPkPlayer and next(record.maxPkPlayer) then
            self.c3:setSelectedIndex(0)
            local heroItem = BindManager.bindPlayerCell(self.playerhero)
            heroItem:setHead(record.maxPkPlayer.head, record.maxPkPlayer.level, nil, nil, record.maxPkPlayer.headBorder)
            self.txt_playname:setText(record.maxPkPlayer.name)
            self.fight:setText(record.maxPkPlayer.combat)
            self.txt_playscore:setText(record.maxPkPlayer.score)
        else
            self.c3:setSelectedIndex(1)
        end
    end

  
end

function ExtraordinaryPersonalrecordView:_initUI()
    self:_initVM()
    self:_initListener()
end

return ExtraordinaryPersonalrecordView
