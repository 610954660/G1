--Date :2020-12-30
--Author : generated by FairyGUI
--Desc :

local ExtraordinaryKingView, Super = class("ExtraordinaryKingView", Window)

function ExtraordinaryKingView:ctor()
    --LuaLog("ExtraordinaryKingView ctor")
    self._packName = "ExtraordinarylevelPvP"
    self._compName = "ExtraordinaryKingView"
    self._rootDepth = LayerDepth.PopWindow
    self.calltimer = false
end

function ExtraordinaryKingView:_initEvent()
end

function ExtraordinaryKingView:_initVM()
    local viewNode = self.view
    ---Do not modify following code--------
    --{autoFields}:ExtraordinarylevelPvP.ExtraordinaryKingView
	self.List_reward = viewNode:getChildAutoType('$List_reward')--GList
	self.img_banner = viewNode:getChildAutoType('$img_banner')--GButton
	self.btn_help = viewNode:getChildAutoType('btn_help')--GButton
	self.btn_play = viewNode:getChildAutoType('btn_play')--Component16
		self.btn_play.img_duanwei = viewNode:getChildAutoType('btn_play/img_duanwei')--GLoader
	self.frame = viewNode:getChildAutoType('frame')--GLabel
	self.txt_countdowm = viewNode:getChildAutoType('txt_countdowm')--GTextField
	self.txt_desc = viewNode:getChildAutoType('txt_desc')--GRichTextField
 --{autoFieldsEnd}:ExtraordinarylevelPvP.ExtraordinaryKingView
    --Do not modify above code-------------
end

function ExtraordinaryKingView:_initUI()
    self:_initVM()
    local mainInfo = ExtraordinarylevelPvPModel:getMainInfo()
    if next(mainInfo) == nil then
        return
    end
    self.lihuiDisplay = BindManager.bindLihuiDisplay(self.img_banner)
    self.lihuiDisplay:setData(45009, nil, true,nil)
    local winNum = ExtraordinarylevelPvPModel.wangzhezhizhengInfo.winNum or 0
    self.txt_desc:setText(string.format("段位赛达到指定胜场解锁超值奖励(当前胜场:%s)", ColorUtil.formatColorString1(winNum, "#6AFF60")))
    self.starInfo = ExtraordinarylevelPvPModel:getWangzhezhizhengconfigInfo(true)
    self.List_reward:setVirtual()
    self:showActiveTime()
    self:isshowPlayBtn()
    self.List_reward:setItemRenderer(
        function(index, obj)
            local winNum = ExtraordinarylevelPvPModel.wangzhezhizhengInfo.winNum or 0
			local lingquMap = ExtraordinarylevelPvPModel.wangzhezhizhengInfo.danKingReward or {}
            local itemInfo = self.starInfo[index + 1]
            local txt_shengcahng = obj:getChildAutoType("txt_shengcahng")
            txt_shengcahng:setText(string.format("胜场%s场", itemInfo.victoryTimes))
            local gCtr1 = obj:getController("c1")
            local info = lingquMap[itemInfo.id] or {}
            local putongindex = true
             --false是已领取后端奇葩的设定
            if info.state == nil then
                putongindex = true
            else
                putongindex = info.state
            end
            local speciaIndex = true
            if info.bugState == nil then
                speciaIndex = true
            else
                speciaIndex = info.bugState
            end
            local hasMoeny = false
            if ExtraordinarylevelPvPModel.wangzhezhizhengInfo.buyDanKing == true then
                hasMoeny = true
            end
            if winNum < itemInfo.victoryTimes then
                gCtr1:setSelectedIndex(0)
            else
                if hasMoeny==false then
                    if putongindex == true and speciaIndex == true then
                        gCtr1:setSelectedIndex(1)
                    elseif putongindex == false and speciaIndex == true then
                        gCtr1:setSelectedIndex(2)
                    elseif putongindex == false and speciaIndex == false then
                        gCtr1:setSelectedIndex(3)
                    end
                else
                    if putongindex == true and speciaIndex == true then
                        gCtr1:setSelectedIndex(1)
                    elseif putongindex == false and speciaIndex == true then
                        gCtr1:setSelectedIndex(1)
                    elseif putongindex == false and speciaIndex == false then
                        gCtr1:setSelectedIndex(3)
                    end
                end
            end
            local list_ordinary = obj:getChildAutoType("list_ordinary")
            local list_specia = obj:getChildAutoType("list_specia")
            list_ordinary:setItemRenderer(
                function(index, rewardObj)
                    local reewardItemC = rewardObj:getController("c1")
                    if putongindex == false then
                        reewardItemC:setSelectedIndex(1)
                    else
                        reewardItemC:setSelectedIndex(0)
                    end
                    rewardObj:removeClickListener(100)
                    --池子里面原来的事件注销掉
                    local itemMode = rewardObj:getChildAutoType("itemCell")
                    local itemcell = BindManager.bindItemCell(itemMode)
                    local award = itemInfo.freeitem[index + 1]
                    itemcell:setData(award.code, award.amount, award.type)
                end
            )
            list_ordinary:setNumItems(#itemInfo.freeitem)
            list_specia:setItemRenderer(
                function(index, rewardObj)
                    local reewardItemC = rewardObj:getController("c1")
                    if speciaIndex == false then
                        reewardItemC:setSelectedIndex(1)
                    else
                        reewardItemC:setSelectedIndex(0)
                    end
                    rewardObj:removeClickListener(100)
                    --池子里面原来的事件注销掉
                    local itemMode = rewardObj:getChildAutoType("itemCell")
                    local itemcell1 = BindManager.bindItemCell(itemMode)
                    local award = itemInfo.payitem[index + 1]
                    itemcell1:setData(award.code, award.amount, award.type)
                end
            )
            list_specia:setNumItems(#itemInfo.payitem)

        
            local btn_ordinary = obj:getChildAutoType("btn_ordinary")
            local btn_specia = obj:getChildAutoType("btn_specia")
            if hasMoeny==false then
                btn_ordinary:removeClickListener(100)
                btn_ordinary:addClickListener(
                    function(context)
                        if winNum < itemInfo.victoryTimes then
                            RollTips.show(Desc.activity_txt8)
                        else
                            ExtraordinarylevelPvPModel:receiveDanKingReward(itemInfo.id, 1)
                        end
                    end,
                    100
                )
                btn_specia:removeClickListener(100)
                btn_specia:addClickListener(
                    function(context)
                        if hasMoeny == false and speciaIndex == true then
                            ViewManager.open("ExtraordinaryKingbountyView")
                        elseif hasMoeny == true and speciaIndex == true then
                            ExtraordinarylevelPvPModel:receiveDanKingReward(itemInfo.id, 1)
                        end
                    end,
                    100
                )
            else
                btn_ordinary:removeClickListener(100)
                btn_ordinary:addClickListener(
                    function(context)
                        if winNum < itemInfo.victoryTimes then
                            RollTips.show(Desc.activity_txt8)
                        else
                            ExtraordinarylevelPvPModel:receiveDanKingReward(itemInfo.id, 1)
                            ExtraordinarylevelPvPModel:receiveDanKingReward(itemInfo.id, 1)
                        end
                    end,
                    100
                )
            end
        end
    )
    self.List_reward:setNumItems(#self.starInfo) --
end

function ExtraordinaryKingView:showActiveTime()
    local mainInfo = ExtraordinarylevelPvPModel:getMainInfo()
    if next(mainInfo) == nil then
        return
    end
    local serverTime = ServerTimeModel:getServerTime()
    local lastTime = mainInfo.endTime - serverTime
    if lastTime > 0 then
        self.txt_countdowm:setText(TimeLib.GetTimeFormatDay(lastTime, 2))
        local function onCountDown(time)
            self.txt_countdowm:setText(TimeLib.GetTimeFormatDay(time, 2))
        end
        local function onEnd(...)
            self.txt_countdowm:setText("未开启")
        end
        if self.calltimer then
            TimeLib.clearCountDown(self.calltimer)
        end
        self.calltimer = TimeLib.newCountDown(lastTime, onCountDown, onEnd, false, false, false)
    else
        self.txt_countdowm:setText("未开启")
    end
end

--事件初始化
function ExtraordinaryKingView:_initEvent(...)
    self.btn_play:addClickListener(
        function(...)
            ViewManager.open("ExtraordinaryKingbountyView")
        end
    )

    self.btn_help:addClickListener(
        function(...)
           local info={}
            info['title']=Desc["help_StrTitleWzzz"]
            info['desc']=Desc["help_StrDescWzzz"]
            ViewManager.open("GetPublicHelpView",info) 
        end
    )
end

function ExtraordinaryKingView:extraordinarylevelPvP_wangzhezhizheng()
    self.starInfo = ExtraordinarylevelPvPModel:getWangzhezhizhengconfigInfo(true)
    self.List_reward:setNumItems(#self.starInfo)
    self:isshowPlayBtn()
    local winNum = ExtraordinarylevelPvPModel.wangzhezhizhengInfo.winNum or 0
    self.txt_desc:setText(string.format("段位赛达到指定胜场解锁超值奖励(当前胜场:%s)", ColorUtil.formatColorString1(winNum, "#6AFF60")))
end

function ExtraordinaryKingView:isshowPlayBtn()
    if ExtraordinarylevelPvPModel.wangzhezhizhengInfo.buyDanKing == true then
        self.btn_play:setVisible(false)
    else
        self.btn_play:setVisible(true)
    end
end

function ExtraordinaryKingView:_exit()
    if self.calltimer then
        TimeLib.clearCountDown(self.calltimer)
    end
end

return ExtraordinaryKingView
