--Date :2020-12-24
--Author : generated by FairyGUI
--Desc : 

local FullsrGiftModel = class("FullsrGift", BaseModel)

function FullsrGiftModel:ctor()

	self.fullsrGiftData={}
	self.moduleId=1
	self.giftData={}
	self.haveReward={}
	
end

function FullsrGiftModel:init()
	--RedManager.updateValue("V_ACTIVITY_"..GameDef.ActivityType.ServerGroupBuy.."_"..1,true)
end


function FullsrGiftModel:initData(data)
	if data and data.serverGroupBuy then
		self.fullsrGiftData= data.serverGroupBuy or {}
	end

	--self.prayCount=table.nums(self.RuneActiveData)+1
	printTable(5656,"data 全服礼包数据",data)
	
	
	local acConfig=ActivityModel:getActityByType(GameDef.ActivityType.ServerGroupBuy)
	if acConfig then
		self.moduleId= acConfig.showContent.moduleId or 1
	end
	self.moduleId=self:getModuleId()
	self:setFullsrGiftDataCfg()

	--if data.fromLogin then
		--Dispatcher.dispatchEvent(EventType.TwistRuneView_refresh)
	--end
	--self:redCheck()
	Dispatcher.dispatchEvent(EventType.update_FullsrGiftData)
end


function FullsrGiftModel:redCheck()
	GlobalUtil.delayCallOnce("EquipTargetModel:redCheck",function()
			self:updateRed()
	end, self, 0.2)
end




function FullsrGiftModel:setFullsrGiftDataCfg()
	
	if TableUtil.GetTableLen(self.giftData) == 0 then
		self.giftData = DynamicConfigData.t_ServerGroupBuy[self.moduleId]
	end
	local keyArr1 = {}
	
	--printTable(5656,self.giftData,"self.giftData")
	
	self.haveReward={}
	for i, v in pairs(self.giftData) do
		local data = {config = v, progress = 0} --保留有时间的时候改一下不修改配置字段
		--local keyArr2 = {}
		--v.state=0
		--if self.fullsrGiftData[v.id].hasBuy then
			--v.state=2
		--end
		self.haveReward[i]=false
	
		local claimFreeReward={}
		local claimPayReward={}
		v.progress=0
		if self.fullsrGiftData[v.id] then
			v.hasBuy=self.fullsrGiftData[v.id].hasBuy
			v.progress=self.fullsrGiftData[v.id].progress
		    claimFreeReward=self.fullsrGiftData[v.id].claimFreeReward or {}
			claimPayReward=self.fullsrGiftData[v.id].claimPayReward  or {}
		end
		
		
		
		
		v.freeState={}
		
		for k, dropData in pairs(v.timesToFreeRewardId) do
			v.freeState[k]=0
			if claimFreeReward[dropData.count] then
				v.freeState[k]=2
			elseif v.progress>=dropData.count then
				v.freeState[k]=1
				self.haveReward[i]=true
			end	
		end
		v.payState={}
		for k, dropData in pairs(v.timesToPayRewardId) do
			v.payState[k]=0
			if claimPayReward[dropData.count] then
				v.payState[k]=2
			elseif v.progress>=dropData.count and v.hasBuy then
				v.payState[k]=1
				self.haveReward[i]=true
			end
		end
		table.insert(keyArr1, "V_ACTIVITY_"..GameDef.ActivityType.ServerGroupBuy.."_".. i)
		--RedManager.addMap("V_ACTIVITY_"..GameDef.ActivityType.RuneMission .. i, keyArr2)
	end
	table.insert(keyArr1, "V_ACTIVITY_OPEN_"..GameDef.ActivityType.ServerGroupBuy)
	RedManager.addMap("V_ACTIVITY_"..GameDef.ActivityType.ServerGroupBuy, keyArr1)
	self:updateRed()
end


function FullsrGiftModel:getFullsrGiftDataCfg()
	local keysValus = {}
	
	if TableUtil.GetTableLen(self.giftData) == 0 then
		self:setFullsrGiftDataCfg()
	end
	
	for k, v in pairs(self.giftData) do
		table.insert(keysValus,k)
	end

	table.sort(keysValus,function (a,b)
			return a<b
		end)
	return self.giftData
end

-- 获取模板id
function FullsrGiftModel:getModuleId()
	local moduleId = 1
	local actData = ModelManager.ActivityModel:getActityByType(GameDef.ActivityType.ServerGroupBuy)
	moduleId = actData and actData.showContent.moduleId or 1
	printTable(5656,"模块Id",moduleId)
	return moduleId
end


function FullsrGiftModel:updateRed()
	--local _cost = self:getCostData()
	--local num= PlayerModel:getMoneyByType(GameDef.MoneyType.GodsPrayCoin)
	
	RedManager.updateValue("V_ACTIVITY_OPEN_"..GameDef.ActivityType.ServerGroupBuy,not self:isActiveHadOpen())
	for k, v in pairs(self.haveReward) do
		RedManager.updateValue("V_ACTIVITY_"..GameDef.ActivityType.ServerGroupBuy.."_"..k,v)
		if v then
			RedManager.updateValue("V_ACTIVITY_OPEN_"..GameDef.ActivityType.ServerGroupBuy,true)
		end
	end

end



function FullsrGiftModel:serverGroupBuy(params,finished)


	--local params = {
		--giftId		=data,  -- 1:integer #要领取的奖励对应的配置id
		--rewardType  =data, -- 2:integer #1：免费奖励 2：付费奖励
		--progress    =data,-- 3:boolean #领取是哪个进度的奖励
	--}
	local function onSuccess (data )
		--self.rewardId=data.rewardId
		print(5656,"全服礼包领取奖励",data)
		if finished then
			finished()
		end
	end

	printTable(5656,"领奖请求数据",params)
	RPCReq.Activity_ServerGroupBuy_OnClaimReward(params, onSuccess)
end




function FullsrGiftModel:setActvieOpen(isOpen)
	FileCacheManager.setBoolForKey(PlayerModel.userid.."V_ACTIVITY_OPEN_"..GameDef.ActivityType.GodsPray,isOpen,false,false)
end

--查看是否全部设置成静态立绘
function FullsrGiftModel:isActiveHadOpen()
	return FileCacheManager.getBoolForKey(PlayerModel.userid.."V_ACTIVITY_OPEN_"..GameDef.ActivityType.GodsPray,false,false,false)
end




return FullsrGiftModel
