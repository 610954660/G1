--Name : PushMapWorldMapView.lua
--Author : generated by FairyGUI
--Date : 2020-4-9
--Desc : 

local PushMapWorldMapView,Super = class("PushMapWorldMapView", Window)
function PushMapWorldMapView:ctor()
	self._packName = "PushMap"
	self._compName = "PushMapWorldMapView"
	self._rootDepth = LayerDepth.Window
	self.worldMapPanel=false
	self.mapItem={}
	self.task=false;
	self.tweenerTag=false;
	self.tweenId=false
	self._updateTimeId=false
	self.guochangyun=false
	self.shijiedituAni=false
	self.cityAni={}
end

function PushMapWorldMapView:_initEvent( )
	
end

--添加红点
function PushMapWorldMapView:_addRed(...)
	local img_red=self.task:getChild('img_red')
    RedManager.register("M_BTN_TASK", img_red, ModuleId.PushMap.id)
end

function PushMapWorldMapView:pushMap_updateCityInfo( )
	printTable(9,"刷新城市的通关章节信息返回")
	for i = 1, 9, 1 do
		if self.mapItem[i] then
			self:setCityBtnInfo(self.mapItem[i],i)
		end
	end
end

function PushMapWorldMapView:_initVM( )
	PushMapModel:getOldCityBattleData();
end

function PushMapWorldMapView:_initUI( )
	self:_initVM()
	self.img_ani=self.view:getChildAutoType("img_ani")
	self.mapList=self.view:getChildAutoType("mapList")
	 self.img_worldPic=self.mapList:getChild('img_worldPic')
	self.img_animation=self.view:getChild('img_animation')
	self.task=self.view:getChild("btn_task")
	self.img_worldPic:getChild('icon'):setURL(PushMapModel:getWorldMapBg())
	--self:setBg("pusMapWorldMap.jpg")
	self.mapList:setVisible(false)
	self.task:setVisible(false)
	self.guochangyun= SpineUtil.createSpineObj(self.img_animation,{x=0,y=0}, "animation", "Effect/UI", "Ef_guochangyun", "Ef_guochangyun",false) 
	self.guochangyun:setCompleteListener(function(name)
		printTable(21,"asdffffffff")
		   end)
	  self._updateTimeId = Scheduler.scheduleOnce(0.5,function()
		self._updateTimeId=false
			if not self.shijiedituAni then
				self.shijiedituAni=PushMapModel:getworldMapAnim(self.img_ani)
			end
			self.shijiedituAni:setScale(1)
			self.task:setVisible(true)
			  self.mapList:setVisible(true)
		  end)
	for i = 1, 9, 1 do
		local key="city_"..i
		 local item =self.mapList:getChild(key)
		if item then
			self.mapItem[i]=item
			self:setCityBtnInfo(item,i)
			item:addClickListener(function ()
				if PushMapModel:getCurMaxCityOpen(i) then
					if self.tweenerTag==false then
						self.tweenerTag=true;
						self:zoomInto(item,i)
					end
				else
					RollTips.show('当前城市未开启')
				end
			end)
		end
	end

	-- self.map1:removeClickListener();
	-- self.map2:removeClickListener();
	-- self.map3:removeClickListener();
	-- self.map4:removeClickListener();
	-- self.map5:removeClickListener();
	self.task:addClickListener(function()
		ViewManager.open("TaskView")     
		end)
	local btnHelp = self.view:getChildAutoType("btn_help")
	btnHelp:addClickListener(function()
		local info={}
		info['title']=Desc.help_StrTitle1
		info['desc']=Desc.help_StrDesc1
		ViewManager.open("GetPublicHelpView",info) 
		end)
end

function PushMapWorldMapView:setCityBtnInfo(mapBtn,cityId)
	local hasRed=PushMapModel:getPushMapcityRed(cityId)
	local imgred=mapBtn:getChildAutoType("img_red")
	imgred:setVisible(hasRed)
	local gCtr=mapBtn:getController("c1")
	local configInfo=DynamicConfigData.t_chapters[cityId][1];
	local txt_cityname=mapBtn:getChildAutoType('txt_cityname');
	local img_anilan=mapBtn:getChildAutoType('img_anilan');
	local img_anihuang=mapBtn:getChildAutoType('img_anihuang');
	txt_cityname:setText(configInfo.cyname);
		if PushMapModel:getCurMaxCityOpen(cityId) then
			if cityId==PushMapModel.pushMaponHookInfo.chapterCity then
				gCtr:setSelectedIndex(2)
				if not self.cityAni[cityId] then
					printTable(31,"qqqqqqqqqqqqqqqqq",cityId,PushMapModel.pushMaponHookInfo.chapterCity)
					self.cityAni[cityId]=PushMapModel:getworldMapHuangAnim(img_anihuang)
				end
			else
				gCtr:setSelectedIndex(0)
				if not self.cityAni[cityId] then
					self.cityAni[cityId]=PushMapModel:getworldMapLanAnim(img_anilan)--已挑战过的特效蓝光
				end
			end
			local txt_star=mapBtn:getChildAutoType('txt_star')
			local cityInfo=PushMapModel.pushMapWorldcityInfo[cityId]
			local star=0;
			local configStar=PushMapModel:getWorldMapAllStar(cityId) ;
			printTable(9,'>>>>>>>>',configStar,cityInfo)
			if cityInfo~=nil then
				star=cityInfo.starTotal;
				configStar=cityInfo.starCfg;
			end
			 txt_star:setText(ColorUtil.formatColorString1(star,"#6AFF60").."/"..configStar)
		else
			SpineUtil.clearEffect(self.cityAni[cityId])
			gCtr:setSelectedIndex(1)
		end
end

function PushMapWorldMapView:zoomInto(btn,cityId)
	btn:setScale(1,1)
	local from= btn:localToGlobal(Vector2.zero)
	local MapWidth=fgui.GRoot:getInstance():getViewWidth()
	local MapHeight=fgui.GRoot:getInstance():getViewHeight()
	local iPivotX = from.x / MapWidth;
	local iPivotY = from.y / MapHeight;

	self.mapList:setPivot(iPivotX,iPivotY,false)
	self.tweenId =fgui.GTween:to({x = 1, y = 1}, {x = 2, y = 2, }, 1.6)
	:setEase(7)
	self.tweenId:onUpdate(
	function(tweener)
		self.mapList:setScale(tweener:getDeltaValue():getVec2().x, tweener:getDeltaValue():getVec2().y)
	end
)
self.tweenId:onComplete(
	function()
		printTable(11,'当前的城市',cityId)
		self.shijiedituAni:setScale(1.2)
	    if  self.tweenId then
			self.tweenId:kill();
			self.tweenId = nil
	   end
		self.tweenerTag=false;
		self.mapList:setPivot(0.5,0.5,false)
		self.mapList:setScale(1, 1)
		PushMapModel:getOldBattleData(cityId);
		ViewManager.close("PushMapWorldMapView");
		ViewManager.open("PushMapChaptersView",{cityId=cityId});
	end
)
	-- local a1= fgui.GTween:to(self.mapList:getPosition(),targetPos,1)
	-- a1:setEase(7)
	-- a1:onUpdate(function(tweener)
	-- 		if tolua.isnull(self.view) then
	-- 			return
	-- 		end
	-- 		self.mapList:setPosition(tweener:getDeltaValue():getVec2().x,tweener:getDeltaValue():getVec2().y)
	-- 	end
	-- )
	-- a1:onComplete(function ()
	-- 		if tolua.isnull(self.view) then
	-- 			return
	-- 		end
	-- end)
	
	-- local a2= fgui.GTween:toDouble(1,2,1)
	-- a2:setEase(7)
	-- a2:onUpdate(function(tweener)
	--        if tolua.isnull(self.view) then
	--      return
	-- end
	-- self.mapList:setScale(tweener:getDeltaValue():getD(),tweener:getDeltaValue():getD())
	--     end
	-- )
	-- a2:onComplete(function ()
	--       if tolua.isnull(self.view) then
	--         return
	-- 	   end
	--        Scheduler.schedule(function()
	-- 				if tolua.isnull(self.view) then
	-- 					return
	-- 				end
	-- 				self.mapList:setScale(1,1)
	-- 				self.mapList:setPosition(self.initPos.x,self.initPos.y)
	-- 		end,0.5,1)
	-- 		PushMapModel:getOldBattleData(1);
	-- 		ViewManager.open("PushMapChaptersView",{1});
	-- end)
end



function PushMapWorldMapView:showMap(id)
	print(4,"需要显示的图块",id)
end


function PushMapWorldMapView:hideMap(id)
	print(4,"需要隐藏的图块",id)
end


function PushMapWorldMapView:_exit()
	if  self.tweenId then
		 printTable(10,'>>>>>>>>>>>>123132123')
		 self.tweenId:kill();
		 self.tweenId = nil
		-- printTable(9,'>>>>>>>>>>>>123132123',self.tag,tag)
		-- fgui.GTween:kill(tag)
	end
	SpineUtil.clearEffect(self.cityAni)
	SpineUtil.clearEffect(self.shijiedituAni)
	SpineUtil.clearEffect(self.guochangyun)
    Scheduler.unschedule(self._updateTimeId)
end




return PushMapWorldMapView