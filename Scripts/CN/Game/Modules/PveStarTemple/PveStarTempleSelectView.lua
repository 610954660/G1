--Name : PveStarTempleSelectView.lua
--Author : generated by FairyGUI
--Date : 2020-7-28
--Desc : 

local PveStarTempleSelectView,Super = class("PveStarTempleSelectView", Window)

function PveStarTempleSelectView:ctor()
	--LuaLog("PveStarTempleSelectView ctor")
	self._packName = "PveStarTemple"
	self._compName = "PveStarTempleSelectView"
	self._rootDepth = LayerDepth.PopWindow
	--self._rootDepth = LayerDepth.Window
	self.cateGory = 1
	self.sortOrder = 1
	self.heroData = false
	self.cateGoryList = false
	self.selectHeroData = false
end

function PveStarTempleSelectView:_initEvent( )
	
end

function PveStarTempleSelectView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:PveStarTemple.PveStarTempleSelectView
		--{vmFieldsEnd}:PveStarTemple.PveStarTempleSelectView
	--Do not modify above code-------------
end

function PveStarTempleSelectView:_initUI( )
	self:_initVM()
	self.btnArray = self.view:getChildAutoType("btnArray")
	self.btnStart = self.view:getChildAutoType("btnStart")
	self.btnHelp = self.view:getChildAutoType("btn_help")
	self.heroList = self.view:getChildAutoType("heroList")
	self.txtCapacity = self.view:getChildAutoType("txtCapacity")
	self.sortOrderList = self.view:getChildAutoType("sortOrderList")
	self.selectHeroData = {}
	self.cateGoryList = {}
	local list = self.view:getChildAutoType("cateGoryList")
	for i = 1,6 do
		self.cateGoryList[i] = list:getChildAutoType("category"..(i - 1))
		self.cateGoryList[i]:addClickListener(function()
			self:onCateGoryClick(i)
		end,1)
	end

	self.btnArray:addClickListener(function()
		self:onBtnArrayClick()
	end,1)

	self.btnStart:addClickListener(function()
		self:onBtnStartClick()
	end,1)

	self.btnHelp:addClickListener(function()
		self:onBtnHelpClick()
	end,1)

	self.heroList:setVirtual()
	self.heroList:setItemRenderer(function(index,obj)
		self:heroListRenderer(index,obj)
	end)

	self.sortOrderList:setItemRenderer(function(index,obj)
		self:sortOrderListRenderer(index,obj)
	end)

	self:updateSortOrderList()
	self:updateCateGoryList()
	self:updateHeroList(true,true)
end

function PveStarTempleSelectView:_exit()
	self.cateGory = false
	self.heroData = false
	self.selectHeroData = false
	self.cateGoryList = false
	self.sortOrder = false
end

function PveStarTempleSelectView:updateHeroList(needSort,needUpdate)
	if not self.heroData or needUpdate then
		self.heroData = ModelManager.PveStarTempleModel:getCardsByCategory(self.cateGory - 1)
	end

	if self.sortOrder and needSort then
		table.sort(self.heroData,function(a,b)
			local aValue = false
			local bValue = false
			if self.sortOrder == 1 then--品质
				aValue = a.combat
				bValue = b.combat
			elseif self.sortOrder == 2 then--等级
				aValue = a.level
				bValue = b.level
			elseif self.sortOrder == 3 then--战力
				aValue = a.star
				bValue = b.star
			end

			if aValue == bValue then
				if a.code == b.code then
					return a.uuid > b.uuid
				end
				return a.code < b.code
			end

			return aValue > bValue
		end)
	end

	self.heroList:setNumItems(#self.heroData)

	local capacity = 0
	for k,v in pairs(self.selectHeroData) do
		capacity = capacity + v.combat
	end

	self.txtCapacity:setText(StringUtil.transValue(capacity))
end

function PveStarTempleSelectView:updateCateGoryList()
	for i = 1,6 do
		self.cateGoryList[i]:getController("button"):setSelectedIndex(0)
	end

	self.cateGoryList[self.cateGory]:getController("button"):setSelectedIndex(1)
end

function PveStarTempleSelectView:updateSortOrderList()
	self.sortOrderList:setNumItems(3)
end

function PveStarTempleSelectView:heroListRenderer(index,obj)
	local cardItem = obj:getChildAutoType("cardItem")
	local heroCell = BindManager.bindCardCell(cardItem)
	local isSelected = self:isHeroSelected(self.heroData[index + 1])
	local heroData =
	{
		heroId = self.heroData[index + 1].code,
		fashion = {code = self.heroData[index + 1].fashion},
		heroStar = self.heroData[index + 1].star,
		level = self.heroData[index + 1].level,
		category = self.heroData[index + 1].category,
	}

	heroCell:setData(heroData)
	cardItem:getController("c1"):setSelectedIndex(isSelected and 2 or 0)
	obj:getController("select"):setSelectedIndex(isSelected and 1 or 0)
	obj:addClickListener(function (context)
		self:onHeroClick(index + 1,obj)
	end,1)
end

local orderText = {DescAuto[217],DescAuto[218],DescAuto[219],DescAuto[220]} -- [217]="战力" -- [218]="等级" -- [219]="品质" -- [220]="获取"
function PveStarTempleSelectView:sortOrderListRenderer(index,obj)
	local isSelected = index + 1 == self.sortOrder
	obj:setTitle(orderText[index + 1])
	obj:getController("button"):setSelectedIndex(isSelected and 1 or 0)

	if not isSelected then
		obj:setScale(1,1)
	end

	obj:addClickListener(function()
		self:onSortOrderClick(index + 1)
	end,1)
end

function PveStarTempleSelectView:onBtnArrayClick()
	if #self.selectHeroData >= 6 then
		return
	end

	for i = 1,6 do
		if i > #self.heroData then
			break
		end

		if not self:isHeroSelected(self.heroData[i]) then
			self:addSelectHero(self.heroData[i])
		end
	end

	self:updateHeroList()
end

function PveStarTempleSelectView:onBtnStartClick()
	if #self.selectHeroData < 1 then
		RollTips.show(DescAuto[221]) -- [221]="需先选择上阵探员"
		return
	end

	if #self.selectHeroData < 6 then
		local info = {
			text=DescAuto[222], -- [222]="当前上阵探员未满，是否确定？"
			type="yes_no",
			onYes= function()
				self:setSelectHero()
			end,
		}
		Alert.show(info)
		return
	end

	self:setSelectHero()
end

function PveStarTempleSelectView:onBtnHelpClick()
	local info={}
	info['title'] = Desc["help_StrTitle72"]
	info['desc'] = Desc["help_StrDesc72"]
	ViewManager.open("GetPublicHelpView",info)
end

function PveStarTempleSelectView:setSelectHero()
	ModelManager.PveStarTempleModel:setSelectHero(self.selectHeroData)
	self:closeView()
	ViewManager.open("PveStarTempleMainView")
end

function PveStarTempleSelectView:onHeroClick(index,obj)
	local isSelected = self:isHeroSelected(self.heroData[index])
	if not isSelected then
		self:addSelectHero(self.heroData[index])
	else
		self:removeSelectHero(self.heroData[index])
	end

	self:updateHeroList()
end

function PveStarTempleSelectView:onCateGoryClick(index)
	if self.cateGory ~= index then
		self.cateGory = index
		self:updateHeroList(true,true)
		self:updateCateGoryList()
	end
end

function PveStarTempleSelectView:onSortOrderClick(index)
	self.sortOrder = index
	self:updateHeroList(true,false)
	self:updateSortOrderList()
end

function PveStarTempleSelectView:isHeroSelected(heroData)
	for k,v in pairs(self.selectHeroData) do
		if v.code == heroData.code and v.uuid == heroData.uuid then
			return true
		end
	end

	return false
end

function PveStarTempleSelectView:addSelectHero(heroInfo)
	if #self.selectHeroData < 6 then
		table.insert(self.selectHeroData,heroInfo)
	end
end

function PveStarTempleSelectView:removeSelectHero(heroInfo)
	for k,v in pairs(self.selectHeroData) do
		if v.code == heroInfo.code and v.uuid == heroInfo.uuid then
			table.remove(self.selectHeroData,k)
			break
		end
	end
end

return PveStarTempleSelectView
