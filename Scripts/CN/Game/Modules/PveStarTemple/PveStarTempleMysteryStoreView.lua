--Name : PveStarTempleMysteryStoreView.lua
--Author : generated by FairyGUI
--Date : 2020-7-28
--Desc : 

local PveStarTempleMysteryStoreView,Super = class("PveStarTempleMysteryStoreView", Window)

function PveStarTempleMysteryStoreView:ctor()
	--LuaLog("PveStarTempleMysteryStoreView ctor")
	self._packName = "PveStarTemple"
	self._compName = "PveStarTempleMysteryStoreView"
	self._rootDepth = LayerDepth.PopWindow
	self.isMap = self._args.isMap
	self.areaID = self._args.areaID or false
	self.pos = self._args.pos or false
	self.goodsData = false
end

function PveStarTempleMysteryStoreView:_initEvent( )
	
end

function PveStarTempleMysteryStoreView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:PveStarTemple.PveStarTempleMysteryStoreView
		--{vmFieldsEnd}:PveStarTemple.PveStarTempleMysteryStoreView
	--Do not modify above code-------------
end

function PveStarTempleMysteryStoreView:_initUI( )
	self:_initVM()
	self.itemList = self.view:getChildAutoType("itemList")

	self.itemList:setItemRenderer(function(index,obj)
		self:itemListRenderer(index,obj)
	end)

	self.view:getChildAutoType("n13"):setURL(PathConfiger.getPveStarTempleBG("mystery_frame"))
	self.view:getChildAutoType("n11"):setURL(PathConfiger.getPveStarTempleBG("mystery_role"))
	self:updateItemList()
end

function PveStarTempleMysteryStoreView:_exit()
	self.isMap = false
	self.areaID = false
	self.pos = false
	self.goodsData = false
end

function PveStarTempleMysteryStoreView:updateItemList()
	self.goodsData = ModelManager.PveStarTempleModel:getMysteryShop()
	self.itemList:setNumItems(#self.goodsData)
	self.itemList:resizeToFit(#self.goodsData)
end

function PveStarTempleMysteryStoreView:itemListRenderer(index,obj)
	local goodsID = self.goodsData[index + 1].goodsId
	local config = DynamicConfigData.t_PveStarTempleMallConfig[6][goodsID]
	local itemCell = BindManager.bindItemCell(obj:getChildAutoType("itemCell"))
	local btnBuy = obj:getChildAutoType("btnBuy")
	local isBuy = self.goodsData[index + 1].buy == 1
	local txtItemName = obj:getChildAutoType("txtItemName")
	local priceIcon = obj:getChildAutoType("priceIcon")
	local txtPrice = obj:getChildAutoType("txtPrice")

	itemCell:setData(config.item[1].code,config.item[1].amount,config.item[1].type)
	itemCell:setAmount(config.item[1].amount)
	itemCell:setIsShowName(false)
	txtItemName:setText(itemCell:getItemData():getName())
	priceIcon:setURL(PathConfiger.getMoneyIcon(config.price[1].code))
	txtPrice:setText(MathUtil.toSectionStr(config.price[1].amount))
	btnBuy:addClickListener(function()
		self:onBtnBuyClick(index + 1)
	end,101)

	obj:getController("showRate"):setSelectedIndex(1)
	obj:getChildAutoType("txtRate"):setText(string.format(DescAuto[214],config.rate/10)) -- [214]="%s折"
	obj:getController("sellOut"):setSelectedIndex(isBuy and 1 or 0)
end

function PveStarTempleMysteryStoreView:onBtnBuyClick(index)
	local goodsID = self.goodsData[index].goodsId
	local config = DynamicConfigData.t_PveStarTempleMallConfig[6][goodsID]
	local priceItemData = ItemsUtil.createItemData({data = config.price[1]})
	local priceConfigData = DynamicConfigData.t_item[priceItemData:getItemCode()]
	local goodsItemData = DynamicConfigData.t_item[config.item[1].code]

	local info = {
		text = string.format(DescAuto[215],MathUtil.toSectionStr(config.price[1].amount),priceConfigData.name,goodsItemData.name), -- [215]="是否花费%s%s购买%s？"
		type="yes_no",
		onYes= function()
			Alert.closeAll()
			local money = ModelManager.PlayerModel:getMoneyByType(config.price[1].code)
			if money < config.price[1].amount then
				RollTips.show(string.format(DescAuto[216],priceConfigData.name)) -- [216]="%s不足"
				return
			end
			self:onBuy(index)
			Alert.closeAll()
		end,
	}
	Alert.show(info)
end

function PveStarTempleMysteryStoreView:onBuy(index)
	local uuid = self.goodsData[index].uuid
	if self.isMap then
		Dispatcher.dispatchEvent(EventType.PveStarTemple_EevntUse,{areaID = self.areaID,pos = self.pos,param1 = uuid})
	else
		Dispatcher.dispatchEvent(EventType.PveStarTemple_BuyMall,uuid)
	end
end

return PveStarTempleMysteryStoreView
