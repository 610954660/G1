--Name : PveStarTempleAcidView.lua
--Author : generated by FairyGUI
--Date : 2020-7-28
--Desc :
local PveStarTempleAcidView,Super = class("PveStarTempleAcidView", Window)

function PveStarTempleAcidView:ctor()
	--LuaLog("PveStarTempleAcidView ctor")
	self._packName = "PveStarTemple"
	self._compName = "PveStarTempleAcidView"
	self._rootDepth = LayerDepth.PopWindow
	self.currSelectBossIndex = false
	self.remainBossData = false
end

function PveStarTempleAcidView:_initEvent( )

end

function PveStarTempleAcidView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:PveStarTemple.PveStarTempleAcidView
		--{vmFieldsEnd}:PveStarTemple.PveStarTempleAcidView
	--Do not modify above code-------------
end

function PveStarTempleAcidView:_initUI( )
	self:_initVM()
	self.itemCell = BindManager.bindItemCell(self.view:getChildAutoType("itemCell"))
	self.txtItemName = self.view:getChildAutoType("txtItemName")
	self.txtItemDesc = self.view:getChildAutoType("txtItemDesc")
	self.txtRoundTime = self.view:getChildAutoType("txtRoundTime")
	self.txtItemCount = self.view:getChildAutoType("txtItemCount")
	self.bossList = self.view:getChildAutoType("bossList")
	--self.btnConfirm = self.view:getChildAutoType("btnConfirm")
	--self.btnCancel = self.view:getChildAutoType("btnCancel")

	self.bossList:setItemRenderer(function(index,obj)
		self:bossListRenderer(index,obj)
	end)

	--self.btnConfirm:addClickListener(function()
	--	self:onBtnConfirmClick()
	--end)
	--
	--self.btnCancel:addClickListener(function()
	--	self:onBtnCancelClick()
	--end)

	self:updateBossList()
	self:updateItemCell()
end

function PveStarTempleAcidView:_exit()
	self.currSelectBossIndex = false
	self.remainBossData = false
end

function PveStarTempleAcidView:updateBossList()
	self.remainBossData = ModelManager.PveStarTempleModel:getRemainBoss()
	self.bossList:setNumItems(#self.remainBossData)
end

function PveStarTempleAcidView:updateItemCell()
	local starTempleItem = DynamicConfigData.t_PveStarTempleItemConfig[3][2]
	local itemConfigData  = DynamicConfigData.t_item[starTempleItem.item[1].code]
	local amount = ModelManager.PackModel:getItemsFromAllPackByCode(starTempleItem.item[1].code)
	local useCount = ModelManager.PveStarTempleModel:getItemUseCount(itemConfigData.code)
	local useLimit = ModelManager.PveStarTempleModel:getItemUseLimit(itemConfigData.code)
	self.itemCell:setData(starTempleItem.item[1].code,starTempleItem.item[1].amount,starTempleItem.item[1].type)
	self.itemCell:setAmount(0)
	self.txtItemName:setText(itemConfigData.name)
	self.txtItemDesc:setText(itemConfigData.descStr)
	self.txtRoundTime:setText(useLimit-useCount)
	self.txtItemCount:setText(amount)
end

function PveStarTempleAcidView:bossListRenderer(index,obj)
	local fightID = self.remainBossData[index + 1].data.monster
	local areaID = self.remainBossData[index + 1].data.area
	local isBeated = self.remainBossData[index + 1].isBeated
	local fightData = DynamicConfigData.t_fight[fightID]
	local data = ModelManager.PveStarTempleModel:getBossData(fightID,fightData.monsterStand[1],areaID)

	local heroCell = BindManager.bindHeroCell(obj:getChildAutoType("heroCell"))
	heroCell:setData(data)
	heroCell:setShowHp(false)
	heroCell.grayCtrl:setSelectedIndex(0)
	--obj:getController("state"):setSelectedPage(self.currSelectBossIndex == index + 1 and "on" or "out")
	obj:getController("isBeated"):setSelectedIndex(isBeated and 1 or 0)
	obj:getController("showName"):setSelectedIndex(1)
	obj:getChildAutoType("txtBossName"):setText(DynamicConfigData.t_monster[data.code].name)
	obj:addEventListener(FUIEventType.Click,function (context)
		self:onBossClick(index + 1)
	end,1)
end

function PveStarTempleAcidView:onBossClick(index)
	local areaID = self.remainBossData[index].data.area
	local isBeated = self.remainBossData[index].isBeated

	print(999,"使用王水",#self.remainBossData,areaID)
	if ModelManager.PveStarTempleModel:getRemainBossCount() > 1 and areaID == 5 then
		RollTips.show("先打败其他boss可以对层主使用该道具")
		return
	end

	if isBeated then
		RollTips.show("该boss已经击败")
		return
	end

	self.currSelectBossIndex = index
	self:onBtnConfirmClick()
	--self:updateBossList()
end

function PveStarTempleAcidView:onBtnConfirmClick()
	if not self.currSelectBossIndex then
		RollTips.show("请选择一个对象")
		return
	end

	local itemCode = DynamicConfigData.t_PveStarTempleItemConfig[3][2].item[1].code
	local amount = ModelManager.PackModel:getItemsFromAllPackByCode(itemCode)
	local pack = ModelManager.PackModel:getPackByType(GameDef.BagType.PveStarTemple):getItemsByCode(itemCode)
	local useCount = ModelManager.PveStarTempleModel:getItemUseCount(itemCode)
	local useLimit = ModelManager.PveStarTempleModel:getItemUseLimit(itemCode)

	if amount < 1 then
		RollTips.show("数量不足")
		return
	end

	if useLimit - useCount < 1 then
		RollTips.show("使用次数不足")
		return
	end

	local areaID = self.remainBossData[self.currSelectBossIndex].data.area
	ModelManager.PveStarTempleModel:updateItemUseList({code = itemCode,count = useCount + 1})
	Dispatcher.dispatchEvent(EventType.PveStarTemple_ItemUse,{itemID = pack[1].__data.id,amount = 1,ex = areaID})
	RollTips.show("使用成功")
end

function PveStarTempleAcidView:onBtnCancelClick()
	self:closeView()
end

return PveStarTempleAcidView