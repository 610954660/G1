-- local Desc = require "cn.configs.desc"
--Date :2020-12-23
--Author : generated by FairyGUI
--Desc : 

local SecretWeaponTaskView,Super = class("SecretWeaponTaskView", Window)

function SecretWeaponTaskView:ctor()
	--LuaLog("SecretWeaponTaskView ctor")
	self._packName = "SecretWeapons"
	self._compName = "SecretWeaponTaskView"
	self._rootDepth = LayerDepth.PopWindow
    self.secretWeaponId = false
    self.gotNum = 0
    self.taskInfo = {}
	self.godArmsMissionInfo = {}
	self.selectedTabIndex = 0 
end

function SecretWeaponTaskView:_initEvent( )
	self.btn_seeAttr:addClickListener(function()
		ViewManager.open("SecretWeaponAddattrView", {type = 1, id = self.secretWeaponId})
	end)

	self.btn_task:addClickListener(function()
		self.c1:setSelectedIndex(0)
		self:setTaskList()
	end)

	self.btn_task1:addClickListener(function()
		self.c1:setSelectedIndex(1)
		self:setBuyView()
	end)
	

	self.btn_buy:addClickListener(function()
		local config = DynamicConfigData.t_godArmsTrigger[self.secretWeaponId]
		if config then
			local price= config.price or 128
			ModelManager.RechargeModel:directBuy(price, GameDef.StatFuncType.SFT_GodArms, self.secretWeaponId, "秘武购买",nil, "秘武购买")
			self:closeView()
		end
	end)

	self.btn_Active:addClickListener(function()
			local params = {}
		params.id = self.secretWeaponId
		params.onSuccess = function (args)
			ViewManager.close("SecretWeaponTaskView")
			ViewManager.open("SecretWeaponStrainView", {id = self.secretWeaponId})
			ViewManager.open("SecretWeaponsGetView",{id = self.secretWeaponId})
		end
		printTable(6,"激活秘武params",params)
		RPCReq.GodArms_TriggerGodArms(params,params.onSuccess)
	end)
end

function SecretWeaponTaskView:_initVM( )
	local viewNode = self.view
	---Do not modify following code--------
	--{autoFields}:SecretWeapons.SecretWeaponTaskView
	self.btn_seeAttr = viewNode:getChildAutoType('$btn_seeAttr')--GButton
	self.img_equip = viewNode:getChildAutoType('$img_equip')--GLoader
	self.skillCel = viewNode:getChildAutoType('$skillCel')--GButton
	self.txt_name = viewNode:getChildAutoType('$txt_name')--GRichTextField
	self.blackBg = viewNode:getChildAutoType('blackBg')--GButton
	self.btn_Active = viewNode:getChildAutoType('btn_Active')--GButton
	self.btn_buy = viewNode:getChildAutoType('btn_buy')--GButton
	self.btn_task = viewNode:getChildAutoType('btn_task')--btn_sortChose
		self.btn_task.img_red = viewNode:getChildAutoType('btn_task/img_red')--GImage
	self.btn_task1 = viewNode:getChildAutoType('btn_task1')--btn_sortChose
		self.btn_task1.img_red = viewNode:getChildAutoType('btn_task1/img_red')--GImage
	self.c1 = viewNode:getController('c1')--Controller
	self.c2 = viewNode:getController('c2')--Controller
	self.frame = viewNode:getChildAutoType('frame')--GLabel
	self.itemCell = viewNode:getChildAutoType('itemCell')--GButton
	self.taskList = viewNode:getChildAutoType('taskList')--GList
	self.txt_buyDesc = viewNode:getChildAutoType('txt_buyDesc')--GRichTextField
	self.txt_progress = viewNode:getChildAutoType('txt_progress')--GTextField
	self.txt_skillDecs = viewNode:getChildAutoType('txt_skillDecs')--GTextField
	self.txt_skillName = viewNode:getChildAutoType('txt_skillName')--GTextField
	--{autoFieldsEnd}:SecretWeapons.SecretWeaponTaskView
	--Do not modify above code-------------
end

--添加红点
function SecretWeaponTaskView:_addRed(...)
	-- RedManager.register("V_SECRETWEAPON_ILLUSION_REWARD", self.btn_task:getChildAutoType("img_red"), 268)
	-- RedManager.register("V_SECRETWEAPON_ILLUSION_ACTIVE", self.btn_task1:getChildAutoType("img_red"), 268)
end


function SecretWeaponTaskView:_initUI( )
	self:_initVM()
    self.secretWeaponId = self._args.id
    local equipurl = SecretWeaponsModel:getEquipById(self.secretWeaponId)
    self.img_equip:setURL(equipurl)
    self.taskInfo = DynamicConfigData.t_godArmsMission[self.secretWeaponId]
    self.gotNum = 0 
    for _,v in ipairs(self.taskInfo) do
    	local taskData = SecretWeaponsModel:getSecretWeaponsTaskInfo(v.taskId)
    	if taskData.got then 
    		self.gotNum = self.gotNum + 1
    	end
	end
	self.txt_buyDesc:setText(Desc.SecretWeapones_progress2)
	self.godArmsMissionInfo = DynamicConfigData.t_godArmsTrigger[self.secretWeaponId]
    self.txt_name:setText(self.godArmsMissionInfo.name)
   	self.txt_skillDecs:setText(self.godArmsMissionInfo.activeDesc)
   	self.txt_progress:setText(string.format(Desc.SecretWeapones_progress1,self.godArmsMissionInfo.name,self.gotNum,#self.taskInfo))
	self:setSkill()
	
	if self.selectedTabIndex==0 then
		self.c1:setSelectedIndex(0)
		self:setTaskList()
	elseif self.selectedTabIndex==1 then
		self.c1:setSelectedIndex(1)
		self:setBuyView( )
	end 
	self:showTaskbtnRed()
	self:showLijijihuoRed()--立即激活红点
end

function SecretWeaponTaskView:task_update( )
	self:showTaskbtnRed()
end

function SecretWeaponTaskView:setSkill( )
	local lv = 1 --写死读level1的技能名字和图标
    local godArmsConfig = DynamicConfigData.t_godArms[self.secretWeaponId]
    if not godArmsConfig[lv] then
        return
    end
    local skillId = godArmsConfig[lv].skillId
    local max = #godArmsConfig
    local conf = DynamicConfigData.t_skill[skillId]
    local cell = BindManager.bindSkillCell(self.skillCel)
    cell:setData(skillId)
   	self.txt_skillName:setText(conf.skillName)
end

function SecretWeaponTaskView:setBuyView( )
	local config=DynamicConfigData.t_GodArmsTrigger[self.secretWeaponId]
	local cost= config.itemCost
	local  price=config.price
	local isEnough=PlayerModel:checkCostEnough(cost[1], false)
	local itemcell = BindManager.bindItemCell(self.itemCell)
	if isEnough then
		self.c2:setSelectedIndex(1)
		local hasNum = ModelManager.PackModel:getItemsFromAllPackByCode(cost[1].code)
		local color = "#FFFFFF"
		if hasNum == 0 then
			color = "#FF6464"
		end
		itemcell:setData(cost[1].code, cost[1].amount, cost[1].type)
		local str = ColorUtil.formatColorString1(MathUtil.toSectionStr(hasNum).."/"..cost[1].amount, color)
		itemcell:setAmountStr(str)
	else
		self.c2:setSelectedIndex(0)
		self.btn_buy:setTitle(price.."元")
		itemcell:setData(cost[1].code, cost[1].amount, cost[1].type)
	end
end

function SecretWeaponTaskView:setTaskList( )
	self.taskList:setItemRenderer(function(idx,obj)
        local index = idx + 1
       	local data  = self.taskInfo[index]
       	local btnCtr  = obj:getController("btnCtr")
       	local title = obj:getChildAutoType("title")
        
       	title:setText(data.name)
       	local itemCell = BindManager.bindItemCell(obj:getChildAutoType("itemCell"))
		itemCell:setData(data.reward[1].code,data.reward[1].amount,data.reward[1].type)
        local btn_get = obj:getChildAutoType("btn_get")
        btn_get:removeClickListener(6)
		btn_get:addClickListener(function( ... )
			local params = {}
			params.id = data.id
			params.recordId = data.taskId
			params.success = function (args)
				self.gotNum = self.gotNum  + 1
   				self.txt_progress:setText(string.format(Desc.SecretWeapones_progress1,self.godArmsMissionInfo.name,self.gotNum,#self.taskInfo))
				if self.gotNum >= #self.taskInfo then 
					ViewManager.close("SecretWeaponTaskView")
					ViewManager.open("SecretWeaponActiveView", {id = data.id})
				end
			end
			RPCReq.GodArms_GetTaskReward(params,params.success)
		end,6)
		obj:getChildAutoType("btn_get/img_red"):setVisible(true)
		local btn_go = obj:getChildAutoType("btn_go")
        btn_go:removeClickListener(6)
		btn_go:addClickListener(function( ... )
			ModuleUtil.openModule( data.jumpId , true )
			ViewManager.close("SecretWeaponTaskView")
		end,6)
		local taskData = SecretWeaponsModel:getSecretWeaponsTaskInfo(data.taskId)
		local progress = obj:getChildAutoType("progress")
		local needNum = data.count
		local haveNum = taskData.acc or 0
		local corlor = haveNum >= needNum and "#109717" or "#d12121"
		progress:setText(string.format(Desc.SecretWeapones_progress,corlor,haveNum,needNum))
		if taskData.got then 
        	btnCtr:setSelectedIndex(2)
		elseif taskData.finish then
        	btnCtr:setSelectedIndex(1)
        else
        	btnCtr:setSelectedIndex(0)
		end
	end)
	self.taskList:setData(self.taskInfo)
end

function SecretWeaponTaskView:showTaskbtnRed()--任务按钮红点
	local red=false
	for key, data in pairs( self.taskInfo) do
		local taskData = SecretWeaponsModel:getSecretWeaponsTaskInfo(data.taskId)
		 if taskData and taskData.finish and  not taskData.got then
			red=true
			break
		 end
	end
	self.btn_task:getChildAutoType("img_red"):setVisible(red)
end

function SecretWeaponTaskView:showLijijihuoRed()--立即激活红点
	local red=false
	local config=DynamicConfigData.t_GodArmsTrigger[self.secretWeaponId]
	local cost= config.itemCost
	local isEnough=PlayerModel:checkCostEnough(cost[1], false)
	if isEnough then
		red=true
	end
	self.btn_task1:getChildAutoType("img_red"):setVisible(red)
end

function SecretWeaponTaskView:SecretWeapons_reward()
	self.taskList:setNumItems(#self.taskInfo)
end

return SecretWeaponTaskView