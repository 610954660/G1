--Name : SecretWeaponDeployView.lua
--Author : generated by FairyGUI
--Date : 2020-7-28
--Desc : 

local SecretWeaponDeployView,Super = class("SecretWeaponDeployView", Window)

function SecretWeaponDeployView:ctor()
	--LuaLog("SecretWeaponDeployView ctor")
	self._packName = "SecretWeapons"
	self._compName = "SecretWeaponDeployView"
	self._rootDepth = LayerDepth.PopWindow
	self.curChooseIndex=false
end

function SecretWeaponDeployView:_initEvent( )
	
end

function SecretWeaponDeployView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:SecretWeapons.SecretWeaponDeployView
		vmRoot.btn_rename = viewNode:getChildAutoType("$btn_rename")--component
		vmRoot.list_choose = viewNode:getChildAutoType("$list_choose")--list
		vmRoot.equip_1 = viewNode:getChildAutoType("$equip_1")--
		vmRoot.list_btnname = viewNode:getChildAutoType("$list_btnname")--list
		vmRoot.equip_2 = viewNode:getChildAutoType("$equip_2")--
		vmRoot.equip_3 = viewNode:getChildAutoType("$equip_3")--
	--{vmFieldsEnd}:SecretWeapons.SecretWeaponDeployView
	--Do not modify above code-------------
end

function SecretWeaponDeployView:_initUI( )
	self:_initVM()
	self:setBg("SecretWeaponsMain.jpg")
	printTable(28,"wpppppppppp",SecretWeaponsModel.chooseInfo)
	self.curChooseIndex=SecretWeaponsModel:getFanganChoosedIndex()
	self:showBtnList()
	self:showThreeItem()
	self:showEquipList()
end

function SecretWeaponDeployView:showThreeItem()
	for i = 1, 3, 1 do
		local item=	self.view:getChildAutoType("$equip_"..i)
		local c1=item:getController("c1")
		local c2=item:getController("c2")
		local equipIdMap= SecretWeaponsModel.chooseInfo[self.curChooseIndex]
		c2:setSelectedIndex(0)
		if not equipIdMap then
			c1:setSelectedIndex(1)
		end
		local txt_name=  item:getChildAutoType("txt_name")
		local img_equip= item:getChildAutoType("img_equip")
		local btn_exit= item:getChildAutoType("btn_exit")
		if equipIdMap and equipIdMap[i] then
			local id=equipIdMap[i]
			local equipurl = SecretWeaponsModel:getEquipById(id)
			img_equip:setURL(equipurl)
			local huihe=SecretWeaponsModel:getDeployHuihe(equipIdMap,i)
			txt_name:setText(DescAuto[241]..ColorUtil.formatColorString1(huihe,"#6AFF60") ..DescAuto[242]) -- [241]="第" -- [242]="回合释放"
			c1:setSelectedIndex(2)
			else
			txt_name:setText(DescAuto[243]) -- [243]="请先配置秘武"
			c1:setSelectedIndex(1)
		end

		img_equip:removeClickListener(100)	--池子里面原来的事件注销掉
		img_equip:addClickListener(
		   function(context)
			SecretWeaponsModel:deleteChooseItem(self.curChooseIndex,equipIdMap[i])--删除选中
			self:showThreeItem()
			self:upList()
		   end
	   ,100)
		btn_exit:removeClickListener(100)	--池子里面原来的事件注销掉
			btn_exit:addClickListener(
			   function(context)
				SecretWeaponsModel:deleteChooseItem(self.curChooseIndex,equipIdMap[i])--删除选中
				self:showThreeItem()
				self:upList()
			   end
		   ,100)
	end
end

function SecretWeaponDeployView:showBtnList()
	self.list_btnname:setItemRenderer(
		function(index, obj)
			local c1=obj:getController("c1")
			local txt_index=obj:getChildAutoType("txt_index")
			local txt_desc=obj:getChildAutoType("txt_desc")
			local state=SecretWeaponsModel:getDeployBtnName(index+1)
			if state==1 then
				c1:setSelectedIndex(0)
				txt_index:setText(DescAuto[244]) -- [244]="新增方案"
			else
				if state.name then--有命名
					txt_desc:setText(state.name)
					c1:setSelectedIndex(2)
				else
					txt_desc:setText(DescAuto[245]) -- [245]="默认方案"
					c1:setSelectedIndex(1)
				end
				txt_index:setText(index+1)
			end
			if self.curChooseIndex==index+1 then
				obj:setSelected(true)
			end
			obj:removeClickListener(100)	--池子里面原来的事件注销掉
			obj:addClickListener(
			   function(context)
				self.curChooseIndex=index+1
				self:showThreeItem()
				self:showEquipList()
			   end
		   ,100)
	
        end
    )
	self.list_btnname:setNumItems(3)
end

function SecretWeaponDeployView:showEquipList( )
	local configInfo=DynamicConfigData.t_godArmsTrigger
	self.list_choose:setItemRenderer(
		function(index, obj)
			local item=configInfo[index+1]
			local id=item.id
			local name=item.name
			local c1=obj:getController("c1")
			local choose=obj:getController("choose")
			local img_equip=obj:getChildAutoType("img_equip")
			local equipurl = SecretWeaponsModel:getEquipById(id)
			img_equip:setURL(equipurl)
			local txt_name=obj:getChildAutoType("txt_name")
			txt_name:setText(name)
			local lv= SecretWeaponsModel:getEquipSkillLv(id)
			local txt_lv=obj:getChildAutoType("txt_lv")
			txt_lv:setText(DescAuto[246]..lv) -- [246]="技能点"
			local config= DynamicConfigData.t_godArms[id]
			local txt_desc=obj:getChildAutoType("txt_desc")
			if lv==0 then
				txt_desc:setText(config[1].round..DescAuto[247]) -- [247]="回合"
			else
				txt_desc:setText(config[lv].round..DescAuto[247]) -- [247]="回合"
			end
			local isOpen= SecretWeaponsModel:getEquipOpen(id)
			if isOpen then
				c1:setSelectedIndex(0)
			else
				c1:setSelectedIndex(1)
			end
			local isChoose=SecretWeaponsModel:getFanganChoosed(self.curChooseIndex,id)
			if isChoose then
				choose:setSelectedIndex(1)
			else
				choose:setSelectedIndex(0)
			end
			local btn_touch = obj:getChildAutoType("btn_touch")
			btn_touch:removeClickListener(100)
			--池子里面原来的事件注销掉
			btn_touch:addClickListener(
			   function(context)
				if isOpen then
					 local num=SecretWeaponsModel:getChooseItemNum(self.curChooseIndex)
					 if num<=3 then
						local indexMap= SecretWeaponsModel.chooseInfo[self.curChooseIndex]
						local Chooseindex=0
						if indexMap then
							Chooseindex=SecretWeaponsModel:isChooseIdex(indexMap,id)
						end
						if  Chooseindex==0 then
							choose:setSelectedIndex(1)
							SecretWeaponsModel:setChooseItem(self.curChooseIndex,id)--添加选中	
							self:showThreeItem()
						else
							choose:setSelectedIndex(0)
							SecretWeaponsModel:deleteChooseItem(self.curChooseIndex,id)--删除选中
							self:showThreeItem()
						end
					 else
						RollTips.show(DescAuto[248]) -- [248]="最多选择3个秘武"
					 end
				else
					RollTips.show(DescAuto[249]) -- [249]="未激活"
				end
			   end
		   ,100)
			local btn_seeAttr= obj:getChildAutoType("btn_seeAttr")
			btn_seeAttr:removeClickListener(100)
			btn_seeAttr:addClickListener(
				function(context)
					ViewManager.open("SecretWeaponStrainView", {id=id})
				end
			,100)

        end
    )
    self.list_choose:setNumItems(#configInfo)
end

function SecretWeaponDeployView:upList()
	local configInfo=DynamicConfigData.t_godArmsTrigger
    self.list_choose:setNumItems(#configInfo)
end

function SecretWeaponDeployView:secretWeapons_fangangaiming()--改名刷新
	self:showBtnList()
end

function SecretWeaponDeployView:secretWeapons_fanganChoose()--方案选择
	self:showBtnList()
end

function SecretWeaponDeployView:secretWeapons_fanganxiugai()--方案修改
	self:showBtnList()
	self:showThreeItem()
	self:showEquipList()
end

--事件初始化
function SecretWeaponDeployView:_initEvent(...)
	self.btn_rename:addClickListener(
        function(context)
			ViewManager.open("SecretWeaponRenameView",{id=self.curChooseIndex}) 
        end
    )
end

function SecretWeaponDeployView:_exit()
	printTable(28,"wwwwwwwwwwwwwwwwwwwww",self.curChooseIndex,SecretWeaponsModel.chooseInfo)
	local info={}
	local map= SecretWeaponsModel.chooseInfo
	for key, value in pairs(map) do
		local list= info[key]
		if not list then
			list={}
		end
		local name=SecretWeaponsModel:getDeployBtnName(key)
		if name==1 then
			name=""
		else
			name=name.name
		end
		list["index"]=key
		list["name"]=name
		list["records"]=value
		info[key]=list
	end
	printTable(29,"wwwwwwwwwwwwwwwwwwwwws111",self.curChooseIndex)
	SecretWeaponsModel:godArmsChangePlans(info)
	SecretWeaponsModel:godArmsChoiceIndex(self.curChooseIndex)
end




return SecretWeaponDeployView
