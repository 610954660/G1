--Name : SecretWeaponsBreakView.lua
--Author : generated by FairyGUI
--Date : 2020-7-28
--Desc : 

local SecretWeaponsBreakView,Super = class("SecretWeaponsBreakView", Window)

function SecretWeaponsBreakView:ctor()
	--LuaLog("SecretWeaponsBreakView ctor")
	self._packName = "SecretWeapons"
	self._compName = "SecretWeaponsBreakView"
	self._rootDepth = LayerDepth.FaceWindow
	
end

function SecretWeaponsBreakView:_initEvent( )
	
end

function SecretWeaponsBreakView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:SecretWeapons.SecretWeaponsBreakView
		vmRoot.list_generalAttr = viewNode:getChildAutoType("$list_generalAttr")--list
		vmRoot.list_specialAttr = viewNode:getChildAutoType("$list_specialAttr")--list
		vmRoot.txt_level = viewNode:getChildAutoType("$txt_level")--text
		vmRoot.img_bg = viewNode:getChildAutoType("$img_bg")--loader
		vmRoot.txt_nextlevel = viewNode:getChildAutoType("$txt_nextlevel")--text
	--{vmFieldsEnd}:SecretWeapons.SecretWeaponsBreakView
	--Do not modify above code-------------
end

function SecretWeaponsBreakView:_initUI( )
	self:_initVM()
	local imgbg=SecretWeaponsModel:getSecretWeaponsGetbg()
	self.img_bg:setURL(imgbg)
	self.c1= self.view:getController("c1")
	self:showText()
	self:showProperties()
	self:showSpecial()
end


function SecretWeaponsBreakView:showText( )
	local configInfo= DynamicConfigData.t_godArmsStage
	local curStage=SecretWeaponsModel:getCurStage()
	local oldStage=curStage-1
	if oldStage<1 then
		oldStage=1
	end
	if curStage>=#configInfo then
		curStage=#configInfo
	end
	local oldlevel= configInfo[oldStage].maxLevel
	local curlevel= configInfo[curStage].maxLevel
	self.txt_level:setText(oldlevel)
	self.txt_nextlevel:setText(curlevel)
end

function SecretWeaponsBreakView:showProperties( )
	local configInfo= DynamicConfigData.t_godArmsStage
	local serverStage=SecretWeaponsModel:getCurStage()
	local curStage=serverStage-1
	local nextStage=serverStage
	if nextStage>=#configInfo then
		nextStage=#configInfo
	end
	local curAttr= configInfo[curStage].addAttr
	local nextAttr= configInfo[nextStage].addAttr
	--local isMax= SecretWeaponsModel:isMaxStage()
	if curAttr and nextAttr then
		self.list_generalAttr:setItemRenderer(
			function(index, obj)
				local c1= obj:getController("c1")
				c1:setSelectedIndex(0)
				-- if isMax==true then
				-- 	c1:setSelectedIndex(1)
				-- else
				-- 	c1:setSelectedIndex(0)
				-- end
			local attr=curAttr[index+1]
			local nextattr=nextAttr[index+1]
			local attrName= GMethodUtil:getFightAttrName(attr.type)
			local attrNum=	GMethodUtil:getFightAttrName(attr.type,attr.value)
			local nextattrNum	=GMethodUtil:getFightAttrName(nextattr.type,nextattr.value)
			local txt_attrName= obj:getChildAutoType("txt_attrName")	
			txt_attrName:setText(attrName)
			local txt_cur= obj:getChildAutoType("txt_cur")	
			txt_cur:setText(attrNum)
			local txt_next= obj:getChildAutoType("txt_next")	
			txt_next:setText(nextattrNum)
			end
		)
		self.list_generalAttr:setNumItems(#curAttr)
	end
end


function SecretWeaponsBreakView:showSpecial( )
	local curStage=SecretWeaponsModel:getCurStage()
	local configInfo= DynamicConfigData.t_godArmsStage
	local attrMap={}
	for key, value in pairs(configInfo) do
		if next(value.exAttr) ~=nil then
			table.insert(attrMap,value.godArmsStage)	
		end	
	end
	local function sortFunc(arg1, arg2)
		return	arg1<arg2
	end
	TableUtil.sort(attrMap, sortFunc)
	local pos=SecretWeaponsModel:getItemIndex(attrMap, curStage)
	self.list_specialAttr:setItemRenderer(
		function(idx2, obj2)
			local color="#FFFFFF"
			if idx2 < pos then
				color="#6AFF60"
			end
		local confItem=DynamicConfigData.t_godArmsStage[attrMap[idx2+1]]
		--local attr=confItem.exAttr[1]
		local limitLevel=confItem.maxLevel
		local txt_desc1= obj2:getChildAutoType("txt_desc1")
		txt_desc1:setText(ColorUtil.formatColorString1(confItem.StageDesc, color)) -- [250]="突破" -- [251]="级"
		-- local attrName= GMethodUtil:getFightAttrName(attr.type)
		-- local attrNum=GMethodUtil:getFightAttrName(attr.type,attr.value)
		local txt_desc2= obj2:getChildAutoType("txt_desc2")
		--txt_desc2:setText(ColorUtil.formatColorString1(attrName.."+"..attrNum,color))
		txt_desc2:setText(ColorUtil.formatColorString1(confItem.desc,color))
		
		end
	)
	local suc=SecretWeaponsModel:getItemSucceeStarts(attrMap, curStage)
	printTable(29,"wwwwwwwwwwwwww",attrMap,curStage,pos,suc)
	local posItem=pos
	if suc==true then
		posItem=pos-1
		self.c1:setSelectedIndex(0)
	else
		if posItem-1<=0 then
			posItem=0
		end
		self.c1:setSelectedIndex(1)
	end
	self.list_specialAttr:setNumItems(#attrMap)
	self.list_specialAttr:scrollToView(posItem,true,true);
end



return SecretWeaponsBreakView
