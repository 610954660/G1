--Date :2021-01-18
--Author : generated by FairyGUI
--Desc : 

local GodMarketEvent3View,Super = class("GodMarketEvent3View", Window)

function GodMarketEvent3View:ctor()
	--LuaLog("GodMarketEvent3View ctor")
	self._packName = "GodMarket"
	self._compName = "GodMarketEvent3View"
	self._rootDepth = LayerDepth.PopWindow
	self.curIndex = 1
	self.fightIndex = 1
	self.fightArray = {}
end

function GodMarketEvent3View:_initEvent( )
	
end

function GodMarketEvent3View:_initVM( )
	local viewNode = self.view
	---Do not modify following code--------
	--{autoFields}:GodMarket.GodMarketEvent3View
	self.addNum = viewNode:getChildAutoType('addNum')--GTextField
	self.blackbg = viewNode:getChildAutoType('blackbg')--GLabel
	self.btn_battle = viewNode:getChildAutoType('btn_battle')--GButton
	self.btn_jihe = viewNode:getChildAutoType('btn_jihe')--mainBt
		self.btn_jihe.img_red = viewNode:getChildAutoType('btn_jihe/img_red')--GImage
	self.costNum = viewNode:getChildAutoType('costNum')--GRichTextField
	self.enemyList = viewNode:getChildAutoType('enemyList')--GList
	self.frame = viewNode:getChildAutoType('frame')--GLabel
	self.rewardList = viewNode:getChildAutoType('rewardList')--GList
	self.tabList = viewNode:getChildAutoType('tabList')--GList
	--{autoFieldsEnd}:GodMarket.GodMarketEvent3View
	--Do not modify above code-------------
end

function GodMarketEvent3View:_initListener( )
	
	self.btn_battle:addClickListener(function()
		Dispatcher.dispatchEvent("godmarket_battle",self.eventData,self.gridData,self.rewardList._dataTemplate)
		self:closeView()
	end)

	self.btn_jihe:addClickListener(function()
		GodMarketModel:setRoomFlagsPos(self.eventData.x*10000+self.eventData.y)
		self:closeView()
	end)
	if GodMarketModel.leader == 0 then
		self.btn_jihe:setVisible(false)
	end

	self.enemyList:setItemRenderer(function(index, obj)
		local data = self.enemyList._dataTemplate[index+1]
		local heroCell = BindManager.bindHeroCell(obj)
		heroCell:setData(data)
	end)

	self.rewardList:setItemRenderer(function(index, obj)
		local award = self.rewardList._dataTemplate[index+1]
		local itemcell = BindManager.bindItemCell(obj)
		itemcell:setData(award.code, award.amount, award.type)

		obj:removeClickListener(100)
		obj:addClickListener(function( ... )
				itemcell:onClickCell()
			end,100)
	end)

	self.tabList:setItemRenderer(function(index, obj)
		obj:addClickListener(function( ... )
			self.curIndex = index + 1
			if not 	self.fightArray[self.curIndex] then
				local status = 1
				if self.fightIndex == self.curIndex then
					status = 2
				elseif self.fightIndex > self.curIndex then
					status  = 3
				end
				self.fightArray[self.curIndex] =  GodMarketModel:getFightArray( self.eventData.d.fightid[self.curIndex],self.gridData, status )
			end
			self.enemyList:setData(self.fightArray[self.curIndex].heroInfos)
		end,100)
	end)

end

function GodMarketEvent3View:_initUI( )
	self:_initVM()
	self:_initListener()

	self.gridData = self._args.gridData
	self.eventData = self._args.eventData
	print(33,"")
	local gridData = self.gridData
	self.curIndex = gridData and gridData.event and gridData.event.fightData and gridData.event.fightData.index or 1
	self.fightIndex = self.curIndex
	self.fightArray[self.curIndex] =  GodMarketModel:getFightArray( self.eventData.d.fightid[self.curIndex],self.gridData )

	--TableUtil.sortByMap(ExpeditionModel.enemyArray, {{key="level",asc=true},{key="star",asc=true},{key="combat",asc=true}})
	if self.fightArray[self.curIndex] then
		self.enemyList:setData(self.fightArray[self.curIndex].heroInfos)
	end
	self.costNum:setText(string.format("%d/%d",GodMarketModel.costAction,GodMarketModel.serverData.action or 0))
	self.addNum:setText(string.format(Desc.godmarket_desc10,self.eventData.d.reward3)) --godmarket_desc10="房间神格产量*%d小时"
	self.rewardList:setData(self.eventData.d.reward1)

	if (GodMarketModel.serverData.action or 0) < 1 then
		self.btn_battle:setGrayed(true)
		self.btn_battle:setTouchable(false)
	end

	
	self.tabList:setNumItems(3)
	self.tabList:setSelectedIndex(self.curIndex -1)
end




return GodMarketEvent3View
