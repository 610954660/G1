--Name : GodMarketMineView.lua
--Author : generated by FairyGUI
--Date : 2020-5-29
--Desc : 神虚宝藏

local GodMarketMineView,Super = class("GodMarketMineView", Window)
local ItemCell = require "Game.UI.Global.ItemCell"
function GodMarketMineView:ctor()
	--LuaLog("GodMarketMineView ctor")
	self._packName = "GodMarket"
	self._compName = "GodMarketMineView"
	self._rootDepth = LayerDepth.PopWindow
	self.moduleId=1
end

function GodMarketMineView:_initEvent( )
	
end

function GodMarketMineView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:OperatingActivities.GodMarketMineView
		vmRoot.btn_play = viewNode:getChildAutoType("$btn_play")--Button
		vmRoot.list_allReward = viewNode:getChildAutoType("$list_allReward")--list
		vmRoot.list_reward = viewNode:getChildAutoType("$list_reward")--list
	--{vmFieldsEnd}:OperatingActivities.GodMarketMineView
	--Do not modify above code-------------
end

function GodMarketMineView:_initUI( )
	self:_initVM()
	--[[local mainInfo = GodMarketModel:getMainInfo()
    if next(mainInfo) == nil then
        return
    end--]]
	
	self.moduleId = ActivityModel:getModuleIdByActivityType(GameDef.ActivityType.GodMarket)
	local price=DynamicConfigData.t_GodMarketPay[self.moduleId][1].price or 98
	self.btn_play:setTitle(string.format(Desc.activity_txt15,price))
	
	local tableAll={} 	--总奖励
	local tableCur={}	--当前奖励
	local allrewardInfo={}
	local currewardInfo={}
	local Kingpay=DynamicConfigData.t_Kingpay[self.moduleId]
	local configInfo=DynamicConfigData.t_GodMarketcard[self.moduleId]
	local starTotal=GodMarketModel.serverData.actionScore
	--[[local playerWinNum=GodMarketModel.serverData.winNum or 0
	if playerWinNum<configInfo[Kingpay.id].victoryTimes then
		starTotal=configInfo[Kingpay.id].victoryTimes
	elseif playerWinNum>=configInfo[Kingpay.id].victoryTimes then
		starTotal=Kingpay.winNumber
	else
		starTotal=playerWinNum
	end--]]
	local lingquMap = GodMarketModel.mineRewardState or {} --已经领取的列表
	for key, value in pairs(configInfo) do
		local info = lingquMap[value.id] or {}
		if starTotal>=value.actionValue then
			table.insert(tableCur,value.freeReward)		
		end
		table.insert(tableAll,value.freeReward)	
	end
	--[[local tableCeihua=DynamicConfigData.t_GodMarketPay[self.chargeId].item or {}
	if tableCeihua and tableCeihua[1] and tableCeihua[1].amount>0 then
		table.insert(tableCur,tableCeihua)	
	end--]]
	allrewardInfo=TableUtil:getReward(tableAll,1)
	currewardInfo=TableUtil:getReward(tableCur,1)

	self.list_allReward:setItemRenderer(function(index,rewardObj)
			rewardObj:removeClickListener(100)
			--池子里面原来的事件注销掉
			local itemcell = BindManager.bindItemCell(rewardObj)
			local award =allrewardInfo[index + 1]
			itemcell:setData(award.code, award.amount, award.type)
			-- itemcell:setFrameVisible(false)
			rewardObj:addClickListener(function( ... )
			itemcell:onClickCell()
	   end,100)
	end)
	self.list_allReward:setNumItems(#allrewardInfo);


	self.list_reward:setItemRenderer(function(index,rewardObj)
			rewardObj:removeClickListener(100)
			--池子里面原来的事件注销掉
			local itemcell = BindManager.bindItemCell(rewardObj)
			local award =currewardInfo[index + 1]
			itemcell:setData(award.code, award.amount, award.type)
			-- itemcell:setFrameVisible(false)
			rewardObj:addClickListener(function( ... )
			itemcell:onClickCell()
	   end,100)
	end)
	self.list_reward:setNumItems(#currewardInfo);
end


--事件初始化
function GodMarketMineView:_initEvent(...)
    self.btn_play:addClickListener(
		function(...)
			local config = DynamicConfigData.t_GodMarketPay[self.moduleId]
			if config then 
				local price=config.price or 98
				ModelManager.RechargeModel:directBuy(price, GameDef.StatFuncType.SFT_ActivityGodMarket, 1, Desc.godmarket_desc18,nil,Desc.godmarket_desc18..price) --godmarket_desc18="神域宝藏" --godmarket_desc18="神域宝藏"
			end
			ViewManager.close("GodMarketMineView")
        end
    )
end


return GodMarketMineView
