--Date :2021-01-18
--Author : generated by FairyGUI
--Desc : 

local GodMarketEvent4View,Super = class("GodMarketEvent4View", Window)

function GodMarketEvent4View:ctor()
	--LuaLog("GodMarketEvent4View ctor")
	self._packName = "GodMarket"
	self._compName = "GodMarketEvent4View"
	self._rootDepth = LayerDepth.PopWindow
	
end

function GodMarketEvent4View:_initEvent( )
	
end

function GodMarketEvent4View:_initVM( )
	local viewNode = self.view
	---Do not modify following code--------
	--{autoFields}:GodMarket.GodMarketEvent4View
	self.blackbg = viewNode:getChildAutoType('blackbg')--GLabel
	self.btn_battle = viewNode:getChildAutoType('btn_battle')--GButton
	self.btn_jihe = viewNode:getChildAutoType('btn_jihe')--mainBt
		self.btn_jihe.img_red = viewNode:getChildAutoType('btn_jihe/img_red')--GImage
	self.costNum = viewNode:getChildAutoType('costNum')--GRichTextField
	self.enemyList = viewNode:getChildAutoType('enemyList')--GList
	self.frame = viewNode:getChildAutoType('frame')--GLabel
	self.rewardList = viewNode:getChildAutoType('rewardList')--GList
	--{autoFieldsEnd}:GodMarket.GodMarketEvent4View
	--Do not modify above code-------------
end

function GodMarketEvent4View:_initListener( )
	
	self.btn_battle:addClickListener(function()
		Dispatcher.dispatchEvent("godmarket_battle",self.eventData,self.gridData,self.rewardList._dataTemplate)
		self:closeView()
	end)

	self.btn_jihe:addClickListener(function()
		GodMarketModel:setRoomFlagsPos(self.eventData.x*10000+self.eventData.y)
		self:closeView()
	end)

	if GodMarketModel.leader == 0 then
		self.btn_jihe:setVisible(false)
	end
	
	self.enemyList:setItemRenderer(function(index, obj)
		local data = self.enemyList._dataTemplate[index+1]
		local heroCell = BindManager.bindHeroCell(obj)
		heroCell:setData(data)
	end)

	self.rewardList:setItemRenderer(function(index, obj)
		local award = self.rewardList._dataTemplate[index+1]
		local itemcell = BindManager.bindItemCell(obj)
		itemcell:setData(award.code, award.amount, award.type)

		obj:removeClickListener(100)
		obj:addClickListener(function( ... )
				itemcell:onClickCell()
			end,100)
	end)

end

function GodMarketEvent4View:_initUI( )
	self:_initVM()
	self:_initListener()

	self.gridData = self._args.gridData
	self.eventData = self._args.eventData
	print(33,"")
	self.fightArray =  GodMarketModel:getFightArray( self.eventData.d.fightid[1],self.gridData )

	--TableUtil.sortByMap(ExpeditionModel.enemyArray, {{key="level",asc=true},{key="star",asc=true},{key="combat",asc=true}})
	if self.fightArray then
		self.enemyList:setData(self.fightArray.heroInfos)
	end
	self.costNum:setText(string.format("%d/%d",GodMarketModel.costAction,GodMarketModel.serverData.action or 0))
	--self.addNum:setText(string.format(Desc.godmarket_desc10,self.eventData.d.reward3)) --godmarket_desc10="房间神格产量*%d小时"
	self.rewardList:setData(self.eventData.d.reward1)

	if (GodMarketModel.serverData.action or 0) < 1 then
		self.btn_battle:setGrayed(true)
		self.btn_battle:setTouchable(false)
	end
end




return GodMarketEvent4View
