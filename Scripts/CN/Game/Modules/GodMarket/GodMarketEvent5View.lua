--Date :2021-01-18
--Author : generated by FairyGUI
--Desc : 

local GodMarketEvent5View,Super = class("GodMarketEvent5View", Window)

function GodMarketEvent5View:ctor()
	--LuaLog("GodMarketEvent5View ctor")
	self._packName = "GodMarket"
	self._compName = "GodMarketEvent5View"
	self._rootDepth = LayerDepth.Window
	
end

function GodMarketEvent5View:_initEvent( )
	
end

function GodMarketEvent5View:_initVM( )
	local viewNode = self.view
	---Do not modify following code--------
	--{autoFields}:GodMarket.GodMarketEvent5View
	self.btn_battle = viewNode:getChildAutoType('btn_battle')--GButton
	self.btn_get = viewNode:getChildAutoType('btn_get')--GButton
	self.condition = viewNode:getChildAutoType('condition')--GTextField
	self.frame = viewNode:getChildAutoType('frame')--GLabel
	self.model = viewNode:getChildAutoType('model')--GLoader
	self.rewardList = viewNode:getChildAutoType('rewardList')--GList
	self.skillList = viewNode:getChildAutoType('skillList')--GList
	self.status = viewNode:getController('status')--Controller
	self.times = viewNode:getChildAutoType('times')--GTextField
	--{autoFieldsEnd}:GodMarket.GodMarketEvent5View
	--Do not modify above code-------------
end

function GodMarketEvent5View:_initListener( )
	
	self.btn_battle:addClickListener(function()
		Dispatcher.dispatchEvent("godmarket_battle",self.eventData,self.gridData,self.rewardList._dataTemplate)
		self:closeView()
	end)

	self.btn_get:addClickListener(function()
		GodMarketModel:receiveGridBossReward(self.eventData.id,function()
			if not tolua.isnull(self.btn_get) then
				self.view:getController("status"):setSelectedIndex(3)
			end
		end)
	end)

	self.skillList:setItemRenderer(function(index, obj)
		local data = self.skillList._dataTemplate[index+1]
		local skillCell = BindManager.bindSkillCell(obj)
		
		skillCell:setData(data)
		obj:addClickListener(function()
			ViewManager.open("ItemTips", {codeType = CodeType.SKILL, id =  data})
		end,99)
	end)

	self.rewardList:setItemRenderer(function(index, obj)
		local award = self.rewardList._dataTemplate[index+1]
		local itemcell = BindManager.bindItemCell(obj)
		itemcell:setData(award.code, award.amount, award.type)

		obj:removeClickListener(100)
		obj:addClickListener(function( ... )
				itemcell:onClickCell()
			end,100)
	end)
end

function GodMarketEvent5View:_initUI( )
	self:_initVM()
	self:_initListener()

	self:setBg("godmart_boss.jpg")
	self.gridData = self._args.gridData
	self.eventData = self._args.eventData
	print(33,"")
	local fightArray =  GodMarketModel:getFightArray( self.eventData.d.fightid[1],self.gridData )

	--TableUtil.sortByMap(ExpeditionModel.enemyArray, {{key="level",asc=true},{key="star",asc=true},{key="combat",asc=true}})
	if fightArray then
		--self.enemyList:setData(self.fightArray.heroInfos)
		SpineUtil.createModel(self.model, {x = 0, y =0}, "stand", fightArray.heroInfos[1].code,true)
		local skill = DynamicConfigData.t_monster[fightArray.heroInfos[1].code].skill
		self.skillList:setData(skill)
	end

	self.rewardList:setData(self.eventData.d.reward1)


	local state = GodMarketModel.bossInfo.state or 0
	local num = GodMarketModel.bossInfo.number or 0
	local cf = GodMarketModel.curConfig.condition
	if GodMarketModel.eventCurNum[1] < cf[1].amount or GodMarketModel.eventCurNum[2] < cf[2].amount then
		self.view:getController("status"):setSelectedIndex(0)
		self.condition:setText(string.format(Desc.godmarket_desc31,cf[1].amount,cf[2].amount)) --godmarket_desc31="普通神土探索达到%d，高级神土探索达到%d后解锁挑战"
	else
		if state == 1 then
			self.view:getController("status"):setSelectedIndex(2)
		elseif state == 2 then
			self.view:getController("status"):setSelectedIndex(3)
		else
			self.view:getController("status"):setSelectedIndex(1)
			if num < 1 then
				self.btn_battle:setGrayed(true)
				self.btn_battle:setTouchable(false)
			end
		end
	end

	
	
	
	self.times:setText(num)
end




return GodMarketEvent5View
