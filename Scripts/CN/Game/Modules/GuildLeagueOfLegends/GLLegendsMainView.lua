--Date :2020-12-31
--Author : generated by FairyGUI
--Desc : 

local GLLegendsMainView,Super = class("GLLegendsMainView", Window)

function GLLegendsMainView:ctor()
	--LuaLog("GLLegendsMainView ctor")
	self._packName = "GuildLeagueOfLegends"
	self._compName = "GLLegendsMainView"
	--self._rootDepth = LayerDepth.PopWindow
	
end

function GLLegendsMainView:_initVM( )
	local viewNode = self.view
	---Do not modify following code--------
	--{autoFields}:GuildLeagueOfLegends.GLLegendsMainView
	self.btn_award = viewNode:getChildAutoType('btn_award')--btn_mainEnter
		self.btn_award.img_red = viewNode:getChildAutoType('btn_award/img_red')--GImage
	self.btn_def = viewNode:getChildAutoType('btn_def')--GButton
	self.btn_join = viewNode:getChildAutoType('btn_join')--GButton
	self.btn_rank = viewNode:getChildAutoType('btn_rank')--btn_mainEnter
		self.btn_rank.img_red = viewNode:getChildAutoType('btn_rank/img_red')--GImage
	self.btn_table = viewNode:getChildAutoType('btn_table')--btn_mainEnter
		self.btn_table.img_red = viewNode:getChildAutoType('btn_table/img_red')--GImage
	self.c1 = viewNode:getController('c1')--Controller
	self.guild1 = viewNode:getChildAutoType('guild1')--com_guildRank
		self.guild1.icon = viewNode:getChildAutoType('guild1/icon')--GLoader
		self.guild1.txt_name = viewNode:getChildAutoType('guild1/txt_name')--GTextField
		self.guild1.txt_server = viewNode:getChildAutoType('guild1/txt_server')--GTextField
	self.guild2 = viewNode:getChildAutoType('guild2')--com_guildRank
		self.guild2.icon = viewNode:getChildAutoType('guild2/icon')--GLoader
		self.guild2.txt_name = viewNode:getChildAutoType('guild2/txt_name')--GTextField
		self.guild2.txt_server = viewNode:getChildAutoType('guild2/txt_server')--GTextField
	self.guild3 = viewNode:getChildAutoType('guild3')--com_guildRank
		self.guild3.icon = viewNode:getChildAutoType('guild3/icon')--GLoader
		self.guild3.txt_name = viewNode:getChildAutoType('guild3/txt_name')--GTextField
		self.guild3.txt_server = viewNode:getChildAutoType('guild3/txt_server')--GTextField
	self.guild4 = viewNode:getChildAutoType('guild4')--com_guildRank
		self.guild4.icon = viewNode:getChildAutoType('guild4/icon')--GLoader
		self.guild4.txt_name = viewNode:getChildAutoType('guild4/txt_name')--GTextField
		self.guild4.txt_server = viewNode:getChildAutoType('guild4/txt_server')--GTextField
	self.guild5 = viewNode:getChildAutoType('guild5')--com_guildRank
		self.guild5.icon = viewNode:getChildAutoType('guild5/icon')--GLoader
		self.guild5.txt_name = viewNode:getChildAutoType('guild5/txt_name')--GTextField
		self.guild5.txt_server = viewNode:getChildAutoType('guild5/txt_server')--GTextField
	self.guild6 = viewNode:getChildAutoType('guild6')--com_guildRank
		self.guild6.icon = viewNode:getChildAutoType('guild6/icon')--GLoader
		self.guild6.txt_name = viewNode:getChildAutoType('guild6/txt_name')--GTextField
		self.guild6.txt_server = viewNode:getChildAutoType('guild6/txt_server')--GTextField
	self.guild7 = viewNode:getChildAutoType('guild7')--com_guildRank
		self.guild7.icon = viewNode:getChildAutoType('guild7/icon')--GLoader
		self.guild7.txt_name = viewNode:getChildAutoType('guild7/txt_name')--GTextField
		self.guild7.txt_server = viewNode:getChildAutoType('guild7/txt_server')--GTextField
	self.guild8 = viewNode:getChildAutoType('guild8')--com_guildRank
		self.guild8.icon = viewNode:getChildAutoType('guild8/icon')--GLoader
		self.guild8.txt_name = viewNode:getChildAutoType('guild8/txt_name')--GTextField
		self.guild8.txt_server = viewNode:getChildAutoType('guild8/txt_server')--GTextField
	self.txt_desc = viewNode:getChildAutoType('txt_desc')--GTextField
	self.txt_matchTime1 = viewNode:getChildAutoType('txt_matchTime1')--GTextField
	self.txt_matchTime11 = viewNode:getChildAutoType('txt_matchTime11')--GTextField
	self.txt_matchTime2 = viewNode:getChildAutoType('txt_matchTime2')--GTextField
	self.txt_matchTime21 = viewNode:getChildAutoType('txt_matchTime21')--GTextField
	self.txt_tips = viewNode:getChildAutoType('txt_tips')--GRichTextField
	--{autoFieldsEnd}:GuildLeagueOfLegends.GLLegendsMainView
	--Do not modify above code-------------
end

function GLLegendsMainView:_initListener( )
	
	self.btn_award:addClickListener(function()
		ViewManager.open("GLLegendsAwardView")
	end)

	self.btn_def:addClickListener(function()
		ViewManager.open("GLLegendsDefPreView")
	end)

	self.btn_join:addClickListener(function()
		ViewManager.open("GLLegendsGroupView")
	end)

	self.btn_rank:addClickListener(function()
		ViewManager.open("GuildLeagueRankView");
	end)

	self.btn_table:addClickListener(function()
		ViewManager.open("GLLegendsTableView")
	end)

	local joinRed = self.btn_join:getChildAutoType("img_red");
	RedManager.register("V_GLOL_enter", joinRed);
end

function GLLegendsMainView:_initUI( )
	self:_initVM()
	self:_initListener()
		self.txt_desc:setText(Desc.GLOL_condition)
		self:upSeasonTime()
		self:_refresh();
end

function GLLegendsMainView:_refresh()
	GuildLeagueOfLegendsModel:getBaseInfo()
end

function GLLegendsMainView:GLOL_MatchInfoUpdate()
	local c1 = self.view:getController("c1");
	if (GuildLeagueOfLegendsModel.isInMatch 
		 and GuildLeagueOfLegendsModel.matchRound ~= GameDef.GuildLeagueRound.Seven 
		 and GuildLeagueOfLegendsModel.roundState == GameDef.GuildLeagueState.Pre) then
		c1:setSelectedIndex(1);
	else
		c1:setSelectedIndex(0);
	end
	if (not next(GuildLeagueOfLegendsModel.guildMap)) then
		self.btn_join:setGrayed(true);
		self.btn_join:setTouchable(false);
		self.btn_join:setTitle(Desc.GL_actStatus8);
	else
		self.btn_join:setGrayed(false);
		self.btn_join:setTouchable(true);
		self.btn_join:setTitle(Desc.GL_actStatus7);
	end
	if (GuildLeagueOfLegendsModel.notEnoughGuild) then
		self.txt_tips:setText(Desc.GLOL_str12)
	else
		self.txt_tips:setText("")
	end
	self:upSeasonTime();
	self:upGuildRank();
end

function GLLegendsMainView:upGuildRank()
	local arr = GuildLeagueOfLegendsModel:getTop8Guild();
	for i = 1, 8 do
		local guildItem = self["guild"..i];
		local guildInfo = arr[i];
		local ctrl = guildItem:getController("c1");
		if (guildInfo) then
			ctrl:setSelectedIndex(1);
			guildItem.icon:setIcon(GuildModel:getGuildHead(guildInfo.guildIcon));
			guildItem.txt_name:setText(guildInfo.guildName);
			guildItem.txt_server:setText(guildInfo.serverId);
		else
			ctrl:setSelectedIndex(0);
		end
	end
end

function GLLegendsMainView:upSeasonTime()
	local stamp = GuildLeagueModel:getBaseInfo().seasonEndStamp or 0;
	if (stamp ~= 0) then
		local month2 = TimeLib.getMonth(stamp)
		local day2 = TimeLib.getDay(stamp)
		stamp = stamp - 86400 * 1000;
		local month1 = TimeLib.getMonth(stamp)
		local day1 = TimeLib.getDay(stamp)
		self.txt_matchTime1:setText(string.format(Desc.GLOL_str10, month1, day1))
		self.txt_matchTime2:setText(string.format(Desc.GLOL_str10, month2, day2))
		self.txt_matchTime11:setText(Desc.GLOL_matchTime)
		self.txt_matchTime21:setText(Desc.GLOL_matchTime)
	end
end

return GLLegendsMainView