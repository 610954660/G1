--Date :2020-12-19
--Author : generated by FairyGUI
--Desc : 

local FashionShopTipsView,Super = class("FashionShopTipsView", Window)
local FashionConfiger = require "Game.ConfigReaders.FashionConfiger"

function FashionShopTipsView:ctor()
	--LuaLog("FashionShopTipsView ctor")
	self._packName = "Fashion"
	self._compName = "FashionShopTipsView"
	self._rootDepth = LayerDepth.PopWindow
	--self._rootDepth = LayerDepth.Window
	self.btn_Preview = false
	self.btn_buy = false
	self.btn_close = false
	self.lihuiDisplay = false
	self.playerIcon = false
	self.attrDesc = false
	self.rewardList = false
	self.money = self._args.fashionInfo.money
	self.fashionId = self._args.fashionInfo.fashionId
	self.shopId = self._args.fashionInfo.shopId
	self.reward = self._args.fashionInfo.reward 
	self.buyTime = self._args.fashionInfo.buyTime
	self.cost = self._args.fashionInfo.cost
	self.isSpecialShow = self._args.fashionInfo.isSpecialShow
	self.fashionInfo = FashionConfiger.getFashionInfoByFashionId(self.fashionId)
end

function FashionShopTipsView:_initEvent( )
	self.btn_Preview:addClickListener(function()
		ViewManager.open("FashionPreView",{skillId = self.fashionInfo.skillId, data = self.fashionInfo, fashionId = self.fashionId})
	end)

	self.btn_buy:addClickListener(function()
		local reqInfo = {
		  shopType = GameDef.ShopType.Fashion,   -- 商店类型
		  index    = self.shopId,         -- 商品id
		  amount    = 1,         -- 购买数量
		}
		RPCReq.Shop_BuyMallItem(reqInfo,function(args)
			if args.ret == 0 then
				local reward = {
					{
						type = CodeType.ITEM,
						code = self.fashionId,
						amount = 1,
					}
				}
				for i,v in ipairs(self.reward) do
					if i > 1 then 
						table.insert(reward,v)
					end
				end

				for k,v in pairs(ShopModel.shopList[GameDef.ShopType.Fashion].list) do
					if args.id == v.id then
						v.buyTime = args.buyTime
						break	
					end
				end
				RollTips.showReward(reward)
				Dispatcher.dispatchEvent(EventType.shop_refreshItem)
				ViewManager.close("FashionShopTipsView")
			end
		end)
	end)

	self.btn_close:addClickListener(function()
		ViewManager.close("FashionShopTipsView")
	end)
end

function FashionShopTipsView:_initVM( )
	local viewNode = self.view
	---Do not modify following code--------
	--{autoFields}:Fashion.FashionShopTipsView
	self.Bg = viewNode:getChildAutoType('Bg')--GImage
	self.Title = viewNode:getChildAutoType('Title')--GImage
	self.attrDesc = viewNode:getChildAutoType('attrDesc')--GRichTextField
	self.blackbg = viewNode:getChildAutoType('blackbg')--GLabel
	self.btn_Preview = viewNode:getChildAutoType('btn_Preview')--GButton
	self.btn_buy = viewNode:getChildAutoType('btn_buy')--GButton
	self.btn_close = viewNode:getChildAutoType('btn_close')--GButton
	self.lihuiDisplay = viewNode:getChildAutoType('lihuiDisplay')--GButton
	self.playerIcon = viewNode:getChildAutoType('playerIcon')--GLoader
	self.rewardList = viewNode:getChildAutoType('rewardList')--GList
	self.rewardPanel = viewNode:getChildAutoType('rewardPanel')--GGroup
	self.showPanel = viewNode:getChildAutoType('showPanel')--GGroup
	self.specialShowCtr = viewNode:getController('specialShowCtr')--Controller
	--{autoFieldsEnd}:Fashion.FashionShopTipsView
	--Do not modify above code-------------
end

function FashionShopTipsView:setAttrDesc()
	self.attrDesc:setText(self.fashionInfo.attrDesc)
end

function FashionShopTipsView:setRewardList()
	local num = TableUtil.GetTableLen(self.reward) --除去第一个时装道具，之后都是额外赠送的道具
	local pos = self.showPanel:getPosition()
	if (num > 1) or not self.isSpecialShow then
		local reward = {}
		for i,v in ipairs(self.reward) do
			if i > 1 then 
				table.insert(reward,v)
			end
		end
		self.rewardList:setItemRenderer(function(idx,obj)
	  	  	local index = idx + 1
	   		local data  = reward[index]
			local itemCell 	= BindManager.bindItemCell(obj)
			itemCell:setData(data.code, data.amount, data.type)
		end)
		
	    self.rewardList:setData(reward)
	    self.rewardPanel:setVisible(true)
	    self.showPanel:setPosition(pos.x,150)
	else
	    self.rewardPanel:setVisible(false)
	    self.showPanel:setPosition(pos.x,242)
	end
end

function FashionShopTipsView:_initUI( )
	self:_initVM()
	local pos = self.showPanel:getPosition()
	if self.isSpecialShow then 
		self.specialShowCtr:setSelectedIndex(0)
	else
		self:setMoney()
		self.specialShowCtr:setSelectedIndex(1)
	end
	self:setLihuiDisplay()
	self:setPlayerIcon()
	self:setAttrDesc()
	self:setRewardList()
end

function FashionShopTipsView:setMoney()
	local url = ItemConfiger.getItemIconByCode(self.cost[1].code, self.cost[1].type)
	self.btn_buy:getChildAutoType("icon"):setURL(url)
	self.btn_buy:getChildAutoType("cost"):setText(self.money)
	self.btn_buy:setGrayed(self.buyTime <= 0) 
	self.btn_buy:setTouchable(self.buyTime > 0)
end

function FashionShopTipsView:setLihuiDisplay()
	self.lihuiDisplay = BindManager.bindLihuiDisplay(self.lihuiDisplay)
	self.lihuiDisplay:setScale(0.5,0.5)
	self.lihuiDisplay:setData(self.fashionInfo.heroCode,nil,nil,self.fashionId)
end

function FashionShopTipsView:setPlayerIcon()
	self.playerIcon = self.playerIcon:displayObject()
	local skeletonNode = SpineMnange.createSprineById(self.fashionInfo.heroCode,true,nil,nil,self.fashionId)
	skeletonNode:setAnimation(0, "stand", true);
	self.playerIcon:removeAllChildren()
	self.playerIcon:addChild(skeletonNode)
end

return FashionShopTipsView