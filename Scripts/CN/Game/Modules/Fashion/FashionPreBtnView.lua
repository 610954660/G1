--Date :2021-01-13
--Author : generated by FairyGUI
--Desc : 

local FashionPreBtnView,Super = class("FashionPreBtnView", Window)
local CameraController=require "Game.Modules.Battle.Effect.CameraController"
local SkillConfiger=require "Game.ConfigReaders.SkillConfiger"
local HeroItem = require "Game.Modules.Battle.Cell.HeroItem"

function FashionPreBtnView:ctor()
	--LuaLog("FashionPreBtnView ctor")
	self._packName = "Fashion"
	self._compName = "FashionPreBtnView"
	self.animateTab = {}
	self.timerKey = false
	self.isPlaySkill = false
	self.skillIndex = 1
	--self._rootDepth = LayerDepth.Window
end

function FashionPreBtnView:_initVM( )
	local viewNode = self.view
	---Do not modify following code--------
	--{autoFields}:Fashion.FashionPreBtnView
	self.btn_skip = viewNode:getChildAutoType('btn_skip')--GButton
	self.btn_speed = viewNode:getChildAutoType('btn_speed')--speedButton
	self.skillList = viewNode:getChildAutoType('skillList')--GList
	--{autoFieldsEnd}:Fashion.FashionPreBtnView
	--Do not modify above code-------------
end

function FashionPreBtnView:setSkillList()
	self.skillList:setItemRenderer(function(idx,obj)
        local index = idx + 1
        local seleted  = obj:getChildAutoType("seleted")
        obj:removeClickListener(6)
   		obj:addClickListener(function()
   			if self.isPlaySkill then return end 
            if self.timerKey then 
                Scheduler.unschedule(self.timerKey)
            end
            self.skillIndex = index
          	self:playSkill()
	    end,6)
        if self.animateTab[index] then
            Scheduler.unschedule(self.animateTab[index])
        end

        local playT1 = function()
            obj:getTransition("t0"):play(function() 
            end)
        end
        self.animateTab[index] = Scheduler.schedule(playT1,1)

        local skillCell = BindManager.bindSkillCell(obj)
		skillCell:setData(self.skillIdList[index])
    end)
    self.skillList:setData(self.skillIdList)
end

function FashionPreBtnView:_initUI( )
	self:_initVM()
	self.data = self._args.data
    self.fashionId = self._args.fashionId
	self.skillIdList = self._args.skillId
    self:setSpeed()
    self:setSkillList()
    self.timerKey = Scheduler.schedule(function()
        self:playSkill()
    end,3,1)
end

function FashionPreBtnView:_initEvent( )
    self.btn_skip:addClickListener(function()
        SkillManager.clear(true)
        BattleManager:getInstance():cleansup(true)
        ViewManager.close("FashionPreView")
    end)
    
    self.btn_speed:addClickListener(function()
        BattleModel:saveOpenSpeed()
        local speedIndex=BattleModel:getGameSpeed()
        local changeIndex=false
        if speedIndex==1 then
            changeIndex = 2
        elseif speedIndex==2 then
            changeIndex = 3
        elseif speedIndex==3 then
            changeIndex = 1
        end
        self.btn_speed:getController("speed"):setSelectedIndex(changeIndex)
        BattleModel:changeGameSpeed(changeIndex)
        BattleModel:saveGameSpeed(changeIndex)
    end,6)
end

-- 设置倍数
function FashionPreBtnView:setSpeed()
    self.btn_speed:getController("speed"):setSelectedIndex(1)
end

function FashionPreBtnView:playSkill()
	self.isPlaySkill = true
    if self.skillIndex > #self.skillIdList then 
        self.skillIndex = 1
    end
    self.skillList:setSelectedIndex(self.skillIndex-1)
	self.skillList:setTouchable(false)
    local skillId = self.skillIdList[self.skillIndex]
    local data = {}
    data.skillId = skillId
	Dispatcher.dispatchEvent(EventType.FashionPreView_PlaySkill,data)
end

function FashionPreBtnView:FashionPreView_EndSkill(_,data)
	self.isPlaySkill = false
	self.skillIndex = self.skillIndex + 1
    self.skillList:setTouchable(true)
    if self.timerKey then 
        Scheduler.unschedule(self.timerKey)
    end
     self.timerKey = Scheduler.schedule(function()
        self:playSkill()
    end,4,1)
end

function FashionPreBtnView:_exit()
    Scheduler.unschedule(self.timerKey)
    for k,v in pairs(self.animateTab) do
        Scheduler.unschedule(v)
    end
    BattleModel:changeGameSpeed(1)
    BattleModel:saveGameSpeed(1)
end

return FashionPreBtnView