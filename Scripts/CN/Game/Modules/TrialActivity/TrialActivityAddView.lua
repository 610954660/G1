--Date :2021-01-02
--Author : generated by FairyGUI
--Desc : 

local TrialActivityAddView,Super = class("TrialActivityAddView", Window)

function TrialActivityAddView:ctor()
	--LuaLog("TrialActivityAddView ctor")
	self._packName = "TrialActivity"
	self._compName = "TrialActivityAddView"
	self._rootDepth = LayerDepth.PopWindow
	self.shopData = false
	self.timer = {}
end

function TrialActivityAddView:_initEvent( )
	
end

function TrialActivityAddView:_initVM( )
	local viewNode = self.view
	---Do not modify following code--------
	--{autoFields}:TrialActivity.TrialActivityAddView
	self.bg = viewNode:getChildAutoType('bg')--GImage
	self.blackbg = viewNode:getChildAutoType('blackbg')--GLabel
	self.closeButton1 = viewNode:getChildAutoType('closeButton1')--GButton
	self.list = viewNode:getChildAutoType('list')--GList
	--{autoFieldsEnd}:TrialActivity.TrialActivityAddView
	--Do not modify above code-------------
end

function TrialActivityAddView:_initListener( )
	
	self.closeButton1:addClickListener(function()
		self:closeView()
	end)
	self.blackbg:removeClickListener()
	self.list:setItemRenderer(function(index, obj)
		local shopC = TrialActivityModel.shop
		local data = self.list._dataTemplate[index+1]
		local list = obj:getChildAutoType("list")
		list:setItemRenderer(function(index2, obj2)
			local info = list._dataTemplate[index2+1]
			local itemcell = BindManager.bindItemCell(obj2)
			local itemData = ItemsUtil.createItemData({data = info})
			itemcell:setItemData(itemData)
		end)
		list:setData(data.reward)
		local buyBt = obj:getChildAutoType("btn_go")
		local curNum = shopC[data.id] and shopC[data.id].times or 0
		if  curNum >= data.limit then
			obj:getChildAutoType("bugTxt"):setText("")
			obj:getController("c1"):setSelectedIndex(1)
			if data.nextMs and data.nextMs > 0 then
				self.updateCountTimer(obj,index,data.nextMs,data)
			end
		else
			obj:getController("c1"):setSelectedIndex(0)
			obj:getChildAutoType("bugTxt"):setText(data.buyLimit..string.format("[color=#119717]%d[/color]",data.limit - curNum ) )
		end
		obj:getChildAutoType("title"):setText(data.name)
		buyBt:removeClickListener(33)
		buyBt:getChildAutoType("img_red"):setVisible(false)
		if data.buyType == 1 then
			buyBt:getController("iconCtrl"):setSelectedIndex(1)
			if data.price == 0 then
				buyBt:getChildAutoType("img_red"):setVisible(true)
				buyBt:setTitle(Desc.trialActivity_desc3)
				buyBt:addClickListener(function()
					TrialActivityModel:reqFreeShop(data.id)
				end,33)
			else
				buyBt:setTitle(data.price..Desc.activity_txt7)
				buyBt:addClickListener(function()
					ModelManager.RechargeModel:directBuy(data.price,  GameDef.StatFuncType.SFT_TrialShop, data.id,data.name,nil,data.showName1)
				end,33)
			end
		else
			buyBt:getController("iconCtrl"):setSelectedIndex(0)
			local url = ItemConfiger.getItemIconByCode(data.cost[1].code, data.cost[1].type, false)
			buyBt:setIcon(url)
			buyBt:setTitle(data.cost[1].amount)
			buyBt:addClickListener(function()
				TrialActivityModel:reqFreeShop(data.id)
			end,33)
		end


		
	end)

end

function TrialActivityAddView:_initUI( )
	self:_initVM()
	self:_initListener()
	local moduleId = TrialActivityModel:getShopModuleId()
	self.shopData = DynamicConfigData.t_TrialShop[moduleId]
	self:trialActivity_freeBuySuccess()
end

function TrialActivityAddView:trialActivity_freeBuySuccess( )
	local shopC = TrialActivityModel.shop or {}
	for k,v in pairs(self.shopData) do
		local curNum = shopC[v.id] and shopC[v.id].times or 0
		v.canBuyNum = v.limit - curNum
		if v.canBuyNum <= 0 then
			v.status = 0
		else
			v.status = 1
		end
	end
	TableUtil.sortByMap(self.shopData, {{key = "status", asc = true},{key = "id", asc = false}})
	self.list:setData(self.shopData)
	TrialActivityModel:updateRed()
end



-- 倒计时
function TrialActivityAddView:updateCountTimer(obj,index,addtime,data)

	local lastTime = addtime / 1000
	local textObj = obj:getChildAutoType("bugTxt")
	textObj:setText(Desc.trialActivity_desc4:format(TimeLib.GetTimeFormatDay(lastTime, 2)))
	
	local function onCountDown(time)
		if not tolua.isnull(obj) then
			textObj:setText(Desc.trialActivity_desc4:format(TimeLib.GetTimeFormatDay(time, 2)))
		end
	end
	local function onEnd(...)
		if not tolua.isnull(obj) then
			textObj:setText(Desc.trialActivity_desc1:format(data.limit ))
			obj:getController("c1"):setSelectedIndex(0)
		end
	end
	if self.timer[index] then
		TimeLib.clearCountDown(self.timer[index])
	end
	self.timer[index] = TimeLib.newCountDown(lastTime, onCountDown, onEnd, false, false, false)
	
end


function TrialActivityAddView:_exit( )
	for k,v in pairs(self.timer) do 
		if v then
			TimeLib.clearCountDown(v)
		end
	end
end

return TrialActivityAddView