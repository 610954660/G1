--Name : PolestarActiveView.lua
--Author : generated by FairyGUI
--Date : 2020-5-29
--Desc : 集星活动

local PolestarActiveView,Super = class("PolestarActiveView", Window)
local ItemCell = require "Game.UI.Global.ItemCell"
function PolestarActiveView:ctor()
	--LuaLog("PolestarActiveView ctor")
	self._packName = "OperatingActivities"
	self._compName = "PolestarActiveView"
	--self._rootDepth = LayerDepth.Window
	self.starInfo={}
end

function PolestarActiveView:_initEvent( )
	
end

function PolestarActiveView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:OperatingActivities.PolestarActiveView
		vmRoot.List_reward = viewNode:getChildAutoType("$List_reward")--list
		vmRoot.txt_star = viewNode:getChildAutoType("$txt_star")--text
	--{vmFieldsEnd}:OperatingActivities.PolestarActiveView
	--Do not modify above code-------------
end

function PolestarActiveView:_initUI( )
	self:_initVM()
	local starAll= OperatingActivitiesModel.polestarActiveInfo.starTotal or 0
	self.txt_star:setText(starAll);
	self.starInfo= OperatingActivitiesModel:getcollectStarconfigInfo(true)
	self.List_reward:setVirtual();
	self.List_reward:setItemRenderer(function(index,obj)
		local starInfo= self.starInfo
		local itemInfo=starInfo[index+1]
		local putongindex=OperatingActivitiesModel:GetBitByIndex(OperatingActivitiesModel.polestarActiveInfo.recvMark,tonumber(itemInfo.id))
		local speciaIndex=OperatingActivitiesModel:GetBitByIndex(OperatingActivitiesModel.polestarActiveInfo.privilegeMark,tonumber(itemInfo.id))
		local starTotal= OperatingActivitiesModel.polestarActiveInfo.starTotal or 0
		local gCtr1=obj:getController("c1");
		local gCtr2=obj:getController("c2");
		local gCtr3=obj:getController("c3");
		if  starTotal<itemInfo.starNum then
			gCtr2:setSelectedIndex(1)
			gCtr1:setSelectedIndex(0)
			gCtr3:setSelectedIndex(0)
		else
			gCtr2:setSelectedIndex(0)
			if putongindex==0 and speciaIndex==0 then
				gCtr1:setSelectedIndex(1)
				gCtr3:setSelectedIndex(0)
			elseif putongindex~=0 and speciaIndex==0 then
				gCtr1:setSelectedIndex(2)
				gCtr3:setSelectedIndex(0)
			elseif putongindex~=0 and speciaIndex~=0 then
				gCtr1:setSelectedIndex(3)
				gCtr3:setSelectedIndex(1)
			end
		end
		local txt_desc=obj:getChildAutoType("txt_desc")
		txt_desc:setText(ColorUtil.formatColorString1(itemInfo.starNum, "#1d2432")..Desc.PolestarActiveView_str111)

		local btn_ordinary=obj:getChildAutoType("list_ordinary")
		local list_specia=obj:getChildAutoType("list_specia")
		btn_ordinary:setItemRenderer(function(index,rewardObj)
			local  reewardItemC=rewardObj:getController("c1") 
			if putongindex~=0 then
				reewardItemC:setSelectedIndex(1)
			else
				reewardItemC:setSelectedIndex(0)
			end
			rewardObj:removeClickListener(100)
			--池子里面原来的事件注销掉
		   local itemMode=rewardObj:getChildAutoType("itemCell")
		   local itemcell = BindManager.bindItemCell(itemMode)
		   local award =itemInfo.itemShow[index + 1]
		   itemcell:setData(award.code, award.amount, award.type)

		end)
		btn_ordinary:setNumItems(#itemInfo.itemShow);

		list_specia:setItemRenderer(function(index,rewardObj)
			local  reewardItemC=rewardObj:getController("c1") 
			if speciaIndex~=0 then
				reewardItemC:setSelectedIndex(1)
			else
				reewardItemC:setSelectedIndex(0)
			end
			rewardObj:removeClickListener(100)
			--池子里面原来的事件注销掉
		   local itemMode=rewardObj:getChildAutoType("itemCell")
		   local itemcell1 = BindManager.bindItemCell(itemMode)
		   local award =itemInfo.privilegeShow[index + 1]
		   itemcell1:setData(award.code, award.amount, award.type)
		end)
		list_specia:setNumItems(#itemInfo.privilegeShow);
		local hasMoeny=false;
		if OperatingActivitiesModel.polestarActiveInfo.topUp~=0 then
			hasMoeny=true
		end
		local btn_ordinary=obj:getChildAutoType("btn_ordinary")
		btn_ordinary:removeClickListener(100)
		btn_ordinary:addClickListener(function(context)
			if starTotal<itemInfo.starNum then
				RollTips.show(Desc.activity_txt8)
			else
				OperatingActivitiesModel:collectStarRecieveReward(itemInfo.id,1)
			end
		
		end,100)

		local btn_specia=obj:getChildAutoType("btn_specia")
		btn_specia:removeClickListener(100)
		btn_specia:addClickListener(function(context)
			if hasMoeny==false and speciaIndex==0 then
				ViewManager.open("PolestarPayInfoView")
			elseif hasMoeny==true and speciaIndex==0 then
				OperatingActivitiesModel:collectStarRecieveReward(itemInfo.id,2)
			end
	end,100)
	end)
self.List_reward:setNumItems(#self.starInfo);--
end


	--事件初始化
function PolestarActiveView:activity_PolestarActiveupdate(...)
	self.starInfo= OperatingActivitiesModel:getcollectStarconfigInfo(true)
	self.List_reward:setNumItems(#self.starInfo);
end



return PolestarActiveView