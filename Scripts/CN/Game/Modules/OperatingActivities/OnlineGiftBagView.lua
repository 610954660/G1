--Name : OnlineGiftBagView.lua
--Author : generated by FairyGUI
--Date : 2020-5-29
--Desc :

local OnlineGiftBagView, Super = class("OnlineGiftBagView", Window)
local ItemConfiger = require "Game.ConfigReaders.ItemConfiger" --道具配置读取器
local ItemCell = require "Game.UI.Global.ItemCell"

function OnlineGiftBagView:ctor()
    --LuaLog("OnlineGiftBagView ctor")
    self._packName = "OperatingActivities"
    self._compName = "OnlineGiftBagView"
    --self._rootDepth = LayerDepth.Window
    self.itemCom = {}
    self.com_model = false
    self._dragMoveAngle = false
    self.skeletonNode = {}
end

function OnlineGiftBagView:_initEvent()
end

function OnlineGiftBagView:_initVM()
    local vmRoot = self
    local viewNode = self.view
    ---Do not modify following code--------
    --{vmFields}:OperatingActivities.OnlineGiftBagView
    --{vmFieldsEnd}:OperatingActivities.OnlineGiftBagView
    --Do not modify above code-------------
end

function OnlineGiftBagView:_initUI()
    self:_initVM()
    local actData = ModelManager.ActivityModel:getActityByType(GameDef.ActivityType.OnlineReward)
    if not actData then
        return
    end
    local bg = string.format( "%s%s","UI/activity/",actData.showContent.activeBg)
    local fullScreen = self.view:getChildAutoType("fullScreen")
    fullScreen:setIcon(bg)
    local serverInfo = OperatingActivitiesModel.onlineGiftBagInfo
    if not serverInfo then
        return
    end
    local activityModule = OperatingActivitiesModel.onlineGiftBagInfo.moduleId or 1
    printTable(16, "Activity_UpdateData13333355", activityModule)
    --Vector2.zero
    if not self.skeletonNode[12] then
        -- self.skeletonNode[12] =
        --     SpineUtil.createSpineObj(
        --     self.view,
        --     cc.p(600, 400),
        --     "xingkong",
        --     "Effect/UI",
        --     "EF_zaixianlibao",
        --     "EF_zaixianlibao",
        --     true
        -- )
        -- self.skeletonNode[12] =
        --     SpineUtil.createSpineObj(
        --     self.view,
        --     cc.p(600, 400),
        --     "ty_ruoyindao",
        --     "Effect/UI",
        --     "EF_ty_ruoyindao",
        --     "EF_ty_ruoyindao",
        --     true
        -- )
    end
    local img_herd = self.view:getChildAutoType("img_herd")
    img_herd:setURL(string.format( "%s%s","UI/activity/","OnlineGiftBagView_renwu.png"))
    local img_yuanpan = self.view:getChildAutoType("img_yuanpan")
    img_yuanpan:setURL(string.format( "%s%s","UI/activity/","OnlineGiftBagView_yuanpan.png"))
    self:initComView(activityModule)
    self:showActiveTime()
    self:showItem(activityModule)
end

function OnlineGiftBagView:initComView(activityModule)
    -- local n26 = self.view:getChildAutoType("img_eff")
    -- if not self.skeletonNode[13] then
    --     self.skeletonNode[13] =
    --         SpineUtil.createSpineObj(
    --         n26,
    --         Vector2.zero,
    --         "zhizhen",
    --         "Effect/UI",
    --         "EF_zaixianlibao",
    --         "EF_zaixianlibao",
    --         true
    --     )
    -- end
    -- local dragArea=comInfo:getChildAutoType('dragArea')
    -- dragArea:setDraggable(true)
    -- dragArea:removeEventListener(FUIEventType.TouchMove, 5330)
    -- dragArea:addEventListener(FUIEventType.DragStart,function(context)
    -- 	-- self._dragMoveAngle = 0
    -- 	-- comInfo:setRotation(0)
    -- end);

    -- local n19=comInfo:getChildAutoType('n19')
    -- dragArea:addEventListener(FUIEventType.TouchMove,function(context)
    -- 	local userdata=dragArea:getPosition().x
    -- 	local userdata1=dragArea:getPosition().y
    -- 	self._dragMoveAngle = OperatingActivitiesModel:getAngle(n19:getPosition().x, n19:getPosition().y, userdata, userdata1)
    -- 	printTable(12,'>>>>>>sdafafasdfasdfads',userdata,userdata1,self._dragMoveAngle)
    -- 	comInfo:setRotation(math.abs(self._dragMoveAngle-200))
    -- end, 5330);

    -- dragArea:addEventListener(FUIEventType.TouchEnd,function(context)
    -- self._moveX = self._moveX + self._dragMoveX
    -- 	self._dragMoveAngle = 0
    -- 	comInfo:setRotation(0)
    -- end);
    local configInfo = DynamicConfigData.t_OnlineGift[activityModule]
    if not configInfo then
        return
    end
    for i = 1, 6, 1 do
        local itemKey = "item_" .. i
        local item = self.view:getChildAutoType(itemKey)
        item:setVisible(true)
        self.itemCom[i] = item
    end
end

function OnlineGiftBagView:showActiveTime()
    self.time = self.view:getChildAutoType("n0")
    local actData = ModelManager.ActivityModel:getActityByType(GameDef.ActivityType.OnlineReward)
    if not actData then
        return
    end
    local actId = actData.id
    local status, Time = ModelManager.ActivityModel:getActStatusAndLastTime(actId)
    printTable(16, ">>>>>>>>>>", Time)
    if not Time then
        return
    end
    if status == 2 and Time == -1 then
        self.time:setText(Desc.activity_txt5)
    else
        local lastTime = Time / 1000
        printTable(12, "??????>>>>>>>>>", lastTime)
        if lastTime == -1 then
            self.time:setText(Desc.activity_txt5)
        else
            if lastTime > 0 then
                self.time:setText(TimeLib.GetTimeFormatDay(lastTime, 2))
                local function onCountDown(time)
                    self.time:setText(TimeLib.GetTimeFormatDay(time, 2))
                end
                local function onEnd(...)
                    self.time:setVisible(false)
                end
                if self.calltimer then
                    TimeLib.clearCountDown(self.calltimer)
                end
                self.calltimer = TimeLib.newCountDown(lastTime, onCountDown, onEnd, false, false, false)
            else
                self.time:setVisible(false)
            end
        end
    end
end

function OnlineGiftBagView:showItem(activityModule)
    local configInfo = DynamicConfigData.t_OnlineGift[activityModule]
    if not configInfo then
        return
    end
    local count = #configInfo
    for i = 1, count, 1 do
        printTable(28, "wwwwwwwwwwww", count)
        local configItem = configInfo[i]
        local comItem = self.itemCom[i]
        --comItem:setTitle(TimeLib.formatTime(configItem.time*60))
        local goodsItem = comItem:getChildAutoType("itemCell")
        goodsItem:removeClickListener(100)
        --池子里面原来的事件注销掉
        local itemcell = BindManager.bindItemCell(goodsItem)
        local award = configItem.reward[1]
        itemcell:setData(award.code, award.amount, award.type)
        itemcell:setFrameVisible(false)
        itemcell:setNoFrame(true)
        itemcell:setAmount(0)
        goodsItem:addClickListener(
            function(...)
                itemcell:onClickCell()
            end,
            100
        )
        local txt_num = comItem:getChildAutoType("txt_num")
        txt_num:setText("X" .. configItem.reward[1].amount)
		local stateInfo =OperatingActivitiesModel:getState(i)
		printTable(151,"111122222222222222222",i,stateInfo)
        local gctr = comItem:getController("c1")
        local gctr2 = comItem:getController("c2")
        if stateInfo == 1 then
            gctr2:setSelectedIndex(1)
        else
            gctr2:setSelectedIndex(0)
		end
		OperatingActivitiesModel:starOnlineCountTime(comItem:getChildAutoType("title"), i, 2)
        local Btn_touch1 = comItem:getChildAutoType("Btn_touch1")
        Btn_touch1:removeClickListener(101)
        Btn_touch1:addClickListener(
            function(...)
                OperatingActivitiesModel:RecieveOnlineReward(i)
            end,
            101
        )
        gctr:setSelectedIndex(stateInfo)
        local touch = comItem:getChildAutoType("Btn_touch")
        local img_ani=comItem:getChildAutoType("img_ani")
        if i == 6 then
            img_ani:setScale(1.3,1.3)
        else
            img_ani:setScale(0.9,0.9) 
        end
        touch:removeClickListener(101)
        if stateInfo == 1 then
            if not self.skeletonNode[i] then
                -- self.skeletonNode[i] =
                --     SpineUtil.createSpineObj(
                --     img_ani,
                --     Vector2.zero,
                --     "yuankuang",
                --     "Effect/UI",
                --     "EF_zaixianlibao",
                --     "EF_zaixianlibao",
                --     true
                -- )
                self.skeletonNode[i] =
                SpineUtil.createSpineObj(
                img_ani,
                Vector2.zero,
                "ty_ruoyindao",
                "Effect/UI",
                "EF_ty_ruoyindao",
                "EF_ty_ruoyindao",
                true
            )
            end
            if  not tolua.isnull(self.skeletonNode[i]) then
                self.skeletonNode[i]:setVisible(true)
                self.skeletonNode[i]:setScale(1)
            end
            touch:addClickListener(
                function(...)
                    OperatingActivitiesModel:RecieveOnlineReward(i)
                end,
                101
            )
        elseif stateInfo == 0 then
            SpineUtil.clearEffect(self.skeletonNode[i])
            touch:addClickListener(
                function(...)
                    RollTips.show(Desc.activity_txt8)
                end,
                101
            )
        elseif stateInfo == 2 then
            SpineUtil.clearEffect(self.skeletonNode[i])
            touch:addClickListener(
                function(...)
                    RollTips.show(Desc.activity_txt9)
                end,
                101
            )
        end
    end
end



function OnlineGiftBagView:activity_update()
    local activityModule = OperatingActivitiesModel.onlineGiftBagInfo.moduleId or 1
    printTable(12, "活动更新", activityModule)
    self:initComView(activityModule)
    self:showActiveTime()
    self:showItem(activityModule)
end

--事件初始化
function OnlineGiftBagView:activity_OnlineGiftActiveupdate(...)
    local activityModule = OperatingActivitiesModel.onlineGiftBagInfo.moduleId or 1
    printTable(12, "活动更新", activityModule)
    self:initComView(activityModule)
    self:showActiveTime()
    self:showItem(activityModule)
end

--事件初始化
function OnlineGiftBagView:activity_OnlineGiftTimeOverupdate(_, infoIdex)
    local activityModule = OperatingActivitiesModel.onlineGiftBagInfo.moduleId or 1
    printTable(28, "时间更新>>>>>>>>>>", activityModule)
    local configInfo = DynamicConfigData.t_OnlineGift[activityModule]
    if not configInfo then
        return
    end
    local comItem = self.itemCom[infoIdex]
	if comItem then
		printTable(151, "时间更新>>>>>>>>>>", infoIdex)
        local gctr = comItem:getController("c1")
        local gctr2 = comItem:getController("c2")
        local img_ani=comItem:getChildAutoType("img_ani")
        gctr2:setSelectedIndex(1)
        gctr:setSelectedIndex(1)
        if not self.skeletonNode[infoIdex] then
            -- self.skeletonNode[infoIdex] =
            --     SpineUtil.createSpineObj(
            --     img_ani,
            --     Vector2.zero,
            --     "yuankuang",
            --     "Effect/UI",
            --     "EF_zaixianlibao",
            --     "EF_zaixianlibao",
            --     true
            -- )

            self.skeletonNode[infoIdex] =
                SpineUtil.createSpineObj(
                img_ani,
                Vector2.zero,
                "ty_ruoyindao",
                "Effect/UI",
                "EF_ty_ruoyindao",
                "EF_ty_ruoyindao",
                true
            )

        end
        if  not tolua.isnull(self.skeletonNode[infoIdex]) then
            self.skeletonNode[infoIdex]:setVisible(true)
            self.skeletonNode[infoIdex]:setScale(1)
        end
    end
end

--事件初始化
function OnlineGiftBagView:_initEvent(...)
    -- self.btn_rank:addClickListener(
    --     function(...)
    --     end
    -- )
end

--initEvent后执行
function OnlineGiftBagView:_enter(...)
    print(1, "OnlineGiftBagView _enter")
end

--页面退出时执行
function OnlineGiftBagView:_exit(...)
    print(1, "OnlineGiftBagView _exit")
    if self.calltimer then
        TimeLib.clearCountDown(self.calltimer)
    end
    SpineUtil.clearEffect(self.skeletonNode)
    self.skeletonNode = {}
    self.itemCom = {}
end

return OnlineGiftBagView
