--Name : RuneCompoundView.lua
--Author : generated by FairyGUI
--Date : 2020-5-21
--Desc : 

local RuneCompoundView,Super = class("RuneCompoundView", View)
local ItemConfiger = require "Game.ConfigReaders.ItemConfiger" --道具配置读取器
local  RuneConfiger = require "Game.Modules.RuneSystem.RuneConfiger"
function RuneCompoundView:ctor()
	--LuaLog("RuneCompoundView ctor")
	self._packName = "RuneSystem"
	self._compName = "RuneCompoundView"
	self.runeCompNodeArr = {}
	self.runeCompDataArr = false
	self.curHcLevel = 0
	self._cost = false
	self.curSelectedIndex = false
	self.spineNode = false
	self.fiveSpineNode1 = false
	self.fiveSpineNode2 = false
	--self._rootDepth = LayerDepth.Window
	
end

function RuneCompoundView:_initEvent( )
	
end

function RuneCompoundView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:RuneSystem.RuneCompoundView
		vmRoot.runeComp1 = viewNode:getChildAutoType("$runeComp1")--Button
		vmRoot.costBar = viewNode:getChildAutoType("$costBar")--
		vmRoot.runeComp3 = viewNode:getChildAutoType("$runeComp3")--Button
		vmRoot.btn_hecheng = viewNode:getChildAutoType("$btn_hecheng")--Button
		vmRoot.btn_add = viewNode:getChildAutoType("$btn_add")--Button
		vmRoot.runeComp5 = viewNode:getChildAutoType("$runeComp5")--Button
		vmRoot.compItem = viewNode:getChildAutoType("$compItem")--Button
		vmRoot.runeComp4 = viewNode:getChildAutoType("$runeComp4")--Button
		vmRoot.runeComp2 = viewNode:getChildAutoType("$runeComp2")--Button
	--{vmFieldsEnd}:RuneSystem.RuneCompoundView
	--Do not modify above code-------------
	self.spineParent = self.view:getChildAutoType("spineParent")
end

function RuneCompoundView:_refresh( ... )
	Dispatcher.dispatchEvent(EventType.rune_changeSmallPage,{status=1,page=0,show=true})
	RuneSystemModel:checkCompoundData(  )
	self:updatePanel()
end

function RuneCompoundView:updatePanel( ... )
	self.runeCompDataArr = ModelManager.RuneSystemModel:getRuneCompDataArr()
    local tempColor = 0
    local tempLevel = 0 
    for i=1,5 do
    	if self.runeCompDataArr and self.runeCompDataArr[i] then
    		tempColor =  RuneConfiger.getRuneColor( self.runeCompDataArr[i]:getItemCode())
    		tempLevel =  RuneConfiger.getRuneLevel( self.runeCompDataArr[i]:getItemCode())
    		self.curHcLevel = tempLevel
    		local url = ItemConfiger.getItemIconByCode(self.runeCompDataArr[i]:getItemCode(), self.runeCompDataArr[i]:getItemType())
		    self["runeComp"..i]:setIcon(url)
		    self["runeComp"..i]:getController("statusCtrl"):setSelectedIndex(1)

    	else
    		self["runeComp"..i]:setIcon(nil)
    		self["runeComp"..i]:getController("statusCtrl"):setSelectedIndex(0)
    	end
    	
		table.insert(self.runeCompNodeArr,i,self["runeComp"..i])
    	self["runeComp"..i]:addClickListener(function( ... )
    		if  self.runeCompDataArr and self.runeCompDataArr[i] then
    			self.runeCompDataArr[i] = nil
    			ModelManager.RuneSystemModel:setRuneCompDataArr(self.runeCompDataArr) 
	   	   	   	self.runeCompNodeArr[i]:setIcon(nil)
	   	   	   	self.runeCompNodeArr[i]:getController("statusCtrl"):setSelectedIndex(0)
	   	   	   	Dispatcher.dispatchEvent("update_smallPage")
		       self.compItem:setIcon(nil)
		       self.compItem:getController("statusCtrl"):setSelectedIndex(1)
		       --消耗显示
			   self:updateCostMoney()
			   self:showFiveRuneComp()
    		else
    			for j=1,5 do
    				self["runeComp"..j]:getController("selectedCtrl"):setSelectedIndex(0)
    			end
    			self["runeComp"..i]:getController("selectedCtrl"):setSelectedIndex(1)
    			self.curSelectedIndex = i
    		end
    	end)
	end
	
	self:updateCostMoney()

	if RuneSystemModel:getRuneCompCount()>=5 then --满5个
		local itemCode =  RuneConfiger.getcurColorItemIdbyNLevel( tempColor,tempLevel )
		local itemInfo = ItemConfiger.getInfoByCode(itemCode)
		local url = ItemConfiger.getItemIconByCode(itemInfo.code, itemInfo.type)
		self.compItem:setIcon(url)
		self.compItem:getController("statusCtrl"):setSelectedIndex(1)
	else
		self.compItem:setIcon(nil)
		self.compItem:getController("statusCtrl"):setSelectedIndex(1)
	end 
	self:showFiveRuneComp()

end

function RuneCompoundView:_initUI( )
	self:_initVM()
	Dispatcher.dispatchEvent(EventType.rune_changeSmallPage,{status=1,page=0,show= true})
	self.costBarItem = BindManager.bindCostItem(self.costBar)
	
    self:updatePanel()
    
    --一键添加
    self.btn_add:addClickListener(function ( ... )
    	local showData = ModelManager.RuneSystemModel:toOneKeyCompRune()
    	if not showData then
    		return
    	else
    		if #showData ==5 then
	    		ModelManager.RuneSystemModel:setRuneCompDataArr(showData)
	    		self.runeCompDataArr = ModelManager.RuneSystemModel:getRuneCompDataArr()
	    		local tempColor = 0
	            local tempLevel = 0 
	    		for i=1,5 do
	    			tempColor =  RuneConfiger.getRuneColor( self.runeCompDataArr[i]:getItemCode())
	    		    tempLevel =  RuneConfiger.getRuneLevel( self.runeCompDataArr[i]:getItemCode())
	    		    self.curHcLevel = tempLevel
			    	local url = ItemConfiger.getItemIconByCode(showData[i]:getItemCode(), showData[i]:getItemType())
					self.runeCompNodeArr[i]:setIcon(url)
					self.runeCompNodeArr[i]:getController("statusCtrl"):setSelectedIndex(1)
				end
				if RuneSystemModel:getRuneCompCount()>=5 then --满5个
			   	    local itemCode =  RuneConfiger.getcurColorItemIdbyNLevel( tempColor,tempLevel )
			   	    local itemInfo = ItemConfiger.getInfoByCode(itemCode)
			   	    local url = ItemConfiger.getItemIconByCode(itemInfo.code, itemInfo.type)
			   	    self.compItem:setIcon(url)
			   	    self.compItem:getController("statusCtrl"):setSelectedIndex(1)
			    else
			       self.compItem:setIcon(nil)
			       self.compItem:getController("statusCtrl"):setSelectedIndex(1)
			    end
			    self:showFiveRuneComp()
                self:updateCostMoney()
			    Dispatcher.dispatchEvent("update_smallPage")
	    	else
	        	RollTips.show(Desc.Rune_txt8)
	    	end
    	end
    end)
    
    --合成
    self.btn_hecheng:addClickListener(function ( ... )
    	local params = {}
    	local itemUuidAttry = {}
    	local tempdata = ModelManager.RuneSystemModel:getRuneCompDataArr()
    	local levelflag = false
    	local colorflag = false
    	local maxLevel = false
    	local level = false
    	local color = false
    	if #tempdata==0 then
    		RollTips.show(Desc.Rune_txt9)
    		return
    	end
    	for k,v in pairs(tempdata) do
    		if not level then
    			level = RuneConfiger.getRuneLevel( v:getItemCode())
    		end
    		if not color then
    			color = RuneConfiger.getRuneColor( v:getItemCode())
    		end
    		if level~= RuneConfiger.getRuneLevel( v:getItemCode()) then
    			levelflag = true
    			break
    		end
    		if color~= RuneConfiger.getRuneColor( v:getItemCode()) then
    			colorflag = true
    			break
    		end
    		table.insert(itemUuidAttry,v:getUuid())
    	end
    	
    	if levelflag then
    		RollTips.show(Desc.Rune_txt10)
    		return 
    	end

    	if colorflag then
    		RollTips.show(Desc.Rune_txt11)
    		return 
    	end

    	if level>=3 then
    		RollTips.show(Desc.Rune_txt12)
    	end

    	if #itemUuidAttry<5 then
    		RollTips.show(Desc.Rune_txt13)
    		return
    	end


    	-- printTable(1,"合成发给服务器的uuid数据=",itemUuidAttry)
    	if not ModelManager.PlayerModel:isCostEnough(self._cost, true) then
    		return
   		end
        local function sendMsg( ... )
			params.itemUuidAttry = itemUuidAttry
			if color>=4 then
				params.targetId =   RuneSystemModel:getComposeByID( tempdata[1]:getItemCode() ) 
			end
			printTable(1,params)
			params.onSuccess = function (res )
			    -- self:showSpine()
			     -- --通过背包刷新
				if tolua.isnull(self.view) then return end
	             self:clearComps()
			end
			RPCReq.Rune_SyntheticRune(params, params.onSuccess)	
        end

        self:showSpine(sendMsg)
    end)
end

--显示特效
function RuneCompoundView:showSpine( callback )
	if not self.spineNode then
		self.spineNode = SpineUtil.createSpineObj(self.spineParent, vertex2(self.spineParent:getWidth()/2,self.spineParent:getHeight()/2), "fw_hecheng", "Spine/ui/rune", "fuwenxitong_texiao", "fuwenxitong_texiao",false)
	else
		self.spineNode:setAnimation(0, "fw_hecheng", false)
	end
	self.spineNode:setCompleteListener(function( name )
        callback()
	end)
end

function RuneCompoundView:clearComps( ... )
   for k,v in pairs(self.runeCompNodeArr) do
      v:setIcon(nil)
      v:getController("statusCtrl"):setSelectedIndex(0)
   end
   self.compItem:setIcon(nil)
   self.compItem:getController("statusCtrl"):setSelectedIndex(1)
   self.runeCompDataArr = {}
   ModelManager.RuneSystemModel:setRuneCompDataArr(self.runeCompDataArr)
   self.curSelectedIndex = false
   self:showFiveRuneComp()
   --播放粒子特效
   -- ParticleUtil.createParticleObj(self.view,{x=0,y=0},"particle_texture")
end

--背包设置合成符文
function RuneCompoundView:set_runeHechengEvent( _,params )
	print(1,"set_runeHechengEvent")
	if params.itemData then
	   local itemData = params.itemData
	   local level = RuneConfiger.getRuneLevel( itemData:getItemCode())
	   local color  = RuneConfiger.getRuneColor( itemData:getItemCode())
       self.curHcLevel = level
	 
	   if params.type == 1 then --装
		   	if self.curSelectedIndex then
		   	  if not self.runeCompDataArr[self.curSelectedIndex] then
		   	  	  self.runeCompDataArr[self.curSelectedIndex] = {}
		   	  	  self.runeCompDataArr[self.curSelectedIndex] = itemData
		   	  	  local url = ItemConfiger.getItemIconByCode(itemData:getItemCode(), itemData:getItemType())
		   	      self.runeCompNodeArr[self.curSelectedIndex]:setIcon(url)
		   	      self.runeCompNodeArr[self.curSelectedIndex]:getController("statusCtrl"):setSelectedIndex(1)
		   	  else
		   	  	  print(1,"选中装备的位置上已经有符文 自动寻找下一个符合的格子")
		   	  	  for it=1,5 do
		   	  	  	 if not self.runeCompDataArr[it] then
		   	  	  	 	self.curSelectedIndex = it
		   	  	  	 	break
		   	  	  	 end
		   	  	  end
		   	  	  if self.curSelectedIndex>5 then
		   	  	  	 RollTips.show(Desc.Rune_txt14)
		   	  	  	 return
		   	  	  end
		   	  	  for j=1,5 do
    				self["runeComp"..j]:getController("selectedCtrl"):setSelectedIndex(0)
    			  end
    			  self.runeCompDataArr[self.curSelectedIndex] = {}
		   	  	  self.runeCompDataArr[self.curSelectedIndex] = itemData
		   	  	  local url = ItemConfiger.getItemIconByCode(itemData:getItemCode(), itemData:getItemType())
		   	      self.runeCompNodeArr[self.curSelectedIndex]:setIcon(url)
		   	      self.runeCompNodeArr[self.curSelectedIndex]:getController("statusCtrl"):setSelectedIndex(1)
		   	  end
		    else --没有选中的情况 按照顺序默认
		    	for i=1,5 do
		    		if not self.runeCompDataArr[i] then
		    			self.runeCompDataArr[i] = {}
		    			self.runeCompDataArr[i] = itemData
				   	  	local url = ItemConfiger.getItemIconByCode(itemData:getItemCode(), itemData:getItemType())
				   	    self.runeCompNodeArr[i]:setIcon(url)
				   	    self.runeCompNodeArr[i]:getController("statusCtrl"):setSelectedIndex(1)
				   	    break
		    		end
		    	end
		    end
	   elseif params.type == 0 then --卸
	   	   local itemData = params.itemData
	   	   for k,v in pairs(self.runeCompDataArr) do
	   	   	   if v:getUuid() == itemData:getUuid() then --找到对应的位置 取消
	   	   	   	   self.runeCompDataArr[k] = nil
	   	   	   	   self.runeCompNodeArr[k]:setIcon(nil)
	   	   	   	   self.runeCompNodeArr[k]:getController("statusCtrl"):setSelectedIndex(0)
	   	   	   	   break
	   	   	   end
	   	   end
	   end
	   ModelManager.RuneSystemModel:setRuneCompDataArr(self.runeCompDataArr)
	   if RuneSystemModel:getRuneCompCount()>=5 then --满5个
	   	    local itemCode =  RuneConfiger.getcurColorItemIdbyNLevel( color,level )
	   	    local itemInfo = ItemConfiger.getInfoByCode(itemCode)
	   	    local url = ItemConfiger.getItemIconByCode(itemInfo.code, itemInfo.type)
	   	    self.compItem:setIcon(url)
	   	    self.compItem:getController("statusCtrl"):setSelectedIndex(1)
	   else
           self.compItem:setIcon(nil)
           self.compItem:getController("statusCtrl"):setSelectedIndex(1)
	   end 
	   self:showFiveRuneComp()
	   self:updateCostMoney()
	end
end

--满五个
function RuneCompoundView:showFiveRuneComp(  )
	if RuneSystemModel:getRuneCompCount()>=5 then --满5个
		if not self.fiveSpineNode1 then
		    self.fiveSpineNode1 = SpineUtil.createSpineObj(self.spineParent, vertex2(self.spineParent:getWidth()/2,self.spineParent:getHeight()/2), "fw_liuguang", "Spine/ui/rune", "fuwenxitong_texiao", "fuwenxitong_texiao",true)
	    else
			self.fiveSpineNode1:setVisible(true)
		end

		if not self.fiveSpineNode2 then
		    self.fiveSpineNode2 = SpineUtil.createSpineObj(self.spineParent, vertex2(self.spineParent:getWidth()/2,self.spineParent:getHeight()/2), "fw_shan", "Spine/ui/rune", "fuwenxitong_texiao", "fuwenxitong_texiao",true)
	    else
			self.fiveSpineNode2:setVisible(true)
		end

	else
		if self.fiveSpineNode1 then
			self.fiveSpineNode1:setVisible(false)
		end
		if self.fiveSpineNode2 then
			self.fiveSpineNode2:setVisible(false)
		end
	end
end

function RuneCompoundView:updateCostMoney( ... )
	 --消耗显示
	   if RuneSystemModel:getRuneCompCount()>=1 and self.curHcLevel then
			local config = RuneConfiger.getRunCompositeConfig( self.curHcLevel )
			self._cost = config.cost
	   else
	   	    self._cost = {{type=2,code=1,amount=0,},}
	   end
	   self.costBarItem:setData(self._cost[1].type, self._cost[1].code, self._cost[1].amount, true,false,false)
end

return RuneCompoundView