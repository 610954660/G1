--Name : MazeView.lua
--Author : generated by FairyGUI
--Date : 2020-4-13
--Desc : 迷宫界面 xhd

local MazeView,Super = class("MazeView", Window)
local rowConfig = {1,2,3,2,3,2,3,2,3,2,1,1}
local MazeConfiger  = require "Game.ConfigReaders.MazeConfiger"
function MazeView:ctor()
	--LuaLog("MazeView ctor")
	self._packName = "Maze"
	self._compName = "MazeView"
	--self._rootDepth = LayerDepth.Window
	self.geziArr = {}
	self.curFloor = 1
	self.curgeziId = 0
	self.curGeziObj = false
	self.data = {}
	self.lastTime = false
	self.roundTime = false
	self.calltimer = false
	self.recordBoard = false
	-- self.firstOpen = true
	self.skeletonNode = false;
	self.skeletonNodeArr = {}
	self.skeletonBx = false
	self.timer = false
	RedManager.updateValue("M_MAZE", false)
	self.scheduleId = false
	self.loseGeziObj = false
end

function MazeView:_initEvent( )
	self.btn1:addClickListener(function( ... )
    	ViewManager.open("GoddessTearsView")
    end)
    self.btn2:addClickListener(function( ... )
    	-- body
    	ViewManager.open("HeroListView")
    end)
    self.btn3:addClickListener(function( ... )
    	-- body
    	ViewManager.open("GodResView")
    	-- ViewManager.open("GodResGetView")
    	
    end)
    self.btn4:addClickListener(function( ... )
    	-- body
		-- ViewManager.open("GodResView")
		-- ViewManager.open("ShopView",{shopType = 7})
		ModuleUtil.openModule( ModuleId.Shop.id , true,{shopType = 7} )
    end)
    self.helpBtn:addClickListener(function( ... )
        local info = {}
        info['title']=Desc.help_StrTitle22
        info['desc'] = Desc.help_StrDesc22
    	ViewManager.open("GetPublicHelpView",info) 
    end)

	local params = {}
	params.onSuccess = function (res )
	    -- printTable(1,"Maze_GetLayerAllHeroMirror",res)
	    MazeModel:setLayerMirrorData(res.mirrorHero)
	    --4轮后有镜像数据
        local params = {}
		params.onSuccess = function (res )
		    if res.ret==0 then
		    	print(1,"请求格子信息成功")
		    end
		end
		RPCReq.Maze_Info(params, params.onSuccess)
	end
	RPCReq.Maze_GetLayerAllHeroMirror(params, params.onSuccess)

end

function MazeView:_initVM( )
	local vmRoot = self
	local viewNode = self.view
	---Do not modify following code--------
	--{vmFields}:Maze.MazeView
		vmRoot.btn2 = viewNode:getChildAutoType("$btn2")--Button
		vmRoot.title = viewNode:getChildAutoType("$title")--text
		vmRoot.btn4 = viewNode:getChildAutoType("$btn4")--Button
		vmRoot.checkComp = viewNode:getChildAutoType("$checkComp")--
		vmRoot.btn3 = viewNode:getChildAutoType("$btn3")--Button
		vmRoot.btn1 = viewNode:getChildAutoType("$btn1")--Button
		vmRoot.time = viewNode:getChildAutoType("$time")--text
		vmRoot.helpBtn = viewNode:getChildAutoType("$helpBtn")--Button
		vmRoot.costItem_gold = viewNode:getChildAutoType("costItem_gold")--
		vmRoot.costItem_diamond = viewNode:getChildAutoType("costItem_diamond");--
		vmRoot.recordBoard = viewNode:getChildAutoType("recordBoard");
	--{vmFieldsEnd}:Maze.MazeView
	--Do not modify above code-------------
	self.recordBoard  = BindManager.bindRewardRecordBoard(vmRoot.recordBoard)
	self:setBg("maze_bg.jpg");
end

function MazeView:_initUI( )
	self:_initVM()
	self.sTypeCtrl = self.view:getController("sTypeCtrl")
    --self.n67 = self.view:getChildAutoType("n67")
   -- self.n67:setSize(display.width, display.height)
    --self.n67:setPosition(-(display.width - self.view:getWidth())/2, 0)
    self.checkComp:setWidth(display.width)
    self.checkComp:setX(-(display.width - self.view:getWidth())/2);
end

function MazeView:_exit( ... )
    print(1,"MazeView:_exit")
	TimeLib.clearCountDown(self.calltimer)
	Scheduler.unschedule(self.timer)
	Scheduler.unschedule(self.scheduleId) 
end

function MazeView:openMonterTipsView(data,config )
	-- printTable(1,data)
	-- printTable(1,config)
    if data.gebuli and data.gebuli>0 then
		if config.id == data.gebuli then
			config.monstersquad = MazeConfiger.getGebuliId()
		end
	end
	ViewManager.open("MonsterTipView",{config =config})
end
function MazeView:maze_update_MazeView(  )
	print(1,"maze_update_MazeView")
	local data = ModelManager.MazeModel:getData()
	self.curgeziId = data.Grid
	self.curFloor = tonumber(string.sub(self.curgeziId,1,1))
	
	if self.skeletonBx then
		self.skeletonBx:removeFromParent()
		self.skeletonBx = false
	end

	--文本更新
	if self.curFloor>=3 then
    	if self.curFloor == 3 then
    		self.title:setText(string.format(Desc.maze_level_title, 3));
    		self.sTypeCtrl:setSelectedIndex(0)
    	else
    		self.title:setText(string.format(Desc.maze_level_title, 4))
    		self.sTypeCtrl:setSelectedIndex(1)
    	end
    else
    	self.title:setText(string.format(Desc.maze_level_title, self.curFloor));
        self.sTypeCtrl:setSelectedIndex(0)
	end
    local showStrl = ""
    self.roundTime = data.roundTime/1000
    if self.roundTime>=24*3600 then
    	showStrl = TimeLib.GetTimeFormatDay(self.roundTime,1)
    else
    	showStrl = TimeLib.getTimeFormatOneDay(self.roundTime)
    end
	self.time:setText(showStrl)

    TimeLib.clearCountDown(self.calltimer)

    local function onCountDown( time )
	    if time>=24*3600 then
	    	showStrl = TimeLib.GetTimeFormatDay(time,1)
	    else
	    	showStrl = TimeLib.getTimeFormatOneDay(time)
	    end
	    self.time:setText(showStrl)
    end

    local function onEnd( ... )
    	self.time:setText(Desc.Maze_Text10)
    end
    self.calltimer = TimeLib.newCountDown(self.roundTime, onCountDown, onEnd, false, false,false)

    --服务器数据回来才能让点击
    --确定格子 确定数据
	local index  =0 
    for i=1,#rowConfig do
    	local row = rowConfig[i]
    	for j=1,row do
    		index = index+1
    		self.geziArr[index] = {}
    		local config = MazeConfiger.getConfig(self.curFloor,i,j)
            self.geziArr[index].view = self.checkComp:getChildAutoType("check"..i..j.."")
            self.geziArr[index].view:setVisible(true)
            self.geziArr[index].view:getController("glayCtrl"):setSelectedIndex(1)
            -- if not __IS_RELEASE__ then
            --     local tempText = self.geziArr[index].view:getChildAutoType("tempText")
            --     tempText:setText(config.id)
            -- end
            self.geziArr[index].config = config
            self.geziArr[index].view:removeClickListener(11)
            self.geziArr[index].view:addClickListener(function ()
            	local config = MazeConfiger.getConfig(self.curFloor,i,j)
            	print(1,"第几个格子点击",self.curFloor,index,i,j,config.mazetype)
            	if config.mazetype == 1 then
            		ViewManager.open("HotSpringTipView",{type=1,config=config})
            	elseif  config.mazetype == 2 then

            		ViewManager.open("HotSpringTipView",{type=2,config =config})
				elseif  config.mazetype == 3 then
					printTable(2233, config);
            		ViewManager.open("ShopTipView",{config =config, gridId = self.curgeziId})
            	elseif  config.mazetype == 4 then
            		ViewManager.open("HireTipView",{config =config})
            	elseif  config.mazetype == 5 then
            		self:openMonterTipsView(data,config)
            	elseif  config.mazetype == 6 then
            		self:openMonterTipsView(data,config)
            	elseif  config.mazetype == 7 then
            		self:openMonterTipsView(data,config)
            	elseif  config.mazetype == 8 then
            		self:openMonterTipsView(data,config)
            	elseif  config.mazetype == 9 then
            	elseif  config.mazetype == 10 then
            		-- printTable(2233,"领取宝箱",config)
                    local params = {}
					params.grid = config.id
					--printTable(1,params)
					params.onSuccess = function (res )
					    --printTable(1,res)
					    if res.ret==0 then
					    	print(1,"宝箱领取完成")
                            if config.mazeend == 2 then
                               RollTips.show(Desc.Maze_Text11)
                            end
							if tolua.isnull(self.view) then return end
					    	self.geziArr[index].view:setVisible(false)
					    end
					end
					RPCReq.Maze_ReceiveBox(params, params.onSuccess)
            	end
            end,11)
            if config.id == self.curgeziId then
            	print(1,"找到当前格子")
            	-- printTable(1,self.geziArr[index].config)
            	self.curGeziObj = self.geziArr[index]
            	ModelManager.MazeModel:setNextGrid(self.curGeziObj.config.next)
            end
    	end
    end
    
    --整个迷宫滑动
	if #data.afterGrid<=0 then
    	self.checkComp:getScrollPane():setPosX(0)
	else
		local curX = self.curGeziObj.view:getX() - display.cx + 150;
		local scrollNodeX = self.checkComp:getScrollPane():getPosX();
		local offset = (curX - scrollNodeX);
		-- print(2233, "当前节点位置", curX, "偏移量", offset, "当前位置", scrollNodeX);
		self.checkComp:getScrollPane():setScrollStep(1)
		self.checkComp:getScrollPane():scrollRight(offset)
    	-- --每次打开界面停留在玩家所在格子
    	-- if self.firstOpen then
    	-- 	-- self.checkComp:getScrollPane():setPercX(self.curGeziObj.config.mazeline/12,true)
	    -- 	self.checkComp:getScrollPane():setScrollStep(189)
		-- 	self.checkComp:getScrollPane():scrollRight(self.curGeziObj.config.mazeline-2)
		-- else
	    -- 	self.checkComp:getScrollPane():setScrollStep(70)
		-- 	self.checkComp:getScrollPane():scrollRight(self.curGeziObj.config.mazeline-1)
    	-- end
    end
    -- self.firstOpen = false


	local curGridX = 0;
	local squadVal = MazeConfiger.getSquadShow()
	local hardLevelVal = MazeConfiger.getHardLevelShow()
	print(1,"第几轮",data.roundNumber+1)
    --更新格子情况更新
	for i,v in ipairs(self.geziArr) do
		--printTable(1,v)
    	if self.skeletonNodeArr[i] then
			self.skeletonNodeArr[i]:removeFromParent()
			self.skeletonNodeArr[i] = nil
		end

		--根据类型显示对应格子模型 模型类型控制器
		local typeCtrl = v.view:getController("typeCtrl")
		if typeCtrl then
			if v.config.mazetype<=9 then
				typeCtrl:setSelectedIndex(v.config.mazetype)
			end
		end

		--当前格子
		if v.config.id == self.curgeziId then
			v.view:getController("curCtrl"):setSelectedIndex(1)
			-- local heroId = PlayerModel.sex == 1 and 44005 or 44004;
			local heroId = ModelManager.HandbookModel.heroOpertion --改用看板娘
			local fashionId = ModelManager.HandbookModel.fashionCode --改用看板娘
			if self.skeletonNode then
				self.skeletonNode:removeFromParent()
			end
			local skeletonNode=SpineMnange.createSprineById(heroId, true,nil,nil, fashionId)
			if skeletonNode==false  then
				return 
			end
			 
			 skeletonNode:setAnimation(0, "stand", true);
			 v.view:getChildAutoType("heroIcon"):displayObject():addChild(skeletonNode)
			 self.skeletonNode=skeletonNode
		else
			v.view:getController("curCtrl"):setSelectedIndex(0)
		end
        
        --下两个可选择格子
        -- local flag = ModelManager.MazeModel:checkExsitNext(v.config.id)
		-- if flag then --下一行可走位置
		-- 	v.view:getController("nextGgCtrl"):setSelectedIndex(1)
		-- else
		-- 	v.view:getController("nextGgCtrl"):setSelectedIndex(0)
		-- end

		-- 格子间箭头控制
		local next = v.config.next;
		local ctrl1 = v.view:getController("topLineState");
		local ctrl2 = v.view:getController("bottomLineState");
		if (#next == 1) then
			if (TableUtil.Exist(data.afterGrid,v.config.id) or v.config.id == self.curgeziId ) then -- v.config.id == self.curgeziId or 
				ctrl1:setSelectedIndex(1);
				ctrl2:setSelectedIndex(1);
			else 
				ctrl1:setSelectedIndex(0);
				ctrl2:setSelectedIndex(0);
			end
		elseif (#next == 2) then
			-- 下一格走过 or 下一格是当前格  and  这一格走过
			if (v.config.id == self.curgeziId or (TableUtil.Exist(data.afterGrid, next[1]) or next[1] == self.curgeziId) and TableUtil.Exist(data.afterGrid,v.config.id)) then
				if data.monsterId and data.monsterId~=0 and data.successful<=0 and v.config.id == self.curgeziId  then --打魔王失败的情况下
					if data.monsterId ~= next[1] then
						ctrl1:setSelectedIndex(0);
					else
						ctrl1:setSelectedIndex(1);
					end
				else
					ctrl1:setSelectedIndex(1);
				end
			else
				ctrl1:setSelectedIndex(0);
			end

			if (v.config.id == self.curgeziId or (TableUtil.Exist(data.afterGrid, next[2]) or next[2] == self.curgeziId) and TableUtil.Exist(data.afterGrid,v.config.id)) then
				if data.monsterId and data.monsterId~=0 and data.successful<=0 and v.config.id == self.curgeziId  then --打魔王失败的情况下
					if data.monsterId ~= next[2] then
						ctrl2:setSelectedIndex(0);
					else
						ctrl2:setSelectedIndex(1);
					end
				else
					ctrl2:setSelectedIndex(1);
				end
			else
				ctrl2:setSelectedIndex(0);
			end
		end

		-- --显示和隐藏
		-- --显示 1.当前 2.走过 3.还没到的 
		-- if v.config.id == self.curgeziId or TableUtil.Exist(data.afterGrid,v.config.id) or v.config.mazeline>self.curGeziObj.config.mazeline then
		-- 	v.view:setVisible(true)
		-- else
		-- 	v.view:setVisible(false)
		-- end

        --是否是宝箱 控制器
		local baoxiangCtrl = v.view:getController("baoxiangCtrl")
        if baoxiangCtrl then
			if v.config.mazetype == 10 then
                if data.successful == 2 and v.config.id == self.curgeziId then
					v.view:setVisible(false)
				else
					v.view:setVisible(true)
                end
				baoxiangCtrl:setSelectedIndex(1)
				if not self.skeletonBx then
					local parent = v.view:getChildAutoType("n49")
					local posx = parent:getWidth()/2
					local posy = parent:getHeight()/2
					self.skeletonBx = SpineUtil.createSpineObj(parent, vertex2(posx,posy), "baoxiang_meizhou", "Effect/UI", "Ef_yuanzheng_baoxiang", "Ef_yuanzheng_baoxiang",true)
				end
            else
                baoxiangCtrl:setSelectedIndex(0)
            end
        end

		--灰化处理
		local flag = ModelManager.MazeModel:checkExsitNext(v.config.id)
		--亮起的情况 1.走过的 2.当前的 3.下个可走的
		if TableUtil.Exist(data.afterGrid,v.config.id) or v.config.id == self.curgeziId then
			v.view:getController("glayCtrl"):setSelectedIndex(2)
		elseif flag then
			v.view:getController("glayCtrl"):setSelectedIndex(0)
		else
			v.view:getController("glayCtrl"):setSelectedIndex(1)
		end
        
        --可以点击  1.还没到 2.类型不是魔王并且还没到 5,6,7,8 3.是魔王类型并且当前格子在下面两行
        --格子上方显示  1.走过的不显示任何东西 2.当前 3.还没走过 但是类型是魔王5,6,7,8
		if v.config.mazeline>self.curGeziObj.config.mazeline  then
        	if not (v.config.mazetype>=5 and v.config.mazetype<=8) then
        		v.view:setTouchable(true)
				v.view:getController("showCtrl"):setSelectedIndex(1)
			else
        		v.view:setTouchable(false)
        		v.view:getController("showCtrl"):setSelectedIndex(0)
        		v.view:getController("fightValCtrl"):setSelectedIndex(0)
        		local temp = self.curGeziObj.config.mazeline+2
        	    if v.config.mazeline<=temp then
        	    	v.view:setTouchable(true)
					v.view:getController("showCtrl"):setSelectedIndex(1)

					--脚底怪物宝箱
					-- if v.config.mazetype == 5 and  v.config.id ~= self.curgeziId and v.config.mazeline~=self.curGeziObj.config.mazeline then
					-- 	v.view:getController("bxType"):setSelectedIndex(1)
					-- elseif v.config.mazetype == 6 and v.config.id ~= self.curgeziId and v.config.mazeline~=self.curGeziObj.config.mazeline then
					-- 	v.view:getController("bxType"):setSelectedIndex(2)
					-- else
					-- 	v.view:getController("bxType"):setSelectedIndex(0)
					-- end

        	    	local fightVal = MazeModel:getFightValById( v.config.id, data.roundNumber>=squadVal - 1)
					v.view:getController("fightValCtrl"):setSelectedIndex(1)
					print(1,"服务器获得后计算=",fightVal)
        	    	if fightVal>0 then --有服务器数据
        	    		--备注  战力再次要求变动  保留原有逻辑做特殊处理 xhd
						if data.roundNumber>=squadVal - 1 then --第四轮后 获取玩家战力*npc配置比例 不在是服务器真实战力
							-- print(1,"ModelManager.CardLibModel:getFightVal()",ModelManager.CardLibModel:getFightVal())
							-- print(1,"v.config.npc",v.config.npc)
							-- print(1,"v.config.id",v.config.id)
							if fightVal == 1 then
								fightVal =  ModelManager.CardLibModel:getFightVal()*v.config.npc
							end 					
							print(1,"fightVal  fightVal",fightVal)
						end
						v.view:getChildAutoType("fightVal"):setText(StringUtil.transValue(fightVal))
					else
        	    		--通过配置获取
						local fightVal = MazeConfiger.getMonsterFightValBysquad( v.config.monstersquad  )
						print(1,"根据配置计算战力",fightVal)
        	    		if fightVal then
        	    			v.view:getChildAutoType("fightVal"):setText(StringUtil.transValue(fightVal))
        	    		else
        	    			v.view:getController("fightValCtrl"):setSelectedIndex(0)
        	    		end
        	    	end
        	    	if data.roundNumber>=squadVal - 1 then --第四轮
        	    		local monsterId = MazeModel:getMonsterIDById( v.config.id )
        	    		if monsterId >0 then
							local skeletonNode=SpineMnange.createSprineById(monsterId,false)
							if skeletonNode then
								v.view:getChildAutoType("icon"):setURL("")
								v.view:getChildAutoType("icon"):displayObject():addChild(skeletonNode,0,100)
								skeletonNode:setAnimation(0, "stand", true);
								skeletonNode:setPosition(50,25)
								skeletonNode:setScaleX(-1)
								self.skeletonNodeArr[i] = skeletonNode
							end
	        	    	end
        	    	else --前三轮
        	    		if v.config.monstersquad >0 then
	        	    		local monsterInfo = MazeConfiger.getMonsterIdBysquad( v.config.monstersquad )
							local skeletonNode=SpineMnange.createSprineById(monsterInfo.monsterId,false)
							if skeletonNode then
								v.view:getChildAutoType("icon"):setURL("")
								v.view:getChildAutoType("icon"):displayObject():addChild(skeletonNode,0,100)
								skeletonNode:setAnimation(0, "stand", true);
								skeletonNode:setPosition(50,25)
								skeletonNode:setScaleX(-1)
								self.skeletonNodeArr[i] = skeletonNode

							end
	        	    	end
        	    	end
        	    end
        	end
        else
        	v.view:setTouchable(false)
        	v.view:getController("showCtrl"):setSelectedIndex(0)
        	v.view:getController("fightValCtrl"):setSelectedIndex(0)
        end

        --打魔王没打过 特殊情况
        if data.monsterId and data.monsterId~=0 then
	        -- if v.config.mazetype>=5 and v.config.mazetype<=8 then
	            if data.successful<=0  then --未通过
					local tempConfig = MazeConfiger.getConfigByMazeId(data.monsterId)
					if v.config.mazeline == tempConfig.mazeline and v.config.id~=data.monsterId then
						v.view:getController("glayCtrl"):setSelectedIndex(1)
						v.view:getController("showCtrl"):setSelectedIndex(0)
						v.view:getController("nextGgCtrl"):setSelectedIndex(0)
						v.view:getController("fightValCtrl"):setSelectedIndex(0)
						v.view:setTouchable(false)
					elseif v.config.mazeline == tempConfig.mazeline and v.config.id==data.monsterId then
						--战败才需要 并且是唯一的
						self.loseGeziObj = v
						-- local tempText = self.loseGeziObj.view:getChildAutoType("tempText")
						-- tempText:setText("失败的格子")
					end
				end
	        -- end
        end

	end
	

	--传送门控制
    local chuansong1 = self.checkComp:getChildAutoType("chuansong1")
    local chuansong2 = self.checkComp:getChildAutoType("chuansong2")
	local chuansong3 = self.checkComp:getChildAutoType("chuansong3")
	chuansong1:getChildAutoType("spineNode"):displayObject():removeAllChildren()
	chuansong2:getChildAutoType("spineNode"):displayObject():removeAllChildren()
	chuansong3:getChildAutoType("spineNode"):displayObject():removeAllChildren()
	-- LuaLogE(self.curGeziObj.config.mazetype)
	if self.curGeziObj.config.mazetype==10 then
		local spine =  SpineUtil.createSpineObj(chuansong1:getChildAutoType("spineNode"), vertex2(0,0), "animation", "Spine/ui/pveStarTemple", "xingchenshengsuo_texiao", "xingchenshengsuo_texiao",true)
		local spine =  SpineUtil.createSpineObj(chuansong2:getChildAutoType("spineNode"), vertex2(0,0), "animation", "Spine/ui/pveStarTemple", "xingchenshengsuo_texiao", "xingchenshengsuo_texiao",true)
		local spine =  SpineUtil.createSpineObj(chuansong3:getChildAutoType("spineNode"), vertex2(0,0), "animation", "Spine/ui/pveStarTemple", "xingchenshengsuo_texiao", "xingchenshengsuo_texiao",true)
    	if #self.curGeziObj.config.next>=2 and data.roundNumber>=hardLevelVal - 1 then
           chuansong1:setVisible(true)
           chuansong2:setVisible(true)
		   chuansong3:setVisible(false)

           chuansong1:removeClickListener(100)
		   chuansong1:addClickListener(function( ... )
				local info = {};
				info.onYes = function ()
					local params = {}
					params.id = self.curGeziObj.config.next[2]
					params.onSuccess = function (res )
					print(1,"传送成功")
					end
					RPCReq.Maze_MoveInfo(params, params.onSuccess)
				end
				info.text = Desc.maze_choseDiff;
				info.type = "yes_no";
                Alert.show(info);
           end,100)
           chuansong2:removeClickListener(100)
		   chuansong2:addClickListener(function( ... )
				local info = {};
				info.onYes = function ()
					local params = {}
					params.id = self.curGeziObj.config.next[1]
					params.onSuccess = function (res )
					print(1,"传送成功")
					end
					RPCReq.Maze_MoveInfo(params, params.onSuccess)
				end
				info.text = Desc.maze_choseSimple;
				info.type = "yes_no";
                Alert.show(info);
           end,100)
        elseif #self.curGeziObj.config.next<=0 then
           chuansong1:setVisible(false)
           chuansong2:setVisible(false)
           chuansong3:setVisible(false)
    	else
           chuansong1:setVisible(false)
           chuansong2:setVisible(false)
           chuansong3:setVisible(true)
           chuansong3:removeClickListener(100)
           chuansong3:addClickListener(function( ... )
                local params = {}
				params.id = self.curGeziObj.config.next[1]
				params.onSuccess = function (res )
				   print(1,"传送成功")
				end
				RPCReq.Maze_MoveInfo(params, params.onSuccess)
           end,100)
    	end
    else
    	chuansong1:setVisible(false)
        chuansong2:setVisible(false)
        chuansong3:setVisible(false)
	end
	
	local lastGezi = false
	if self.curFloor>2  then
		local next =  self.curGeziObj.config.next
		if #next==1 then
			local nextConfig  = MazeConfiger.getConfigByMazeId(next[1])
			if #nextConfig.next<=0 then
				lastGezi = true
			end
		end
	end

	if not lastGezi then --最后的格子忽略遗物领取
		--如果遗物还没有领取
		if not ModelManager.MazeModel:getFightFlag() then
			if self.curGeziObj.config.mazetype>=5 and self.curGeziObj.config.mazetype<=8 and data.successful == 1 then
				local params = {}
				params.onSuccess = function (res )
					if res.Relics  and #res.Relics>0 then
						ViewManager.open("GodResGetView",{config =self.curGeziObj.config })
					end
				end
				RPCReq.Maze_RelicsInfo(params, params.onSuccess)
			end
		end
	end
	self:upRecordBoard()
end

function MazeView:reward_close_event()
	print(1,"module_open_hint")
	local lastGezi = false
	if self.curFloor>2  then
		local next =  self.curGeziObj.config.next
		if #next==1 then
			local nextConfig  = MazeConfiger.getConfigByMazeId(next[1])
			if #nextConfig.next<=0 then
				lastGezi = true
			end
		end
	end
	if lastGezi then
		self:showSuccessComp()
	end
end

function MazeView:showSuccessComp()
	local successCtrl= self.view:getController("successCtrl")
	successCtrl:setSelectedIndex(1)
	self.scheduleId = Scheduler.scheduleOnce(2,function()
		if not tolua.isnull(self.view) then
			successCtrl:setSelectedIndex(0)
		end
	 end)
end

-- 更新奖励板
function MazeView:upRecordBoard()
	local data = ModelManager.MazeModel:getData()
	-- printTable(1,data)
	-- -- 过关的奖励格子
	-- local passedGrid = {};
	-- table.insert(passedGrid, data.Grid);
	-- for _, id in ipairs(data.afterGrid) do
	-- 	table.insert(passedGrid, id);
	-- end
	-- local allConf = TableUtil.DeepCopy(DynamicConfigData.t_maze);
	-- local awardList = {};
	-- local awardMap = {};
	-- for _, id in ipairs(passedGrid) do
	-- 	local conf = allConf[id].mazereward1;
	-- 	if (allConf[id].mazetype == 10) then
	-- 		conf = DynamicConfigData.t_Mazeconst["MazeBoxReward"].MazeTheBox
	-- 	end
	-- 	for _, award in ipairs(conf) do
	-- 		if not awardMap[award.code] then
	-- 			awardMap[award.code] = award;
	-- 		else
 --                awardMap[award.code].amount = awardMap[award.code].amount + award.amount				
	-- 		end
	-- 	end
	-- end
	-- awardList = {}
	-- for k,v in pairs(awardMap) do
	-- 	table.insert(awardList, v)
	-- end
	-- awardMap = {}
	--修改奖励通过服务器下发
    if not data.roundReward then
    	self.recordBoard:setData({})
    else
    	self.recordBoard:setData(data.roundReward)
    end
	
end

--如果失败 战力前端又自己算一下并且刷新
function MazeView:fight_lose_event(_,params)
    if tolua.isnull(self.view) then  return  end
	local requseInfo={
		fightId	= params.fightID,
		index	= params.index,
		gamePlay= params.configType
	}
	local function success1(data)
		if tolua.isnull(self.view) then
			return
		end
		self:updateCurGeziFight(data.combat)
	end
	RPCReq.Battle_GetOpponentBattleArray(requseInfo,success1)
end

function MazeView:updateCurGeziFight(fightVal)
	print(1,"1111111111111111111",fightVal)
	print(1,"1111111111111111111",fightVal)
	
	-- local tempText = self.loseGeziObj.view:getChildAutoType("tempText")
	-- tempText:setText("失败的格子")
	self.loseGeziObj.view:getChildAutoType("fightVal"):setText(StringUtil.transValue(fightVal))
end

return MazeView